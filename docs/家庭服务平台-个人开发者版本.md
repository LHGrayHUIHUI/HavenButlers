# å®¶åº­æœåŠ¡å¹³å° - ä¸ªäººå¼€å‘è€…ç‰ˆæœ¬

## ğŸ¯ ä¸€ã€è®¾è®¡ç†å¿µ

### 1.1 æ ¸å¿ƒåŸåˆ™
- **ä¸€äººå¼€å‘**ï¼šæ‰€æœ‰æœåŠ¡è®¾è®¡éƒ½è€ƒè™‘å•äººç»´æŠ¤çš„å¯è¡Œæ€§
- **æ¸è¿›å¼äº¤ä»˜**ï¼šä¸€ä¸ªæœåŠ¡å¼€å‘å®Œå°±èƒ½ä¸Šçº¿ä½¿ç”¨ï¼Œä¸å½±å“å…¶ä»–æœåŠ¡
- **å¼€æºä¼˜å…ˆ**ï¼šå¤æ‚åŠŸèƒ½ç›´æ¥ç”¨æˆç†Ÿå¼€æºé¡¹ç›®ï¼Œä¸é‡å¤é€ è½®å­
- **æç®€è¿ç»´**ï¼šDocker Composeä¸€é”®éƒ¨ç½²ï¼Œæœ€å°åŒ–è¿ç»´æˆæœ¬
- **AIè¾…åŠ©å¼€å‘**ï¼šå……åˆ†åˆ©ç”¨Claudeåä½œï¼Œæé«˜å¼€å‘æ•ˆç‡

### 1.2 æŠ€æœ¯é€‰å‹åŸåˆ™
- **ç»Ÿä¸€æŠ€æœ¯æ ˆ**ï¼šå…¨éƒ¨Java Spring Bootï¼Œé™ä½å­¦ä¹ æˆæœ¬
- **è½»é‡çº§ç»„ä»¶**ï¼šä¸ç”¨å¤æ‚çš„æœåŠ¡ç½‘æ ¼ï¼Œç”¨ç®€å•çš„æœåŠ¡å‘ç°
- **æ•°æ®åº“ç®€åŒ–**ï¼šä¸€ä¸ªPostgreSQLæå®šå¤§éƒ¨åˆ†éœ€æ±‚
- **éƒ¨ç½²ç®€åŒ–**ï¼šDocker Composeç®¡ç†æ‰€æœ‰æœåŠ¡

## ğŸ—ï¸ äºŒã€æç®€å¾®æœåŠ¡æ¶æ„

### 2.1 æ•´ä½“æ¶æ„å›¾

```mermaid
graph TB
    subgraph å®¢æˆ·ç«¯
        WEB[Webå‰ç«¯<br/>Vue3ç®€å•ç®¡ç†ç•Œé¢]
        APP[æ‰‹æœºAPP<br/>å®¶åº­æˆå‘˜ä½¿ç”¨]
    end
    
    subgraph æ ¸å¿ƒæœåŠ¡[æ ¸å¿ƒå¾®æœåŠ¡ - è‡ªå·±å¼€å‘]
        GATEWAY[ç½‘å…³æœåŠ¡<br/>Spring Cloud Gateway]
        AUTH[è®¤è¯æœåŠ¡<br/>JWT + Spring Security]
        HOME[å®¶åº­ç®¡ç†æœåŠ¡<br/>å®¶åº­/æˆ¿é—´/æˆå‘˜]
        DEVICE[è®¾å¤‡æœåŠ¡<br/>è®¾å¤‡ç®¡ç†ä¸æ§åˆ¶]
        AUTOMATION[è‡ªåŠ¨åŒ–æœåŠ¡<br/>åœºæ™¯ä¸è§„åˆ™]
        NOTIFY[é€šçŸ¥æœåŠ¡<br/>æ¶ˆæ¯æ¨é€]
    end
    
    subgraph å¼€æºæœåŠ¡[å¼€æºæœåŠ¡ - ç›´æ¥éƒ¨ç½²ä½¿ç”¨]
        HABRIDGE[HA-Bridge<br/>è®¾å¤‡æ¥å…¥ç½‘å…³]
        NODERED[Node-RED<br/>å¯è§†åŒ–è‡ªåŠ¨åŒ–]
        NTFY[Ntfy<br/>æ¨é€é€šçŸ¥]
        MINIO[MinIO<br/>æ–‡ä»¶å­˜å‚¨]
        POSTGRES[(PostgreSQL<br/>æ•°æ®åº“)]
    end
    
    subgraph AIæœåŠ¡[AIèƒ½åŠ› - å¼€æºé¡¹ç›®]
        OLLAMA[Ollama<br/>æœ¬åœ°å¤§æ¨¡å‹]
        WHISPER[Whisper<br/>è¯­éŸ³è¯†åˆ«]
        TESSERACT[Tesseract<br/>OCRè¯†åˆ«]
    end
    
    WEB --> GATEWAY
    APP --> GATEWAY
    
    GATEWAY --> AUTH
    GATEWAY --> HOME
    GATEWAY --> DEVICE
    GATEWAY --> AUTOMATION
    GATEWAY --> NOTIFY
    
    DEVICE --> HABRIDGE
    AUTOMATION --> NODERED
    NOTIFY --> NTFY
    
    HOME --> POSTGRES
    AUTH --> POSTGRES
    DEVICE --> POSTGRES
```

### 2.2 æœåŠ¡ä¼˜å…ˆçº§ä¸å¼€å‘é¡ºåº

| ä¼˜å…ˆçº§ | æœåŠ¡åç§° | å¼€å‘å‘¨æœŸ | åŠŸèƒ½è¯´æ˜ | ä¾èµ– |
|--------|----------|----------|----------|------|
| P0 | è®¤è¯æœåŠ¡ | 1å‘¨ | ç”¨æˆ·ç™»å½•ã€JWTç”Ÿæˆ | PostgreSQL |
| P0 | ç½‘å…³æœåŠ¡ | 3å¤© | ç»Ÿä¸€å…¥å£ã€è·¯ç”±è½¬å‘ | æ—  |
| P1 | å®¶åº­ç®¡ç†æœåŠ¡ | 1å‘¨ | å®¶åº­ã€æˆ¿é—´ã€æˆå‘˜ç®¡ç† | è®¤è¯æœåŠ¡ |
| P1 | è®¾å¤‡æœåŠ¡ | 2å‘¨ | è®¾å¤‡æ¥å…¥ã€çŠ¶æ€ç®¡ç† | HA-Bridge |
| P2 | è‡ªåŠ¨åŒ–æœåŠ¡ | 1å‘¨ | åœºæ™¯é…ç½®ã€è§„åˆ™æ‰§è¡Œ | Node-RED |
| P2 | é€šçŸ¥æœåŠ¡ | 3å¤© | æ¶ˆæ¯æ¨é€ | Ntfy |
| P3 | æ–‡ä»¶æœåŠ¡ | 1å‘¨ | ç…§ç‰‡å­˜å‚¨ã€å®¶åº­ç›¸å†Œ | MinIO |
| P3 | AIåŠ©æ‰‹æœåŠ¡ | 2å‘¨ | è¯­éŸ³æ§åˆ¶ã€æ™ºèƒ½æ¨è | Ollama |

## ğŸ“¦ ä¸‰ã€æ ¸å¿ƒæœåŠ¡å¿«é€Ÿå¼€å‘æ¨¡æ¿

### 3.1 ç»Ÿä¸€çˆ¶POMï¼ˆå‡å°‘é…ç½®ï¼‰

```xml
<!-- haven-parent/pom.xml -->
<project>
    <groupId>com.haven</groupId>
    <artifactId>haven-parent</artifactId>
    <version>1.0.0</version>
    <packaging>pom</packaging>
    
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.2.0</version>
    </parent>
    
    <properties>
        <java.version>17</java.version>
        <spring-cloud.version>2023.0.0</spring-cloud.version>
    </properties>
    
    <!-- ç»Ÿä¸€ä¾èµ–ç®¡ç† -->
    <dependencies>
        <!-- æ¯ä¸ªæœåŠ¡éƒ½éœ€è¦çš„åŸºç¡€ä¾èµ– -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
        </dependency>
        <!-- æœåŠ¡å‘ç°ï¼ˆç”¨æœ€ç®€å•çš„ï¼‰ -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-consul-discovery</artifactId>
        </dependency>
    </dependencies>
    
    <!-- ç»Ÿä¸€æ„å»ºé…ç½® -->
    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <configuration>
                    <image>
                        <name>haven/${project.artifactId}:latest</name>
                    </image>
                </configuration>
            </plugin>
        </plugins>
    </build>
</project>
```

### 3.2 å¾®æœåŠ¡å¿«é€Ÿç”Ÿæˆè„šæœ¬

```bash
#!/bin/bash
# create-service.sh - å¿«é€Ÿåˆ›å»ºæ–°æœåŠ¡

SERVICE_NAME=$1
SERVICE_PORT=$2

mkdir -p haven-$SERVICE_NAME/src/main/java/com/haven/$SERVICE_NAME
mkdir -p haven-$SERVICE_NAME/src/main/resources

# ç”Ÿæˆpom.xml
cat > haven-$SERVICE_NAME/pom.xml << EOF
<project>
    <parent>
        <groupId>com.haven</groupId>
        <artifactId>haven-parent</artifactId>
        <version>1.0.0</version>
    </parent>
    
    <artifactId>haven-$SERVICE_NAME</artifactId>
    <name>Haven $SERVICE_NAME Service</name>
</project>
EOF

# ç”Ÿæˆä¸»ç±»
cat > haven-$SERVICE_NAME/src/main/java/com/haven/$SERVICE_NAME/Application.java << EOF
package com.haven.$SERVICE_NAME;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;

@SpringBootApplication
@EnableDiscoveryClient
public class Application {
    public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
    }
}
EOF

# ç”Ÿæˆé…ç½®æ–‡ä»¶
cat > haven-$SERVICE_NAME/src/main/resources/application.yml << EOF
spring:
  application:
    name: haven-$SERVICE_NAME
    
server:
  port: $SERVICE_PORT
  
# æ•°æ®åº“é…ç½®ï¼ˆå¦‚æœéœ€è¦ï¼‰
spring:
  datasource:
    url: jdbc:postgresql://localhost:5432/haven
    username: haven
    password: haven123
    
# æœåŠ¡å‘ç°ï¼ˆConsulï¼‰
spring:
  cloud:
    consul:
      host: localhost
      port: 8500
      discovery:
        service-name: \${spring.application.name}
        health-check-path: /actuator/health
        health-check-interval: 10s
EOF

echo "Service haven-$SERVICE_NAME created successfully!"
```

### 3.3 è®¤è¯æœåŠ¡ï¼ˆç¬¬ä¸€ä¸ªå¼€å‘ï¼‰

```java
// æœ€ç®€è®¤è¯æœåŠ¡å®ç°
@RestController
@RequestMapping("/api/auth")
public class AuthController {
    
    @Autowired
    private JwtUtil jwtUtil;
    
    @Autowired
    private UserRepository userRepository;
    
    // æ³¨å†Œï¼ˆå®¶åº­ç¬¬ä¸€ä¸ªç”¨æˆ·ï¼‰
    @PostMapping("/register")
    public Result<String> register(@RequestBody RegisterRequest request) {
        // ç®€å•éªŒè¯
        if (userRepository.existsByUsername(request.getUsername())) {
            return Result.error("ç”¨æˆ·åå·²å­˜åœ¨");
        }
        
        // åˆ›å»ºç”¨æˆ·å’Œå®¶åº­
        User user = User.builder()
            .username(request.getUsername())
            .password(BCrypt.hashpw(request.getPassword(), BCrypt.gensalt()))
            .role("ADMIN") // ç¬¬ä¸€ä¸ªç”¨æˆ·æ˜¯ç®¡ç†å‘˜
            .build();
            
        userRepository.save(user);
        
        // åˆ›å»ºé»˜è®¤å®¶åº­
        Home home = Home.builder()
            .name(request.getUsername() + "çš„å®¶")
            .ownerId(user.getId())
            .build();
            
        homeRepository.save(home);
        
        return Result.success("æ³¨å†ŒæˆåŠŸ");
    }
    
    // ç™»å½•
    @PostMapping("/login")
    public Result<TokenResponse> login(@RequestBody LoginRequest request) {
        User user = userRepository.findByUsername(request.getUsername());
        
        if (user == null || !BCrypt.checkpw(request.getPassword(), user.getPassword())) {
            return Result.error("ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
        }
        
        // ç”ŸæˆJWT
        String token = jwtUtil.generateToken(user.getId(), user.getUsername(), user.getRole());
        
        return Result.success(TokenResponse.builder()
            .token(token)
            .userId(user.getId())
            .username(user.getUsername())
            .role(user.getRole())
            .build());
    }
    
    // æ·»åŠ å®¶åº­æˆå‘˜ï¼ˆç®€åŒ–ç‰ˆï¼‰
    @PostMapping("/member/add")
    public Result<String> addMember(@RequestBody AddMemberRequest request) {
        String currentUserId = getCurrentUserId();
        
        // éªŒè¯æ˜¯å¦æ˜¯å®¶åº­ç®¡ç†å‘˜
        if (!isHomeAdmin(currentUserId)) {
            return Result.error("åªæœ‰ç®¡ç†å‘˜å¯ä»¥æ·»åŠ æˆå‘˜");
        }
        
        // åˆ›å»ºæˆå‘˜è´¦å·
        User member = User.builder()
            .username(request.getUsername())
            .password(BCrypt.hashpw(request.getPassword(), BCrypt.gensalt()))
            .role("MEMBER")
            .homeId(getHomeId(currentUserId))
            .build();
            
        userRepository.save(member);
        
        return Result.success("æˆå‘˜æ·»åŠ æˆåŠŸ");
    }
}

// JWTå·¥å…·ç±»ï¼ˆæç®€ç‰ˆï¼‰
@Component
public class JwtUtil {
    
    @Value("${jwt.secret:haven-secret-key-2024}")
    private String secret;
    
    public String generateToken(Long userId, String username, String role) {
        return Jwts.builder()
            .setSubject(username)
            .claim("userId", userId)
            .claim("role", role)
            .setIssuedAt(new Date())
            .setExpiration(new Date(System.currentTimeMillis() + 7 * 24 * 60 * 60 * 1000)) // 7å¤©
            .signWith(SignatureAlgorithm.HS256, secret)
            .compact();
    }
    
    public Claims parseToken(String token) {
        return Jwts.parser()
            .setSigningKey(secret)
            .parseClaimsJws(token)
            .getBody();
    }
}
```

### 3.4 è®¾å¤‡æœåŠ¡ï¼ˆå¯¹æ¥å¼€æºHA-Bridgeï¼‰

```java
// è®¾å¤‡æœåŠ¡ - å¯¹æ¥HA-Bridge
@Service
@Slf4j
public class DeviceService {
    
    @Value("${habridge.url:http://localhost:8080}")
    private String habridgeUrl;
    
    @Autowired
    private DeviceRepository deviceRepository;
    
    // æ·»åŠ è®¾å¤‡ï¼ˆé€šè¿‡HA-Bridgeï¼‰
    public Device addDevice(DeviceRequest request) {
        // ä¿å­˜åˆ°æœ¬åœ°æ•°æ®åº“
        Device device = Device.builder()
            .name(request.getName())
            .type(request.getType())
            .roomId(request.getRoomId())
            .protocol(request.getProtocol()) // zigbee/wifi/bluetooth
            .status("OFFLINE")
            .build();
            
        deviceRepository.save(device);
        
        // æ³¨å†Œåˆ°HA-Bridge
        registerToHaBridge(device);
        
        return device;
    }
    
    // æ§åˆ¶è®¾å¤‡
    public void controlDevice(Long deviceId, String command) {
        Device device = deviceRepository.findById(deviceId)
            .orElseThrow(() -> new RuntimeException("è®¾å¤‡ä¸å­˜åœ¨"));
            
        // é€šè¿‡HA-Bridgeæ§åˆ¶
        RestTemplate restTemplate = new RestTemplate();
        String url = habridgeUrl + "/api/devices/" + device.getHaBridgeId() + "/control";
        
        Map<String, Object> payload = Map.of(
            "command", command,
            "deviceId", device.getHaBridgeId()
        );
        
        try {
            restTemplate.postForObject(url, payload, String.class);
            
            // æ›´æ–°è®¾å¤‡çŠ¶æ€
            device.setLastCommand(command);
            device.setLastCommandTime(LocalDateTime.now());
            deviceRepository.save(device);
            
        } catch (Exception e) {
            log.error("æ§åˆ¶è®¾å¤‡å¤±è´¥", e);
            throw new RuntimeException("è®¾å¤‡æ§åˆ¶å¤±è´¥");
        }
    }
    
    // è·å–å®¶åº­æ‰€æœ‰è®¾å¤‡
    public List<DeviceVO> getHomeDevices(Long homeId) {
        List<Device> devices = deviceRepository.findByHomeId(homeId);
        
        return devices.stream()
            .map(this::toDeviceVO)
            .collect(Collectors.toList());
    }
}
```

## ğŸš€ å››ã€æ¨èçš„å¼€æºé¡¹ç›®

### 4.1 è®¾å¤‡æ¥å…¥å±‚

| é¡¹ç›® | ç”¨é€” | GitHub | ä¸ºä»€ä¹ˆé€‰å®ƒ |
|------|------|--------|------------|
| **Home Assistant** | æ™ºèƒ½å®¶å±…ä¸­æ¢ | [home-assistant/core](https://github.com/home-assistant/core) | æ”¯æŒæ•°åƒç§è®¾å¤‡ï¼Œæ´»è·ƒç¤¾åŒº |
| **HA-Bridge** | è®¾å¤‡æ¡¥æ¥ | [bwssytems/ha-bridge](https://github.com/bwssytems/ha-bridge) | è½»é‡çº§ï¼Œæ˜“é›†æˆ |
| **Zigbee2MQTT** | Zigbeeè®¾å¤‡æ¥å…¥ | [Koenkk/zigbee2mqtt](https://github.com/Koenkk/zigbee2mqtt) | æ”¯æŒå¤§é‡Zigbeeè®¾å¤‡ |
| **Tuya-Convert** | æ¶‚é¸¦è®¾å¤‡æ¥å…¥ | [ct-Open-Source/tuya-convert](https://github.com/ct-Open-Source/tuya-convert) | ç ´è§£æ¶‚é¸¦è®¾å¤‡ |

### 4.2 è‡ªåŠ¨åŒ–å¼•æ“

| é¡¹ç›® | ç”¨é€” | GitHub | ä¸ºä»€ä¹ˆé€‰å®ƒ |
|------|------|--------|------------|
| **Node-RED** | å¯è§†åŒ–ç¼–ç¨‹ | [node-red/node-red](https://github.com/node-red/node-red) | æ‹–æ‹½å¼è‡ªåŠ¨åŒ–ï¼Œè¶…ç®€å• |
| **n8n** | å·¥ä½œæµè‡ªåŠ¨åŒ– | [n8n-io/n8n](https://github.com/n8n-io/n8n) | æ›´å¼ºå¤§çš„è‡ªåŠ¨åŒ– |
| **Huginn** | æ™ºèƒ½ä»£ç† | [huginn/huginn](https://github.com/huginn/huginn) | å¤æ‚åœºæ™¯è‡ªåŠ¨åŒ– |

### 4.3 AIèƒ½åŠ›

| é¡¹ç›® | ç”¨é€” | GitHub | ä¸ºä»€ä¹ˆé€‰å®ƒ |
|------|------|--------|------------|
| **Ollama** | æœ¬åœ°å¤§æ¨¡å‹ | [ollama/ollama](https://github.com/ollama/ollama) | ä¸€è¡Œå‘½ä»¤è¿è¡ŒLLM |
| **Whisper** | è¯­éŸ³è¯†åˆ« | [openai/whisper](https://github.com/openai/whisper) | OpenAIå¼€æºï¼Œæ•ˆæœå¥½ |
| **Tesseract** | OCRè¯†åˆ« | [tesseract-ocr/tesseract](https://github.com/tesseract-ocr/tesseract) | è€ç‰ŒOCRï¼Œç¨³å®š |
| **PaddleOCR** | ä¸­æ–‡OCR | [PaddlePaddle/PaddleOCR](https://github.com/PaddlePaddle/PaddleOCR) | ä¸­æ–‡è¯†åˆ«ç‡é«˜ |
| **Rhasspy** | ç¦»çº¿è¯­éŸ³åŠ©æ‰‹ | [rhasspy/rhasspy](https://github.com/rhasspy/rhasspy) | å®Œæ•´çš„ç¦»çº¿è¯­éŸ³æ–¹æ¡ˆ |

### 4.4 é€šçŸ¥æ¨é€

| é¡¹ç›® | ç”¨é€” | GitHub | ä¸ºä»€ä¹ˆé€‰å®ƒ |
|------|------|--------|------------|
| **Ntfy** | æ¨é€é€šçŸ¥ | [binwiederhier/ntfy](https://github.com/binwiederhier/ntfy) | è¶…ç®€å•ï¼Œæ— éœ€æ³¨å†Œ |
| **Gotify** | æ¨é€æœåŠ¡å™¨ | [gotify/server](https://github.com/gotify/server) | è‡ªæ‰˜ç®¡æ¨é€ |
| **Apprise** | å¤šæ¸ é“é€šçŸ¥ | [caronc/apprise](https://github.com/caronc/apprise) | æ”¯æŒ50+é€šçŸ¥æ¸ é“ |

### 4.5 å­˜å‚¨ä¸æ•°æ®åº“

| é¡¹ç›® | ç”¨é€” | GitHub | ä¸ºä»€ä¹ˆé€‰å®ƒ |
|------|------|--------|------------|
| **MinIO** | å¯¹è±¡å­˜å‚¨ | [minio/minio](https://github.com/minio/minio) | S3å…¼å®¹ï¼Œå•äºŒè¿›åˆ¶éƒ¨ç½² |
| **PhotoPrism** | ç…§ç‰‡ç®¡ç† | [photoprism/photoprism](https://github.com/photoprism/photoprism) | AIç…§ç‰‡åˆ†ç±» |
| **Immich** | å®¶åº­ç›¸å†Œ | [immich-app/immich](https://github.com/immich-app/immich) | ç±»Google Photos |

### 4.6 ç›‘æ§è¿ç»´

| é¡¹ç›® | ç”¨é€” | GitHub | ä¸ºä»€ä¹ˆé€‰å®ƒ |
|------|------|--------|------------|
| **Uptime Kuma** | æœåŠ¡ç›‘æ§ | [louislam/uptime-kuma](https://github.com/louislam/uptime-kuma) | æ¼‚äº®çš„ç›‘æ§ç•Œé¢ |
| **Grafana** | æ•°æ®å¯è§†åŒ– | [grafana/grafana](https://github.com/grafana/grafana) | å¼ºå¤§çš„å›¾è¡¨ |
| **Dozzle** | Dockeræ—¥å¿— | [amir20/dozzle](https://github.com/amir20/dozzle) | å®æ—¶æŸ¥çœ‹å®¹å™¨æ—¥å¿— |

## ğŸ³ äº”ã€Docker Composeä¸€é”®éƒ¨ç½²

### 5.1 å®Œæ•´éƒ¨ç½²é…ç½®

```yaml
# docker-compose.yml
version: '3.8'

services:
  # æ•°æ®åº“
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: haven
      POSTGRES_USER: haven
      POSTGRES_PASSWORD: haven123
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    restart: unless-stopped

  # æœåŠ¡å‘ç°ï¼ˆç”¨æœ€ç®€å•çš„Consulï¼‰
  consul:
    image: consul:latest
    ports:
      - "8500:8500"
    command: agent -server -bootstrap-expect=1 -ui -client=0.0.0.0
    restart: unless-stopped

  # ç½‘å…³æœåŠ¡
  gateway:
    image: haven/gateway:latest
    ports:
      - "8080:8080"
    environment:
      CONSUL_HOST: consul
      CONSUL_PORT: 8500
    depends_on:
      - consul
    restart: unless-stopped

  # è®¤è¯æœåŠ¡
  auth-service:
    image: haven/auth:latest
    environment:
      DB_HOST: postgres
      DB_NAME: haven
      DB_USER: haven
      DB_PASSWORD: haven123
      CONSUL_HOST: consul
    depends_on:
      - postgres
      - consul
    restart: unless-stopped

  # è®¾å¤‡æœåŠ¡
  device-service:
    image: haven/device:latest
    environment:
      DB_HOST: postgres
      HABRIDGE_URL: http://ha-bridge:8080
      CONSUL_HOST: consul
    depends_on:
      - postgres
      - consul
      - ha-bridge
    restart: unless-stopped

  # === å¼€æºæœåŠ¡ ===
  
  # HA-Bridgeè®¾å¤‡ç½‘å…³
  ha-bridge:
    image: habridge/ha-bridge:latest
    volumes:
      - habridge_data:/habridge
    ports:
      - "8081:8080"
    restart: unless-stopped

  # Node-REDè‡ªåŠ¨åŒ–
  node-red:
    image: nodered/node-red:latest
    volumes:
      - nodered_data:/data
    ports:
      - "1880:1880"
    environment:
      TZ: Asia/Shanghai
    restart: unless-stopped

  # Ntfyæ¨é€é€šçŸ¥
  ntfy:
    image: binwiederhier/ntfy
    volumes:
      - ntfy_data:/var/cache/ntfy
    ports:
      - "8082:80"
    command: serve --cache-file /var/cache/ntfy/cache.db
    restart: unless-stopped

  # MinIOå¯¹è±¡å­˜å‚¨
  minio:
    image: minio/minio:latest
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data
    environment:
      MINIO_ROOT_USER: admin
      MINIO_ROOT_PASSWORD: admin123
    command: server /data --console-address ":9001"
    restart: unless-stopped

  # Ollamaæœ¬åœ°AIï¼ˆå¯é€‰ï¼Œéœ€è¦GPUï¼‰
  ollama:
    image: ollama/ollama:latest
    volumes:
      - ollama_data:/root/.ollama
    ports:
      - "11434:11434"
    restart: unless-stopped
    # å¦‚æœæœ‰GPUï¼Œæ·»åŠ ä»¥ä¸‹é…ç½®
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]

  # ç›‘æ§æœåŠ¡
  uptime-kuma:
    image: louislam/uptime-kuma:latest
    volumes:
      - uptime_data:/app/data
    ports:
      - "3001:3001"
    restart: unless-stopped

volumes:
  postgres_data:
  habridge_data:
  nodered_data:
  ntfy_data:
  minio_data:
  ollama_data:
  uptime_data:

networks:
  default:
    name: haven-network
```

### 5.2 å¿«é€Ÿå¯åŠ¨è„šæœ¬

```bash
#!/bin/bash
# start.sh - ä¸€é”®å¯åŠ¨æ‰€æœ‰æœåŠ¡

echo "ğŸš€ å¯åŠ¨Havenå®¶åº­æœåŠ¡å¹³å°..."

# å¯åŠ¨åŸºç¡€è®¾æ–½
echo "ğŸ“¦ å¯åŠ¨åŸºç¡€æœåŠ¡..."
docker-compose up -d postgres consul

# ç­‰å¾…æ•°æ®åº“å°±ç»ª
echo "â³ ç­‰å¾…æ•°æ®åº“å¯åŠ¨..."
sleep 10

# åˆå§‹åŒ–æ•°æ®åº“
echo "ğŸ—ƒï¸ åˆå§‹åŒ–æ•°æ®åº“..."
docker exec -i haven-postgres psql -U haven -d haven < init.sql

# å¯åŠ¨å¼€æºæœåŠ¡
echo "ğŸ”§ å¯åŠ¨å¼€æºæœåŠ¡..."
docker-compose up -d ha-bridge node-red ntfy minio uptime-kuma

# å¯åŠ¨æ ¸å¿ƒæœåŠ¡
echo "ğŸ¯ å¯åŠ¨æ ¸å¿ƒæœåŠ¡..."
docker-compose up -d gateway auth-service device-service

echo "âœ… æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨ï¼"
echo ""
echo "ğŸ“‹ æœåŠ¡è®¿é—®åœ°å€ï¼š"
echo "  - ç½‘å…³æœåŠ¡: http://localhost:8080"
echo "  - Consul UI: http://localhost:8500"
echo "  - Node-RED: http://localhost:1880"
echo "  - MinIO Console: http://localhost:9001"
echo "  - Uptime Kuma: http://localhost:3001"
echo ""
echo "é»˜è®¤è´¦å·: admin / admin123"
```

## ğŸ“± å…­ã€ç®€å•çš„Vueç®¡ç†ç•Œé¢

### 6.1 æœ€å°åŒ–ç®¡ç†ç«¯

```vue
<!-- App.vue - è¶…ç®€å•çš„å•é¡µé¢åº”ç”¨ -->
<template>
  <div id="app">
    <el-container>
      <!-- ä¾§è¾¹æ  -->
      <el-aside width="200px">
        <el-menu default-active="1">
          <el-menu-item index="1" @click="currentView = 'dashboard'">
            <i class="el-icon-s-home"></i>
            <span>ä»ªè¡¨ç›˜</span>
          </el-menu-item>
          <el-menu-item index="2" @click="currentView = 'devices'">
            <i class="el-icon-mobile"></i>
            <span>è®¾å¤‡ç®¡ç†</span>
          </el-menu-item>
          <el-menu-item index="3" @click="currentView = 'automation'">
            <i class="el-icon-s-operation"></i>
            <span>è‡ªåŠ¨åŒ–</span>
          </el-menu-item>
          <el-menu-item index="4" @click="currentView = 'family'">
            <i class="el-icon-user"></i>
            <span>å®¶åº­æˆå‘˜</span>
          </el-menu-item>
        </el-menu>
      </el-aside>
      
      <!-- ä¸»å†…å®¹ -->
      <el-main>
        <!-- ä»ªè¡¨ç›˜ -->
        <div v-if="currentView === 'dashboard'">
          <h2>æˆ‘çš„å®¶</h2>
          <el-row :gutter="20">
            <el-col :span="6" v-for="stat in stats" :key="stat.label">
              <el-card>
                <div class="stat-value">{{ stat.value }}</div>
                <div class="stat-label">{{ stat.label }}</div>
              </el-card>
            </el-col>
          </el-row>
        </div>
        
        <!-- è®¾å¤‡ç®¡ç† -->
        <div v-if="currentView === 'devices'">
          <h2>è®¾å¤‡ç®¡ç†</h2>
          <el-button type="primary" @click="addDevice">æ·»åŠ è®¾å¤‡</el-button>
          <el-table :data="devices" style="width: 100%; margin-top: 20px">
            <el-table-column prop="name" label="è®¾å¤‡åç§°" />
            <el-table-column prop="room" label="æˆ¿é—´" />
            <el-table-column prop="status" label="çŠ¶æ€">
              <template #default="scope">
                <el-tag :type="scope.row.status === 'ONLINE' ? 'success' : 'danger'">
                  {{ scope.row.status }}
                </el-tag>
              </template>
            </el-table-column>
            <el-table-column label="æ“ä½œ">
              <template #default="scope">
                <el-switch 
                  v-model="scope.row.power" 
                  @change="toggleDevice(scope.row)" />
              </template>
            </el-table-column>
          </el-table>
        </div>
        
        <!-- è‡ªåŠ¨åŒ– -->
        <div v-if="currentView === 'automation'">
          <h2>è‡ªåŠ¨åŒ–åœºæ™¯</h2>
          <el-button type="primary" @click="openNodeRed">æ‰“å¼€Node-RED</el-button>
          <div class="scene-list">
            <el-card v-for="scene in scenes" :key="scene.id" class="scene-card">
              <h3>{{ scene.name }}</h3>
              <p>{{ scene.description }}</p>
              <el-switch v-model="scene.enabled" @change="toggleScene(scene)" />
            </el-card>
          </div>
        </div>
      </el-main>
    </el-container>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue'
import axios from 'axios'

const currentView = ref('dashboard')
const devices = ref([])
const scenes = ref([])
const stats = ref([
  { label: 'åœ¨çº¿è®¾å¤‡', value: 12 },
  { label: 'ä»Šæ—¥ç”¨ç”µ', value: '15.3kWh' },
  { label: 'å®¤å†…æ¸©åº¦', value: '26Â°C' },
  { label: 'æ´»åŠ¨åœºæ™¯', value: 3 }
])

const API_BASE = 'http://localhost:8080/api'

// åŠ è½½è®¾å¤‡åˆ—è¡¨
const loadDevices = async () => {
  const res = await axios.get(`${API_BASE}/devices`)
  devices.value = res.data
}

// åˆ‡æ¢è®¾å¤‡å¼€å…³
const toggleDevice = async (device) => {
  await axios.post(`${API_BASE}/devices/${device.id}/control`, {
    command: device.power ? 'ON' : 'OFF'
  })
}

// æ‰“å¼€Node-RED
const openNodeRed = () => {
  window.open('http://localhost:1880', '_blank')
}

onMounted(() => {
  loadDevices()
})
</script>

<style>
.stat-value {
  font-size: 24px;
  font-weight: bold;
  color: #409EFF;
}

.stat-label {
  color: #909399;
  margin-top: 5px;
}

.scene-card {
  margin-bottom: 20px;
}
</style>
```

## ğŸ¯ ä¸ƒã€ä¸ªäººå¼€å‘è€…æœ€ä½³å®è·µ

### 7.1 å¼€å‘æµç¨‹

1. **å…ˆè·‘é€šæœ€å°é—­ç¯**
   - ç¬¬1å‘¨ï¼šè®¤è¯æœåŠ¡ + ç½‘å…³ = èƒ½ç™»å½•
   - ç¬¬2å‘¨ï¼šè®¾å¤‡æœåŠ¡ + HA-Bridge = èƒ½æ§åˆ¶ä¸€ä¸ªç¯
   - ç¬¬3å‘¨ï¼šé€šçŸ¥æœåŠ¡ + Ntfy = èƒ½æ”¶åˆ°æ¨é€

2. **å……åˆ†åˆ©ç”¨å¼€æºé¡¹ç›®**
   - ä¸è¦è‡ªå·±å†™è®¾å¤‡åè®®ï¼Œç”¨HA-Bridge
   - ä¸è¦è‡ªå·±å†™è‡ªåŠ¨åŒ–å¼•æ“ï¼Œç”¨Node-RED
   - ä¸è¦è‡ªå·±å†™æ¨é€ç³»ç»Ÿï¼Œç”¨Ntfy

3. **ä¿æŒç®€å•**
   - ä¸ç”¨Kubernetesï¼ŒDocker Composeå¤Ÿäº†
   - ä¸ç”¨æœåŠ¡ç½‘æ ¼ï¼ŒConsulæœåŠ¡å‘ç°å¤Ÿäº†
   - ä¸ç”¨åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œå•ä½“äº‹åŠ¡å¤Ÿäº†

### 7.2 ä¸Claudeåä½œæŠ€å·§

```markdown
# ç»™Claudeçš„æç¤ºè¯æ¨¡æ¿

æˆ‘æ­£åœ¨å¼€å‘Havenå®¶åº­æœåŠ¡å¹³å°çš„[æœåŠ¡åç§°]æœåŠ¡ã€‚

æŠ€æœ¯æ ˆï¼š
- Spring Boot 3.2
- PostgreSQL
- Dockeréƒ¨ç½²

å½“å‰ä»»åŠ¡ï¼š
[å…·ä½“æè¿°ä½ è¦å®ç°çš„åŠŸèƒ½]

å·²æœ‰ä»£ç ï¼š
[è´´å…¥ç›¸å…³ä»£ç ]

è¯·å¸®æˆ‘ï¼š
1. å®ç°[å…·ä½“åŠŸèƒ½]
2. ä»£ç è¦ç®€å•ç›´æ¥ï¼Œä¸è¦è¿‡åº¦è®¾è®¡
3. è€ƒè™‘åˆ°è¿™æ˜¯ä¸ªäººé¡¹ç›®ï¼Œè¦æ˜“äºç»´æŠ¤
```

### 7.3 æˆæœ¬ä¼°ç®—

| é¡¹ç›® | æˆæœ¬ | è¯´æ˜ |
|------|------|------|
| å¼€å‘æ—¶é—´ | 2-3ä¸ªæœˆ | æ¯å¤©2-3å°æ—¶ |
| æœåŠ¡å™¨ | Â¥50/æœˆ | 2æ ¸4Gè¶³å¤Ÿå®¶ç”¨ |
| åŸŸå | Â¥50/å¹´ | å¯é€‰ |
| è®¾å¤‡ | Â¥500-2000 | Zigbeeç½‘å…³ã€æ™ºèƒ½æ’åº§ç­‰ |
| **æ€»è®¡** | **<Â¥3000** | ä¸€å¹´æ€»æˆæœ¬ |

### 7.4 æ¸è¿›å¼åŠŸèƒ½æ‰©å±•

```mermaid
graph LR
    subgraph ç¬¬1é˜¶æ®µ[1ä¸ªæœˆ]
        A1[ç”¨æˆ·ç™»å½•]
        A2[è®¾å¤‡æ§åˆ¶]
        A3[åŸºç¡€é€šçŸ¥]
    end
    
    subgraph ç¬¬2é˜¶æ®µ[2ä¸ªæœˆ]
        B1[åœºæ™¯è‡ªåŠ¨åŒ–]
        B2[å®¶åº­ç›¸å†Œ]
        B3[èƒ½è€—ç»Ÿè®¡]
    end
    
    subgraph ç¬¬3é˜¶æ®µ[3ä¸ªæœˆ]
        C1[è¯­éŸ³æ§åˆ¶]
        C2[AIå»ºè®®]
        C3[å®‰é˜²ç›‘æ§]
    end
    
    A1 --> B1 --> C1
```

## ğŸš€ å…«ã€å¿«é€Ÿå¼€å§‹

```bash
# 1. å…‹éš†é¡¹ç›®
git clone https://github.com/yourusername/HavenButler.git
cd HavenButler

# 2. æ„å»ºç¬¬ä¸€ä¸ªæœåŠ¡ï¼ˆè®¤è¯æœåŠ¡ï¼‰
cd haven-auth
mvn clean package
docker build -t haven/auth:latest .

# 3. å¯åŠ¨åŸºç¡€è®¾æ–½
docker-compose up -d postgres consul

# 4. å¯åŠ¨è®¤è¯æœåŠ¡
docker-compose up -d auth-service

# 5. æµ‹è¯•æ³¨å†Œç™»å½•
curl -X POST http://localhost:8080/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'

# æ­å–œï¼ä½ çš„ç¬¬ä¸€ä¸ªæœåŠ¡å·²ç»ä¸Šçº¿äº†ï¼
```

## ğŸ’¡ ä¹ã€å†™åœ¨æœ€å

è¿™ä¸ªæ¶æ„ä¸“é—¨ä¸ºä¸ªäººå¼€å‘è€…è®¾è®¡ï¼š
- **ä¸è¿½æ±‚å®Œç¾**ï¼šèƒ½ç”¨å°±è¡Œï¼Œåç»­å†ä¼˜åŒ–
- **ä¸é‡å¤é€ è½®å­**ï¼šç«™åœ¨å·¨äººè‚©è†€ä¸Š
- **ä¿æŒç®€å•**ï¼šå®å¯åŠŸèƒ½å°‘ï¼Œä¸è¦å¤æ‚åº¦é«˜
- **æ¸è¿›å¼å¼€å‘**ï¼šä¸€ä¸ªæœåŠ¡ä¸€ä¸ªæœåŠ¡åœ°å®Œæˆ

è®°ä½ï¼š**Done is better than perfect!**

æœ‰äº†è¿™ä¸ªæ¶æ„ï¼Œä½ å¯ä»¥ï¼š
1. ä»Šå¤©å®Œæˆè®¤è¯æœåŠ¡
2. æ˜å¤©æ¥å…¥ç¬¬ä¸€ä¸ªæ™ºèƒ½è®¾å¤‡
3. åå¤©å®ç°ç¬¬ä¸€ä¸ªè‡ªåŠ¨åŒ–åœºæ™¯

æ¯ä¸ªå°è¿›æ­¥éƒ½æ˜¯å®å®åœ¨åœ¨çš„åŠŸèƒ½ï¼Œå®¶äººç«‹åˆ»å°±èƒ½ç”¨ä¸Šï¼