# HavenButler å‰ç«¯æ¶æ„è®¾è®¡æ–‡æ¡£

## æ–‡æ¡£ä¿¡æ¯

| é¡¹ç›® | å†…å®¹ |
|------|------|
| æ–‡æ¡£åç§° | HavenButler å‰ç«¯æ¶æ„è®¾è®¡ |
| ç‰ˆæœ¬ | v1.0.0 |
| åˆ›å»ºæ—¥æœŸ | 2024-09-12 |
| æœ€åæ›´æ–° | 2024-09-12 |
| æ–‡æ¡£çŠ¶æ€ | åˆç¨¿ |
| ç¼–å†™è€… | Claude (åŸºäºBMADæ¶æ„ä»£ç†) |

## ç›®å½•

1. [æ¶æ„æ¦‚è¿°](#1-æ¶æ„æ¦‚è¿°)
2. [æŠ€æœ¯é€‰å‹](#2-æŠ€æœ¯é€‰å‹)
3. [ç³»ç»Ÿæ¶æ„](#3-ç³»ç»Ÿæ¶æ„)
4. [æ•°æ®æµè®¾è®¡](#4-æ•°æ®æµè®¾è®¡)
5. [ç»„ä»¶æ¶æ„](#5-ç»„ä»¶æ¶æ„)
6. [è·¯ç”±è®¾è®¡](#6-è·¯ç”±è®¾è®¡)
7. [çŠ¶æ€ç®¡ç†](#7-çŠ¶æ€ç®¡ç†)
8. [æ ·å¼ç³»ç»Ÿ](#8-æ ·å¼ç³»ç»Ÿ)
9. [æ„å»ºä¸éƒ¨ç½²](#9-æ„å»ºä¸éƒ¨ç½²)
10. [æ€§èƒ½ä¼˜åŒ–](#10-æ€§èƒ½ä¼˜åŒ–)
11. [å®‰å…¨ä¸æƒé™](#11-å®‰å…¨ä¸æƒé™)
12. [æµ‹è¯•ç­–ç•¥](#12-æµ‹è¯•ç­–ç•¥)
13. [å›½é™…åŒ–æ”¯æŒ](#13-å›½é™…åŒ–æ”¯æŒ)
14. [ç§»åŠ¨ç«¯é€‚é…](#14-ç§»åŠ¨ç«¯é€‚é…)
15. [å¼€å‘è§„èŒƒ](#15-å¼€å‘è§„èŒƒ)

## 1. æ¶æ„æ¦‚è¿°

### 1.1 é¡¹ç›®ç®€ä»‹

HavenButlerå‰ç«¯æ¶æ„é‡‡ç”¨å¤šç«¯ç»Ÿä¸€è®¾è®¡ï¼Œæ”¯æŒVue3 Webç«¯ã€å°ç¨‹åºã€ç§»åŠ¨APPå’Œæ™ºèƒ½éŸ³ç®±äº¤äº’ï¼Œä¸ºç”¨æˆ·æä¾›ä¸€è‡´çš„æ™ºèƒ½å®¶åº­æœåŠ¡ä½“éªŒã€‚

### 1.2 æ¶æ„ç›®æ ‡

- **å¤šç«¯ä¸€è‡´æ€§**ï¼šä¸€å¥—ä»£ç æ”¯æŒå¤šç«¯éƒ¨ç½²ï¼Œé™ä½ç»´æŠ¤æˆæœ¬
- **ç”¨æˆ·ä½“éªŒä¼˜å…ˆ**ï¼šé’ˆå¯¹ä¸åŒå¹´é¾„å±‚ç”¨æˆ·ä¼˜åŒ–äº¤äº’ä½“éªŒ
- **æ€§èƒ½ä¼˜åŒ–**ï¼šç¡®ä¿å¿«é€Ÿå“åº”å’Œæµç•…äº¤äº’
- **å¯æ‰©å±•æ€§**ï¼šæ”¯æŒä¸šåŠ¡å¿«é€Ÿè¿­ä»£å’ŒåŠŸèƒ½æ‰©å±•
- **å®‰å…¨æ€§**ï¼šå®Œå–„çš„æƒé™æ§åˆ¶å’Œæ•°æ®ä¿æŠ¤æœºåˆ¶

### 1.3 æ ¸å¿ƒç‰¹æ€§

- åŸºäºVue3 + TypeScriptçš„ç°ä»£åŒ–å‰ç«¯æ¶æ„
- å“åº”å¼è®¾è®¡ï¼Œæ”¯æŒç§»åŠ¨ç«¯åˆ°å¤§å±çš„å…¨å°ºå¯¸é€‚é…
- ç»„ä»¶åŒ–è®¾è®¡ç³»ç»Ÿï¼ŒåŸºäºAnt Design Vueå®šåˆ¶
- çŠ¶æ€ç®¡ç†é‡‡ç”¨Piniaï¼Œæ”¯æŒæŒä¹…åŒ–å’Œæ—¶é—´æ—…è¡Œ
- å¤šè¯­è¨€å›½é™…åŒ–æ”¯æŒ
- PWAæ”¯æŒï¼Œå¯ç¦»çº¿ä½¿ç”¨æ ¸å¿ƒåŠŸèƒ½
- å¾®å‰ç«¯æ¶æ„ï¼Œæ”¯æŒæ¨¡å—ç‹¬ç«‹å¼€å‘å’Œéƒ¨ç½²

## 2. æŠ€æœ¯é€‰å‹

### 2.1 æ ¸å¿ƒæŠ€æœ¯æ ˆ

| æŠ€æœ¯ç±»åˆ« | é€‰æ‹© | ç‰ˆæœ¬ | è¯´æ˜ |
|----------|------|------|------|
| å‰ç«¯æ¡†æ¶ | Vue3 | ^3.3.0 | é‡‡ç”¨Composition APIï¼Œæ›´å¥½çš„TypeScriptæ”¯æŒ |
| å¼€å‘è¯­è¨€ | TypeScript | ^5.0.0 | ç±»å‹å®‰å…¨ï¼Œæå‡å¼€å‘æ•ˆç‡ |
| çŠ¶æ€ç®¡ç† | Pinia | ^2.1.0 | Vue3å®˜æ–¹æ¨èçŠ¶æ€ç®¡ç†åº“ |
| è·¯ç”±ç®¡ç† | Vue Router | ^4.2.0 | å®˜æ–¹è·¯ç”±è§£å†³æ–¹æ¡ˆ |
| UIç»„ä»¶åº“ | Ant Design Vue | ^4.0.0 | ä¼ä¸šçº§UIè®¾è®¡è¯­è¨€å’Œç»„ä»¶åº“ |
| æ„å»ºå·¥å…· | Vite | ^4.4.0 | å¿«é€Ÿå†·å¯åŠ¨ï¼Œçƒ­é‡è½½ |
| åŒ…ç®¡ç†å™¨ | pnpm | ^8.6.0 | é«˜æ•ˆçš„åŒ…ç®¡ç†å·¥å…· |
| CSSé¢„å¤„ç†å™¨ | Sass | ^1.64.0 | å¼ºå¤§çš„CSSæ‰©å±•è¯­è¨€ |
| æµ‹è¯•æ¡†æ¶ | Vitest | ^0.34.0 | åŸºäºViteçš„å•å…ƒæµ‹è¯•æ¡†æ¶ |
| E2Eæµ‹è¯• | Playwright | ^1.37.0 | è·¨æµè§ˆå™¨ç«¯åˆ°ç«¯æµ‹è¯• |

### 2.2 å¼€å‘å·¥å…·é“¾

| å·¥å…·ç±»å‹ | é€‰æ‹© | è¯´æ˜ |
|----------|------|------|
| ä»£ç æ ¼å¼åŒ– | Prettier | ä»£ç æ ¼å¼åŒ–å·¥å…· |
| ä»£ç æ£€æŸ¥ | ESLint | JavaScript/TypeScriptä»£ç æ£€æŸ¥ |
| Gité’©å­ | Husky | Gitæäº¤å‰æ£€æŸ¥ |
| æäº¤è§„èŒƒ | Commitizen | è§„èŒƒåŒ–æäº¤ä¿¡æ¯ |
| MockæœåŠ¡ | MSW | Service Workerçº§åˆ«çš„API Mock |
| å›¾æ ‡åº“ | @ant-design/icons-vue | Ant Designå®˜æ–¹å›¾æ ‡åº“ |
| æ—¥æœŸå¤„ç† | dayjs | è½»é‡çº§æ—¥æœŸå¤„ç†åº“ |
| HTTPå®¢æˆ·ç«¯ | axios | PromiseåŸºç¡€çš„HTTPå®¢æˆ·ç«¯ |

### 2.3 æŠ€æœ¯é€‰å‹ä¾æ®

#### Vue3é€‰æ‹©ç†ç”±
- **æ€§èƒ½ä¼˜åŠ¿**ï¼šæ¯”Vue2æ€§èƒ½æå‡40%ï¼Œæ”¯æŒTree-shaking
- **Composition API**ï¼šæ›´å¥½çš„é€»è¾‘å¤ç”¨å’ŒTypeScriptæ”¯æŒ
- **ç”Ÿæ€æˆç†Ÿ**ï¼šä¸°å¯Œçš„ç¬¬ä¸‰æ–¹åº“å’Œå·¥å…·é“¾æ”¯æŒ
- **å›¢é˜Ÿç†Ÿæ‚‰åº¦**ï¼šå›¢é˜Ÿå…·å¤‡Vueå¼€å‘ç»éªŒ

#### TypeScripté€‰æ‹©ç†ç”±
- **ç±»å‹å®‰å…¨**ï¼šç¼–è¯‘æ—¶å‘ç°é”™è¯¯ï¼Œé™ä½ç”Ÿäº§ç¯å¢ƒbug
- **IDEæ”¯æŒ**ï¼šæ›´å¥½çš„ä»£ç æç¤ºå’Œé‡æ„èƒ½åŠ›
- **å›¢é˜Ÿåä½œ**ï¼šç±»å‹å®šä¹‰å³æ–‡æ¡£ï¼Œæå‡åä½œæ•ˆç‡
- **å¤§å‹é¡¹ç›®å‹å¥½**ï¼šé€‚åˆå¤æ‚ä¸šåŠ¡é€»è¾‘çš„å¼€å‘ç»´æŠ¤

#### Piniaé€‰æ‹©ç†ç”±
- **Vue3åŸç”Ÿæ”¯æŒ**ï¼šä¸“ä¸ºVue3è®¾è®¡ï¼Œå®Œç¾é›†æˆ
- **TypeScriptå‹å¥½**ï¼šå¤©ç„¶æ”¯æŒTypeScriptæ¨æ–­
- **æ¨¡å—åŒ–è®¾è®¡**ï¼šæ”¯æŒæŒ‰åŠŸèƒ½æ¨¡å—æ‹†åˆ†store
- **å¼€å‘å·¥å…·æ”¯æŒ**ï¼šå®Œæ•´çš„Vue DevToolsæ”¯æŒ

## 3. ç³»ç»Ÿæ¶æ„

### 3.1 æ•´ä½“æ¶æ„å›¾

```mermaid
graph TB
    subgraph "ç”¨æˆ·ç•Œé¢å±‚"
        A1[Vue3 Webç«¯]
        A2[å°ç¨‹åºç«¯]
        A3[ç§»åŠ¨APPç«¯]
        A4[æ™ºèƒ½éŸ³ç®±ç•Œé¢]
    end
    
    subgraph "è¡¨ç°å±‚(Presentation Layer)"
        B1[è·¯ç”±ç®¡ç†<br/>Vue Router]
        B2[ç»„ä»¶åº“<br/>Design System]
        B3[é¡µé¢ç»„ä»¶<br/>Views/Pages]
        B4[ä¸šåŠ¡ç»„ä»¶<br/>Business Components]
    end
    
    subgraph "ä¸šåŠ¡é€»è¾‘å±‚(Business Logic Layer)"
        C1[çŠ¶æ€ç®¡ç†<br/>Pinia Stores]
        C2[ä¸šåŠ¡æœåŠ¡<br/>Services]
        C3[æ•°æ®æ¨¡å‹<br/>Models/Types]
        C4[å·¥å…·å‡½æ•°<br/>Utils]
    end
    
    subgraph "æ•°æ®è®¿é—®å±‚(Data Access Layer)"
        D1[HTTPå®¢æˆ·ç«¯<br/>Axios]
        D2[WebSocketå®¢æˆ·ç«¯<br/>Socket.io]
        D3[æœ¬åœ°å­˜å‚¨<br/>LocalStorage/IndexedDB]
        D4[ç¼“å­˜ç®¡ç†<br/>Cache Manager]
    end
    
    subgraph "åŸºç¡€è®¾æ–½å±‚(Infrastructure Layer)"
        E1[æ„å»ºå·¥å…·<br/>Vite]
        E2[æµ‹è¯•æ¡†æ¶<br/>Vitest/Playwright]
        E3[ä»£ç è´¨é‡<br/>ESLint/Prettier]
        E4[éƒ¨ç½²é…ç½®<br/>Docker/Nginx]
    end
    
    A1 --> B1
    A1 --> B2
    A1 --> B3
    B1 --> C1
    B3 --> B4
    B4 --> C2
    C1 --> C2
    C2 --> D1
    C2 --> D2
    C1 --> D3
    D1 --> D4
    
    E1 --> B1
    E2 --> C1
    E3 --> B1
    E4 --> A1
```

### 3.2 å¾®å‰ç«¯æ¶æ„è®¾è®¡

é‡‡ç”¨Module Federationå®ç°å¾®å‰ç«¯æ¶æ„ï¼Œæ”¯æŒåŠŸèƒ½æ¨¡å—ç‹¬ç«‹å¼€å‘å’Œéƒ¨ç½²ï¼š

```mermaid
graph TB
    subgraph "ä¸»åº”ç”¨ (Shell App)"
        A[åº”ç”¨å¤–å£³<br/>è·¯ç”±ã€å¸ƒå±€ã€å…¬å…±æœåŠ¡]
    end
    
    subgraph "è®¾å¤‡æ§åˆ¶æ¨¡å—"
        B1[è®¾å¤‡ç®¡ç†]
        B2[æˆ¿é—´æ§åˆ¶]
        B3[åœºæ™¯ç®¡ç†]
    end
    
    subgraph "å®¶åº­ç®¡ç†æ¨¡å—"
        C1[æˆå‘˜ç®¡ç†]
        C2[æƒé™æ§åˆ¶]
        C3[è®¿å®¢ç®¡ç†]
    end
    
    subgraph "ç³»ç»Ÿè®¾ç½®æ¨¡å—"
        D1[ä¸ªäººè®¾ç½®]
        D2[ç³»ç»Ÿé…ç½®]
        D3[å®‰å…¨è®¾ç½®]
    end
    
    subgraph "æ•°æ®åˆ†ææ¨¡å—"
        E1[ä½¿ç”¨ç»Ÿè®¡]
        E2[èƒ½è€—åˆ†æ]
        E3[è¡Œä¸ºåˆ†æ]
    end
    
    A --> B1
    A --> C1
    A --> D1
    A --> E1
```

### 3.3 å±‚æ¬¡ç»“æ„è¯¦è§£

#### 3.3.1 ç”¨æˆ·ç•Œé¢å±‚
- **Vue3 Webç«¯**ï¼šä¸»è¦æ¡Œé¢ç«¯ç•Œé¢ï¼ŒåŠŸèƒ½æœ€å®Œæ•´
- **å°ç¨‹åºç«¯**ï¼šè½»é‡çº§ç§»åŠ¨ç«¯ä½“éªŒï¼Œæ ¸å¿ƒåŠŸèƒ½ä¼˜å…ˆ
- **ç§»åŠ¨APPç«¯**ï¼šåŸç”Ÿä½“éªŒï¼Œç¦»çº¿åŠŸèƒ½æ”¯æŒ
- **æ™ºèƒ½éŸ³ç®±ç•Œé¢**ï¼šè¯­éŸ³äº¤äº’ä¼˜å…ˆï¼Œç®€åŒ–è§†è§‰ç•Œé¢

#### 3.3.2 è¡¨ç°å±‚
- **è·¯ç”±ç®¡ç†**ï¼šåŸºäºVue Router 4çš„å£°æ˜å¼è·¯ç”±é…ç½®
- **ç»„ä»¶åº“**ï¼šåŸºäºAnt Design Vueçš„å®šåˆ¶åŒ–è®¾è®¡ç³»ç»Ÿ
- **é¡µé¢ç»„ä»¶**ï¼šä¸šåŠ¡é¡µé¢çº§ç»„ä»¶ï¼Œè´Ÿè´£å¸ƒå±€å’Œæ•°æ®ç¼–æ’
- **ä¸šåŠ¡ç»„ä»¶**ï¼šå¯å¤ç”¨çš„ä¸šåŠ¡ç»„ä»¶ï¼Œå°è£…ç‰¹å®šä¸šåŠ¡é€»è¾‘

#### 3.3.3 ä¸šåŠ¡é€»è¾‘å±‚
- **çŠ¶æ€ç®¡ç†**ï¼šPinia storesç®¡ç†åº”ç”¨çŠ¶æ€
- **ä¸šåŠ¡æœåŠ¡**ï¼šå°è£…ä¸šåŠ¡é€»è¾‘ï¼Œå¤„ç†æ•°æ®è½¬æ¢
- **æ•°æ®æ¨¡å‹**ï¼šTypeScriptç±»å‹å®šä¹‰å’Œæ•°æ®æ¨¡å‹
- **å·¥å…·å‡½æ•°**ï¼šé€šç”¨å·¥å…·å‡½æ•°å’Œä¸šåŠ¡å·¥å…·å‡½æ•°

#### 3.3.4 æ•°æ®è®¿é—®å±‚
- **HTTPå®¢æˆ·ç«¯**ï¼šå°è£…APIè°ƒç”¨ï¼Œæ”¯æŒè¯·æ±‚æ‹¦æˆªå’Œå“åº”å¤„ç†
- **WebSocketå®¢æˆ·ç«¯**ï¼šå®æ—¶æ•°æ®é€šä¿¡ï¼Œè®¾å¤‡çŠ¶æ€åŒæ­¥
- **æœ¬åœ°å­˜å‚¨**ï¼šç”¨æˆ·åå¥½è®¾ç½®å’Œç¦»çº¿æ•°æ®å­˜å‚¨
- **ç¼“å­˜ç®¡ç†**ï¼šæ¥å£æ•°æ®ç¼“å­˜ï¼Œæå‡ç”¨æˆ·ä½“éªŒ

## 4. æ•°æ®æµè®¾è®¡

### 4.1 æ•°æ®æµæ¶æ„å›¾

```mermaid
graph TB
    subgraph "ç”¨æˆ·æ“ä½œ"
        A1[ç”¨æˆ·äº¤äº’]
        A2[è¯­éŸ³æŒ‡ä»¤]
        A3[è®¾å¤‡äº‹ä»¶]
    end
    
    subgraph "çŠ¶æ€ç®¡ç†"
        B1[Device Store]
        B2[User Store]
        B3[Permission Store]
        B4[Message Store]
    end
    
    subgraph "ä¸šåŠ¡æœåŠ¡"
        C1[è®¾å¤‡æœåŠ¡]
        C2[ç”¨æˆ·æœåŠ¡]
        C3[æƒé™æœåŠ¡]
        C4[æ¶ˆæ¯æœåŠ¡]
    end
    
    subgraph "æ•°æ®æº"
        D1[åç«¯API]
        D2[WebSocket]
        D3[æœ¬åœ°ç¼“å­˜]
        D4[æµè§ˆå™¨å­˜å‚¨]
    end
    
    A1 --> B1
    A2 --> B1
    A3 --> B1
    
    B1 --> C1
    B2 --> C2
    B3 --> C3
    B4 --> C4
    
    C1 --> D1
    C1 --> D2
    C1 --> D3
    
    D2 --> B1
    D2 --> B4
    
    B1 --> A1
    B2 --> A1
```

### 4.2 çŠ¶æ€ç®¡ç†è®¾è®¡

#### 4.2.1 Storeç»“æ„è®¾è®¡

```typescript
// stores/index.ts - çŠ¶æ€ç®¡ç†å…¥å£
export interface RootState {
  device: DeviceState
  user: UserState
  permission: PermissionState
  message: MessageState
  system: SystemState
}

// stores/device.ts - è®¾å¤‡çŠ¶æ€ç®¡ç†
export interface DeviceState {
  devices: Device[]
  rooms: Room[]
  scenes: Scene[]
  activeDevice: Device | null
  deviceStatus: Record<string, DeviceStatus>
  loading: boolean
  error: string | null
}

// stores/user.ts - ç”¨æˆ·çŠ¶æ€ç®¡ç†
export interface UserState {
  currentUser: User | null
  familyMembers: FamilyMember[]
  preferences: UserPreferences
  isAuthenticated: boolean
  loading: boolean
}

// stores/permission.ts - æƒé™çŠ¶æ€ç®¡ç†
export interface PermissionState {
  userPermissions: UserPermission[]
  devicePermissions: Record<string, DevicePermission>
  pendingRequests: PermissionRequest[]
  permissionMatrix: PermissionMatrix
}
```

#### 4.2.2 çŠ¶æ€æ›´æ–°æµç¨‹

```typescript
// è®¾å¤‡æ§åˆ¶çŠ¶æ€æ›´æ–°ç¤ºä¾‹
export const useDeviceStore = defineStore('device', () => {
  const state = reactive<DeviceState>({
    devices: [],
    activeDevice: null,
    loading: false,
    error: null
  })

  // Actions
  const controlDevice = async (deviceId: string, command: DeviceCommand) => {
    state.loading = true
    state.error = null
    
    try {
      // 1. æœ¬åœ°çŠ¶æ€ç«‹å³æ›´æ–°ï¼ˆä¹è§‚æ›´æ–°ï¼‰
      const device = state.devices.find(d => d.id === deviceId)
      if (device) {
        updateDeviceStatus(device, command)
      }
      
      // 2. å‘é€APIè¯·æ±‚
      const result = await deviceService.controlDevice(deviceId, command)
      
      // 3. æ›´æ–°æœ€ç»ˆçŠ¶æ€
      updateDeviceFromAPI(result)
      
    } catch (error) {
      // 4. é”™è¯¯å¤„ç†ï¼Œå›æ»šæœ¬åœ°çŠ¶æ€
      state.error = error.message
      revertDeviceStatus(deviceId)
    } finally {
      state.loading = false
    }
  }

  return {
    ...toRefs(state),
    controlDevice
  }
})
```

### 4.3 å®æ—¶æ•°æ®åŒæ­¥

#### 4.3.1 WebSocketè¿æ¥ç®¡ç†

```typescript
// services/websocket.ts
export class WebSocketManager {
  private connections: Map<string, WebSocket> = new Map()
  private reconnectAttempts: Map<string, number> = new Map()
  private maxReconnectAttempts = 5
  
  connect(endpoint: string, options: WebSocketOptions) {
    const ws = new WebSocket(endpoint)
    
    ws.onopen = () => {
      console.log(`WebSocket connected: ${endpoint}`)
      this.resetReconnectAttempts(endpoint)
    }
    
    ws.onmessage = (event) => {
      this.handleMessage(endpoint, JSON.parse(event.data))
    }
    
    ws.onclose = () => {
      console.log(`WebSocket disconnected: ${endpoint}`)
      this.attemptReconnect(endpoint, options)
    }
    
    ws.onerror = (error) => {
      console.error(`WebSocket error: ${endpoint}`, error)
    }
    
    this.connections.set(endpoint, ws)
  }
  
  private handleMessage(endpoint: string, message: WebSocketMessage) {
    // æ ¹æ®æ¶ˆæ¯ç±»å‹åˆ†å‘åˆ°å¯¹åº”çš„store
    switch (message.type) {
      case 'device_status_update':
        const deviceStore = useDeviceStore()
        deviceStore.updateDeviceStatus(message.data)
        break
      case 'permission_request':
        const permissionStore = usePermissionStore()
        permissionStore.addPendingRequest(message.data)
        break
      case 'system_notification':
        const messageStore = useMessageStore()
        messageStore.addNotification(message.data)
        break
    }
  }
}
```

#### 4.3.2 ç¦»çº¿çŠ¶æ€å¤„ç†

```typescript
// composables/useOfflineSync.ts
export function useOfflineSync() {
  const isOnline = ref(navigator.onLine)
  const pendingActions = ref<PendingAction[]>([])
  
  // ç›‘å¬ç½‘ç»œçŠ¶æ€å˜åŒ–
  window.addEventListener('online', () => {
    isOnline.value = true
    syncPendingActions()
  })
  
  window.addEventListener('offline', () => {
    isOnline.value = false
  })
  
  const addPendingAction = (action: PendingAction) => {
    if (!isOnline.value) {
      pendingActions.value.push(action)
      // å­˜å‚¨åˆ°æœ¬åœ°å­˜å‚¨
      localStorage.setItem('pendingActions', JSON.stringify(pendingActions.value))
    }
  }
  
  const syncPendingActions = async () => {
    if (!isOnline.value || pendingActions.value.length === 0) return
    
    for (const action of pendingActions.value) {
      try {
        await executeAction(action)
        // ç§»é™¤å·²æˆåŠŸæ‰§è¡Œçš„åŠ¨ä½œ
        const index = pendingActions.value.indexOf(action)
        pendingActions.value.splice(index, 1)
      } catch (error) {
        console.error('Failed to sync action:', action, error)
      }
    }
    
    // æ›´æ–°æœ¬åœ°å­˜å‚¨
    localStorage.setItem('pendingActions', JSON.stringify(pendingActions.value))
  }
  
  return {
    isOnline: readonly(isOnline),
    addPendingAction,
    syncPendingActions
  }
}
```

## 5. ç»„ä»¶æ¶æ„

### 5.1 ç»„ä»¶åˆ†å±‚è®¾è®¡

```mermaid
graph TB
    subgraph "é¡µé¢å±‚ (Pages)"
        A1[Dashboard]
        A2[DeviceControl]
        A3[FamilyManagement]
        A4[Settings]
    end
    
    subgraph "ä¸šåŠ¡ç»„ä»¶å±‚ (Business Components)"
        B1[DeviceCard]
        B2[RoomPanel]
        B3[PermissionMatrix]
        B4[VoiceInterface]
    end
    
    subgraph "é€šç”¨ç»„ä»¶å±‚ (Common Components)"
        C1[HButton]
        C2[HModal]
        C3[HForm]
        C4[HChart]
    end
    
    subgraph "åŸºç¡€ç»„ä»¶å±‚ (Base Components)"
        D1[Ant Design Vue]
        D2[è‡ªå®šä¹‰åŸºç¡€ç»„ä»¶]
        D3[ç¬¬ä¸‰æ–¹ç»„ä»¶]
    end
    
    A1 --> B1
    A1 --> B2
    B1 --> C1
    B2 --> C2
    B3 --> C3
    C1 --> D1
    C2 --> D1
```

### 5.2 è®¾è®¡ç³»ç»Ÿè§„èŒƒ

#### 5.2.1 ç»„ä»¶å‘½åè§„èŒƒ

```typescript
// ç»„ä»¶å‘½åè§„èŒƒ
export interface ComponentNamingConvention {
  // é¡µé¢ç»„ä»¶ï¼šä»¥Viewç»“å°¾
  pages: 'DashboardView' | 'DeviceControlView' | 'SettingsView'
  
  // ä¸šåŠ¡ç»„ä»¶ï¼šä¸šåŠ¡å«ä¹‰æ˜ç¡®
  business: 'DeviceCard' | 'PermissionRing' | 'VoiceInterface'
  
  // é€šç”¨ç»„ä»¶ï¼šä»¥H(Haven)å‰ç¼€
  common: 'HButton' | 'HModal' | 'HForm' | 'HTable'
  
  // å¸ƒå±€ç»„ä»¶ï¼šä»¥Layoutç»“å°¾
  layout: 'AppLayout' | 'PageLayout' | 'CardLayout'
}
```

#### 5.2.2 æ ¸å¿ƒä¸šåŠ¡ç»„ä»¶

##### DeviceCardç»„ä»¶
```vue
<!-- components/business/DeviceCard.vue -->
<template>
  <div class="device-card" :class="deviceCardClasses">
    <!-- è®¾å¤‡çŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <div class="device-status">
      <DeviceStatusIndicator :status="device.status" />
      <span class="device-name">{{ device.name }}</span>
    </div>
    
    <!-- æƒé™ç¯æ˜¾ç¤º -->
    <PermissionRing
      :permission-level="userPermission"
      :device-type="device.type"
      :size="48"
      @click="handlePermissionClick"
    />
    
    <!-- è®¾å¤‡æ§åˆ¶åŒºåŸŸ -->
    <div class="device-controls">
      <slot name="controls" :device="device" :permission="userPermission">
        <HButton 
          v-if="canControl" 
          @click="toggleDevice"
          :loading="loading"
        >
          {{ device.isOn ? 'å…³é—­' : 'å¼€å¯' }}
        </HButton>
      </slot>
    </div>
    
    <!-- è®¾å¤‡è¯¦æƒ…é“¾æ¥ -->
    <div class="device-details">
      <HButton 
        type="link" 
        @click="$emit('view-details', device)"
      >
        è¯¦ç»†è®¾ç½®
      </HButton>
    </div>
  </div>
</template>

<script setup lang="ts">
interface Props {
  device: Device
  userPermission: number
  loading?: boolean
}

interface Emits {
  (e: 'toggle', device: Device): void
  (e: 'view-details', device: Device): void
  (e: 'permission-click', device: Device): void
}

const props = withDefaults(defineProps<Props>(), {
  loading: false
})

const emit = defineEmits<Emits>()

const deviceCardClasses = computed(() => ({
  'device-card--online': props.device.status === 'online',
  'device-card--offline': props.device.status === 'offline',
  'device-card--error': props.device.status === 'error'
}))

const canControl = computed(() => props.userPermission >= 3)

const toggleDevice = () => {
  emit('toggle', props.device)
}

const handlePermissionClick = () => {
  emit('permission-click', props.device)
}
</script>
```

##### PermissionRingç»„ä»¶
```vue
<!-- components/business/PermissionRing.vue -->
<template>
  <div class="permission-ring" :style="ringStyle">
    <svg :width="size" :height="size" class="permission-ring__svg">
      <!-- èƒŒæ™¯åœ†ç¯ -->
      <circle
        :cx="center"
        :cy="center"
        :r="radius"
        class="permission-ring__bg"
        :stroke-width="strokeWidth"
      />
      
      <!-- æƒé™è¿›åº¦åœ†ç¯ -->
      <circle
        :cx="center"
        :cy="center"
        :r="radius"
        class="permission-ring__progress"
        :stroke-width="strokeWidth"
        :stroke-dasharray="circumference"
        :stroke-dashoffset="dashOffset"
        :style="progressStyle"
      />
      
      <!-- å†²çªæŒ‡ç¤ºå™¨ -->
      <circle
        v-if="hasConflict"
        :cx="center"
        :cy="center"
        :r="radius + 4"
        class="permission-ring__conflict"
        :stroke-width="2"
      />
    </svg>
    
    <!-- ä¸­å¿ƒå†…å®¹ -->
    <div class="permission-ring__content">
      <Icon :name="deviceIcon" :size="size * 0.4" />
    </div>
  </div>
</template>

<script setup lang="ts">
interface Props {
  permissionLevel: number // 0-5æƒé™ç­‰çº§
  deviceType: string
  size?: number
  hasConflict?: boolean
  interactive?: boolean
}

const props = withDefaults(defineProps<Props>(), {
  size: 48,
  hasConflict: false,
  interactive: false
})

const center = computed(() => props.size / 2)
const radius = computed(() => (props.size - 8) / 2)
const strokeWidth = computed(() => Math.max(2, props.size / 12))
const circumference = computed(() => 2 * Math.PI * radius.value)
const dashOffset = computed(() => 
  circumference.value * (1 - props.permissionLevel / 5)
)

const deviceIcon = computed(() => {
  const iconMap: Record<string, string> = {
    lighting: 'bulb',
    climate: 'temperature',
    security: 'lock',
    entertainment: 'play-circle'
  }
  return iconMap[props.deviceType] || 'device'
})

const progressStyle = computed(() => ({
  stroke: getPermissionColor(props.permissionLevel),
  transition: 'stroke-dashoffset 0.3s ease'
}))

const ringStyle = computed(() => ({
  cursor: props.interactive ? 'pointer' : 'default'
}))

function getPermissionColor(level: number): string {
  const colors = [
    '#d9d9d9', // æ— æƒé™
    '#fa8c16', // ç´§æ€¥æƒé™
    '#fadb14', // æŸ¥çœ‹æƒé™
    '#1890ff', // åŸºç¡€æƒé™
    '#52c41a', // é«˜çº§æƒé™
    '#13c2c2'  // å®Œå…¨æƒé™
  ]
  return colors[level] || colors[0]
}
</script>
```

##### VoiceInterfaceç»„ä»¶
```vue
<!-- components/business/VoiceInterface.vue -->
<template>
  <div class="voice-interface" :class="voiceInterfaceClasses">
    <!-- è¯­éŸ³çŠ¶æ€æ˜¾ç¤º -->
    <div class="voice-status">
      <div class="voice-wave" v-show="isListening">
        <div 
          v-for="i in 5" 
          :key="i" 
          class="voice-wave__bar"
          :style="{ animationDelay: `${i * 0.1}s` }"
        />
      </div>
      
      <div class="voice-text" v-show="recognizedText">
        <span class="voice-text__content">{{ recognizedText }}</span>
        <Icon name="check-circle" v-if="isRecognized" class="voice-text__check" />
      </div>
    </div>
    
    <!-- è¯­éŸ³æ§åˆ¶æŒ‰é’® -->
    <div class="voice-controls">
      <HButton
        type="primary"
        shape="circle"
        :size="buttonSize"
        :loading="isProcessing"
        @mousedown="startListening"
        @mouseup="stopListening"
        @mouseleave="stopListening"
        class="voice-button"
      >
        <Icon name="microphone" />
      </HButton>
      
      <HButton
        type="default"
        @click="showTextInput = true"
        class="text-input-button"
      >
        <Icon name="keyboard" />
        æ–‡å­—è¾“å…¥
      </HButton>
    </div>
    
    <!-- è¯­éŸ³å»ºè®® -->
    <div class="voice-suggestions" v-if="suggestions.length">
      <div class="voice-suggestions__title">ğŸ’¡ æ‚¨å¯ä»¥è¿™æ ·è¯´ï¼š</div>
      <ul class="voice-suggestions__list">
        <li 
          v-for="suggestion in suggestions" 
          :key="suggestion"
          @click="$emit('text-command', suggestion)"
          class="voice-suggestions__item"
        >
          "{{ suggestion }}"
        </li>
      </ul>
    </div>
    
    <!-- æ–‡å­—è¾“å…¥æ¨¡æ€æ¡† -->
    <HModal
      v-model:visible="showTextInput"
      title="æ–‡å­—è¾“å…¥"
      @ok="handleTextCommand"
    >
      <HInput
        v-model:value="textCommand"
        placeholder="è¯·è¾“å…¥æŒ‡ä»¤"
        @press-enter="handleTextCommand"
      />
    </HModal>
  </div>
</template>

<script setup lang="ts">
interface Props {
  suggestions?: string[]
  size?: 'small' | 'default' | 'large'
}

interface Emits {
  (e: 'voice-command', command: string): void
  (e: 'text-command', command: string): void
}

const props = withDefaults(defineProps<Props>(), {
  suggestions: () => [
    'è°ƒèŠ‚å®¢å…æ¸©åº¦åˆ°25åº¦',
    'æ‰“å¼€æ‰€æœ‰ç¯å…‰',
    'æ’­æ”¾è½»éŸ³ä¹',
    'åˆ‡æ¢åˆ°ç¡è§‰æ¨¡å¼'
  ],
  size: 'default'
})

const emit = defineEmits<Emits>()

const isListening = ref(false)
const isProcessing = ref(false)
const isRecognized = ref(false)
const recognizedText = ref('')
const showTextInput = ref(false)
const textCommand = ref('')

const voiceInterfaceClasses = computed(() => ({
  'voice-interface--listening': isListening.value,
  'voice-interface--processing': isProcessing.value,
  [`voice-interface--${props.size}`]: true
}))

const buttonSize = computed(() => {
  const sizeMap = { small: 'small', default: 'large', large: 64 }
  return sizeMap[props.size]
})

let recognition: SpeechRecognition | null = null

onMounted(() => {
  if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition
    recognition = new SpeechRecognition()
    recognition.continuous = false
    recognition.interimResults = true
    recognition.lang = 'zh-CN'
    
    recognition.onstart = () => {
      isListening.value = true
    }
    
    recognition.onresult = (event) => {
      const result = event.results[event.results.length - 1]
      recognizedText.value = result[0].transcript
      
      if (result.isFinal) {
        isRecognized.value = true
        emit('voice-command', recognizedText.value)
      }
    }
    
    recognition.onend = () => {
      isListening.value = false
      isProcessing.value = false
    }
    
    recognition.onerror = (event) => {
      console.error('è¯­éŸ³è¯†åˆ«é”™è¯¯:', event.error)
      isListening.value = false
      isProcessing.value = false
    }
  }
})

const startListening = () => {
  if (recognition && !isListening.value) {
    recognizedText.value = ''
    isRecognized.value = false
    recognition.start()
  }
}

const stopListening = () => {
  if (recognition && isListening.value) {
    recognition.stop()
  }
}

const handleTextCommand = () => {
  if (textCommand.value.trim()) {
    emit('text-command', textCommand.value)
    textCommand.value = ''
    showTextInput.value = false
  }
}
</script>
```

### 5.3 ç»„ä»¶é€šä¿¡æ¨¡å¼

#### 5.3.1 çˆ¶å­ç»„ä»¶é€šä¿¡
- **Props Down, Events Up**ï¼šæ ‡å‡†çš„Vueç»„ä»¶é€šä¿¡æ¨¡å¼
- **v-modelåŒå‘ç»‘å®š**ï¼šè¡¨å•ç»„ä»¶ä½¿ç”¨v-modelç®€åŒ–æ•°æ®ç»‘å®š
- **Slotsæ’æ§½**ï¼šæä¾›ç»„ä»¶å†…å®¹å®šåˆ¶èƒ½åŠ›

#### 5.3.2 è·¨å±‚çº§ç»„ä»¶é€šä¿¡
- **Provide/Inject**ï¼šä¾èµ–æ³¨å…¥æ¨¡å¼ï¼Œé€‚ç”¨äºæ·±å±‚ç»„ä»¶é€šä¿¡
- **Event Bus**ï¼šå…¨å±€äº‹ä»¶æ€»çº¿ï¼Œç”¨äºç´§æ€¥äº‹ä»¶å¹¿æ’­
- **Pinia Store**ï¼šçŠ¶æ€ç®¡ç†ï¼Œé€‚ç”¨äºå…±äº«çŠ¶æ€

#### 5.3.3 ç»„ä»¶é—´æ¾è€¦åˆè®¾è®¡
```typescript
// composables/useComponentCommunication.ts
export function useComponentCommunication() {
  // äº‹ä»¶æ€»çº¿
  const eventBus = new EventTarget()
  
  const emit = (type: string, detail?: any) => {
    eventBus.dispatchEvent(new CustomEvent(type, { detail }))
  }
  
  const on = (type: string, listener: EventListener) => {
    eventBus.addEventListener(type, listener)
  }
  
  const off = (type: string, listener: EventListener) => {
    eventBus.removeEventListener(type, listener)
  }
  
  return { emit, on, off }
}

// ç»„ä»¶ä¸­ä½¿ç”¨
export default defineComponent({
  setup() {
    const { emit, on, off } = useComponentCommunication()
    
    // å‘é€äº‹ä»¶
    const sendNotification = (message: string) => {
      emit('global-notification', { message, type: 'success' })
    }
    
    // ç›‘å¬äº‹ä»¶
    onMounted(() => {
      on('device-status-changed', handleDeviceStatusChange)
    })
    
    onUnmounted(() => {
      off('device-status-changed', handleDeviceStatusChange)
    })
    
    return { sendNotification }
  }
})
```

## 6. è·¯ç”±è®¾è®¡

### 6.1 è·¯ç”±æ¶æ„

```mermaid
graph TB
    A[App Root] --> B[Layout]
    B --> C[Dashboard]
    B --> D[DeviceControl]
    B --> E[FamilyManagement]
    B --> F[Settings]
    
    D --> D1[RoomView/:roomId]
    D --> D2[DeviceDetail/:deviceId]
    D --> D3[SceneManagement]
    
    E --> E1[MemberList]
    E --> E2[PermissionMatrix]
    E --> E3[GuestManagement]
    
    F --> F1[PersonalSettings]
    F --> F2[SystemSettings]
    F --> F3[SecuritySettings]
```

### 6.2 è·¯ç”±é…ç½®

```typescript
// router/index.ts
import { createRouter, createWebHistory } from 'vue-router'
import { useUserStore } from '@/stores/user'
import type { RouteRecordRaw } from 'vue-router'

const routes: RouteRecordRaw[] = [
  {
    path: '/',
    name: 'Root',
    redirect: '/dashboard'
  },
  {
    path: '/login',
    name: 'Login',
    component: () => import('@/views/auth/LoginView.vue'),
    meta: { requiresAuth: false, layout: 'AuthLayout' }
  },
  {
    path: '/dashboard',
    name: 'Dashboard',
    component: () => import('@/views/DashboardView.vue'),
    meta: { 
      requiresAuth: true, 
      title: 'æ™ºèƒ½å®¶åº­æ§åˆ¶å°',
      icon: 'home'
    }
  },
  {
    path: '/devices',
    name: 'DeviceControl',
    component: () => import('@/views/device/DeviceControlView.vue'),
    meta: { 
      requiresAuth: true, 
      title: 'è®¾å¤‡æ§åˆ¶',
      icon: 'control'
    },
    children: [
      {
        path: 'rooms/:roomId',
        name: 'RoomView',
        component: () => import('@/views/device/RoomView.vue'),
        meta: { title: 'æˆ¿é—´æ§åˆ¶' }
      },
      {
        path: 'detail/:deviceId',
        name: 'DeviceDetail',
        component: () => import('@/views/device/DeviceDetailView.vue'),
        meta: { title: 'è®¾å¤‡è¯¦æƒ…' }
      },
      {
        path: 'scenes',
        name: 'SceneManagement',
        component: () => import('@/views/device/SceneManagementView.vue'),
        meta: { title: 'åœºæ™¯ç®¡ç†' }
      }
    ]
  },
  {
    path: '/family',
    name: 'FamilyManagement',
    component: () => import('@/views/family/FamilyManagementView.vue'),
    meta: { 
      requiresAuth: true,
      title: 'å®¶åº­ç®¡ç†',
      icon: 'team',
      requiredPermission: 'family.manage'
    },
    children: [
      {
        path: 'members',
        name: 'MemberList',
        component: () => import('@/views/family/MemberListView.vue'),
        meta: { title: 'æˆå‘˜ç®¡ç†' }
      },
      {
        path: 'permissions',
        name: 'PermissionMatrix',
        component: () => import('@/views/family/PermissionMatrixView.vue'),
        meta: { title: 'æƒé™ç®¡ç†' }
      },
      {
        path: 'guests',
        name: 'GuestManagement',
        component: () => import('@/views/family/GuestManagementView.vue'),
        meta: { title: 'è®¿å®¢ç®¡ç†' }
      }
    ]
  },
  {
    path: '/messages',
    name: 'MessageCenter',
    component: () => import('@/views/MessageCenterView.vue'),
    meta: { 
      requiresAuth: true,
      title: 'æ¶ˆæ¯ä¸­å¿ƒ',
      icon: 'message'
    }
  },
  {
    path: '/settings',
    name: 'Settings',
    component: () => import('@/views/settings/SettingsView.vue'),
    meta: { 
      requiresAuth: true,
      title: 'è®¾ç½®',
      icon: 'setting'
    },
    children: [
      {
        path: 'personal',
        name: 'PersonalSettings',
        component: () => import('@/views/settings/PersonalSettingsView.vue'),
        meta: { title: 'ä¸ªäººè®¾ç½®' }
      },
      {
        path: 'system',
        name: 'SystemSettings',
        component: () => import('@/views/settings/SystemSettingsView.vue'),
        meta: { 
          title: 'ç³»ç»Ÿè®¾ç½®',
          requiredPermission: 'system.manage'
        }
      },
      {
        path: 'security',
        name: 'SecuritySettings',
        component: () => import('@/views/settings/SecuritySettingsView.vue'),
        meta: { 
          title: 'å®‰å…¨è®¾ç½®',
          requiredPermission: 'security.manage'
        }
      }
    ]
  },
  // ç´§æ€¥æ¨¡å¼è·¯ç”±
  {
    path: '/emergency',
    name: 'Emergency',
    component: () => import('@/views/EmergencyView.vue'),
    meta: { 
      requiresAuth: true,
      layout: 'EmergencyLayout',
      title: 'ç´§æ€¥æ¨¡å¼',
      priority: 'high'
    }
  },
  // 404é¡µé¢
  {
    path: '/:pathMatch(.*)*',
    name: 'NotFound',
    component: () => import('@/views/error/NotFoundView.vue'),
    meta: { layout: 'ErrorLayout' }
  }
]

const router = createRouter({
  history: createWebHistory(import.meta.env.BASE_URL),
  routes,
  scrollBehavior(to, from, savedPosition) {
    if (savedPosition) {
      return savedPosition
    } else {
      return { top: 0 }
    }
  }
})

// å…¨å±€è·¯ç”±å®ˆå«
router.beforeEach(async (to, from) => {
  const userStore = useUserStore()
  
  // èº«ä»½éªŒè¯æ£€æŸ¥
  if (to.meta.requiresAuth && !userStore.isAuthenticated) {
    return { name: 'Login', query: { redirect: to.fullPath } }
  }
  
  // æƒé™æ£€æŸ¥
  if (to.meta.requiredPermission && !userStore.hasPermission(to.meta.requiredPermission)) {
    throw new Error('æ²¡æœ‰è®¿é—®æƒé™')
  }
  
  // ç´§æ€¥æ¨¡å¼æ£€æŸ¥
  if (userStore.isEmergencyMode && to.name !== 'Emergency') {
    return { name: 'Emergency' }
  }
  
  // è®¾ç½®é¡µé¢æ ‡é¢˜
  if (to.meta.title) {
    document.title = `${to.meta.title} - HavenButler`
  }
  
  return true
})

export default router
```

### 6.3 åŠ¨æ€è·¯ç”±ä¸æƒé™æ§åˆ¶

```typescript
// router/permission.ts
export interface RoutePermission {
  path: string
  roles: string[]
  permissions: string[]
  condition?: (user: User) => boolean
}

export const routePermissions: RoutePermission[] = [
  {
    path: '/family',
    roles: ['admin', 'manager'],
    permissions: ['family.manage'],
    condition: (user) => user.familyRole !== 'guest'
  },
  {
    path: '/settings/system',
    roles: ['admin'],
    permissions: ['system.manage'],
    condition: (user) => user.isSystemAdmin
  }
]

// åŠ¨æ€è·¯ç”±ç”Ÿæˆ
export function generateDynamicRoutes(user: User): RouteRecordRaw[] {
  return routePermissions
    .filter(rp => checkRoutePermission(rp, user))
    .map(rp => createRouteFromPermission(rp))
}

function checkRoutePermission(routePermission: RoutePermission, user: User): boolean {
  // æ£€æŸ¥è§’è‰²
  if (routePermission.roles.length > 0 && 
      !routePermission.roles.includes(user.role)) {
    return false
  }
  
  // æ£€æŸ¥æƒé™
  if (routePermission.permissions.length > 0 &&
      !routePermission.permissions.every(p => user.permissions.includes(p))) {
    return false
  }
  
  // æ£€æŸ¥è‡ªå®šä¹‰æ¡ä»¶
  if (routePermission.condition && !routePermission.condition(user)) {
    return false
  }
  
  return true
}
```

### 6.4 è·¯ç”±æ‡’åŠ è½½ä¸é¢„åŠ è½½

```typescript
// router/lazy-loading.ts
export const lazyLoad = (componentName: string) => {
  return defineAsyncComponent({
    loader: () => import(`@/views/${componentName}.vue`),
    loadingComponent: () => import('@/components/common/Loading.vue'),
    errorComponent: () => import('@/components/common/LoadError.vue'),
    delay: 200,
    timeout: 3000
  })
}

// é¢„åŠ è½½ç­–ç•¥
export function preloadRoutes() {
  const routes = [
    'DashboardView',
    'device/DeviceControlView',
    'MessageCenterView'
  ]
  
  // ç©ºé—²æ—¶é¢„åŠ è½½æ ¸å¿ƒè·¯ç”±
  if ('requestIdleCallback' in window) {
    window.requestIdleCallback(() => {
      routes.forEach(route => {
        import(`@/views/${route}.vue`)
      })
    })
  }
}
```

## 7. çŠ¶æ€ç®¡ç†

### 7.1 Pinia Storeè®¾è®¡

#### 7.1.1 Storeç»“æ„

```typescript
// stores/types.ts - çŠ¶æ€ç®¡ç†ç±»å‹å®šä¹‰
export interface StoreState {
  loading: boolean
  error: string | null
  lastUpdated: number
}

export interface DeviceState extends StoreState {
  devices: Device[]
  rooms: Room[]
  scenes: Scene[]
  activeDevice: Device | null
  deviceStatuses: Record<string, DeviceStatus>
  controlHistory: DeviceControlRecord[]
}

export interface UserState extends StoreState {
  currentUser: User | null
  familyMembers: FamilyMember[]
  preferences: UserPreferences
  isAuthenticated: boolean
  authToken: string | null
  refreshToken: string | null
}

export interface PermissionState extends StoreState {
  userPermissions: UserPermission[]
  devicePermissions: Record<string, DevicePermission[]>
  pendingRequests: PermissionRequest[]
  permissionMatrix: PermissionMatrix
  conflictResolution: ConflictResolution[]
}
```

#### 7.1.2 è®¾å¤‡çŠ¶æ€ç®¡ç†Store

```typescript
// stores/device.ts
export const useDeviceStore = defineStore('device', () => {
  // State
  const state = reactive<DeviceState>({
    devices: [],
    rooms: [],
    scenes: [],
    activeDevice: null,
    deviceStatuses: {},
    controlHistory: [],
    loading: false,
    error: null,
    lastUpdated: 0
  })
  
  // Getters
  const devicesByRoom = computed(() => {
    return state.devices.reduce((acc, device) => {
      const roomId = device.roomId
      if (!acc[roomId]) acc[roomId] = []
      acc[roomId].push(device)
      return acc
    }, {} as Record<string, Device[]>)
  })
  
  const onlineDeviceCount = computed(() => {
    return state.devices.filter(device => 
      state.deviceStatuses[device.id]?.status === 'online'
    ).length
  })
  
  const devicesByType = computed(() => {
    return groupBy(state.devices, 'type')
  })
  
  // Actions
  const fetchDevices = async () => {
    state.loading = true
    state.error = null
    
    try {
      const response = await deviceService.getDevices()
      state.devices = response.data
      state.lastUpdated = Date.now()
    } catch (error) {
      state.error = error.message
      throw error
    } finally {
      state.loading = false
    }
  }
  
  const controlDevice = async (deviceId: string, command: DeviceCommand) => {
    const device = state.devices.find(d => d.id === deviceId)
    if (!device) throw new Error('è®¾å¤‡ä¸å­˜åœ¨')
    
    // æƒé™æ£€æŸ¥
    const permissionStore = usePermissionStore()
    if (!permissionStore.canControlDevice(deviceId)) {
      throw new Error('æ²¡æœ‰æ§åˆ¶æƒé™')
    }
    
    state.loading = true
    
    try {
      // ä¹è§‚æ›´æ–°
      updateDeviceStatusOptimistic(device, command)
      
      // å‘é€æ§åˆ¶æŒ‡ä»¤
      const result = await deviceService.controlDevice(deviceId, command)
      
      // æ›´æ–°è®¾å¤‡çŠ¶æ€
      updateDeviceStatus(deviceId, result.status)
      
      // è®°å½•æ§åˆ¶å†å²
      addControlHistory({
        deviceId,
        command,
        timestamp: Date.now(),
        userId: useUserStore().currentUser?.id,
        success: true
      })
      
    } catch (error) {
      // å›æ»šä¹è§‚æ›´æ–°
      revertDeviceStatus(deviceId)
      
      // è®°å½•å¤±è´¥å†å²
      addControlHistory({
        deviceId,
        command,
        timestamp: Date.now(),
        userId: useUserStore().currentUser?.id,
        success: false,
        error: error.message
      })
      
      throw error
    } finally {
      state.loading = false
    }
  }
  
  const updateDeviceStatus = (deviceId: string, status: DeviceStatus) => {
    state.deviceStatuses[deviceId] = {
      ...state.deviceStatuses[deviceId],
      ...status,
      lastUpdated: Date.now()
    }
  }
  
  const addDevice = async (deviceData: CreateDeviceRequest) => {
    state.loading = true
    
    try {
      const newDevice = await deviceService.addDevice(deviceData)
      state.devices.push(newDevice)
      
      // åˆå§‹åŒ–è®¾å¤‡çŠ¶æ€
      state.deviceStatuses[newDevice.id] = {
        status: 'offline',
        lastSeen: Date.now(),
        lastUpdated: Date.now()
      }
      
    } catch (error) {
      state.error = error.message
      throw error
    } finally {
      state.loading = false
    }
  }
  
  const removeDevice = async (deviceId: string) => {
    const index = state.devices.findIndex(d => d.id === deviceId)
    if (index === -1) return
    
    state.loading = true
    
    try {
      await deviceService.removeDevice(deviceId)
      
      // ç§»é™¤è®¾å¤‡å’Œç›¸å…³çŠ¶æ€
      state.devices.splice(index, 1)
      delete state.deviceStatuses[deviceId]
      
      // ç§»é™¤ç›¸å…³æƒé™
      const permissionStore = usePermissionStore()
      permissionStore.removeDevicePermissions(deviceId)
      
    } catch (error) {
      state.error = error.message
      throw error
    } finally {
      state.loading = false
    }
  }
  
  // è¾…åŠ©å‡½æ•°
  const updateDeviceStatusOptimistic = (device: Device, command: DeviceCommand) => {
    const currentStatus = state.deviceStatuses[device.id]
    const newStatus = predictDeviceStatus(currentStatus, command)
    updateDeviceStatus(device.id, newStatus)
  }
  
  const revertDeviceStatus = (deviceId: string) => {
    // è¿™é‡Œå¯ä»¥å®ç°æ›´å¤æ‚çš„å›æ»šé€»è¾‘
    // ä¾‹å¦‚ä»å†å²çŠ¶æ€ä¸­æ¢å¤æˆ–é‡æ–°è·å–æœåŠ¡å™¨çŠ¶æ€
    fetchDeviceStatus(deviceId)
  }
  
  const addControlHistory = (record: DeviceControlRecord) => {
    state.controlHistory.unshift(record)
    
    // é™åˆ¶å†å²è®°å½•æ•°é‡
    if (state.controlHistory.length > 1000) {
      state.controlHistory = state.controlHistory.slice(0, 1000)
    }
  }
  
  // WebSocketäº‹ä»¶å¤„ç†
  const handleDeviceStatusUpdate = (update: DeviceStatusUpdate) => {
    updateDeviceStatus(update.deviceId, update.status)
    
    // é€šçŸ¥å…¶ä»–ç»„ä»¶
    const { emit } = useComponentCommunication()
    emit('device-status-changed', { deviceId: update.deviceId, status: update.status })
  }
  
  // è¿”å›å…¬å¼€æ¥å£
  return {
    // State
    devices: readonly(toRef(state, 'devices')),
    rooms: readonly(toRef(state, 'rooms')),
    scenes: readonly(toRef(state, 'scenes')),
    activeDevice: readonly(toRef(state, 'activeDevice')),
    deviceStatuses: readonly(toRef(state, 'deviceStatuses')),
    loading: readonly(toRef(state, 'loading')),
    error: readonly(toRef(state, 'error')),
    
    // Getters
    devicesByRoom,
    onlineDeviceCount,
    devicesByType,
    
    // Actions
    fetchDevices,
    controlDevice,
    updateDeviceStatus,
    addDevice,
    removeDevice,
    handleDeviceStatusUpdate
  }
})
```

#### 7.1.3 æƒé™ç®¡ç†Store

```typescript
// stores/permission.ts
export const usePermissionStore = defineStore('permission', () => {
  const state = reactive<PermissionState>({
    userPermissions: [],
    devicePermissions: {},
    pendingRequests: [],
    permissionMatrix: {},
    conflictResolution: [],
    loading: false,
    error: null,
    lastUpdated: 0
  })
  
  // Getters
  const canControlDevice = (deviceId: string) => {
    return (userId?: string) => {
      const userStore = useUserStore()
      const currentUserId = userId || userStore.currentUser?.id
      
      if (!currentUserId) return false
      
      const permissions = state.devicePermissions[deviceId] || []
      const userPermission = permissions.find(p => p.userId === currentUserId)
      
      // æƒé™ç­‰çº§ï¼š0-æ— æƒé™ï¼Œ1-ç´§æ€¥æƒé™ï¼Œ2-æŸ¥çœ‹æƒé™ï¼Œ3-åŸºç¡€æƒé™ï¼Œ4-é«˜çº§æƒé™ï¼Œ5-å®Œå…¨æƒé™
      return (userPermission?.level || 0) >= 3
    }
  }
  
  const getPermissionLevel = (deviceId: string, userId?: string) => {
    const userStore = useUserStore()
    const currentUserId = userId || userStore.currentUser?.id
    
    if (!currentUserId) return 0
    
    const permissions = state.devicePermissions[deviceId] || []
    const userPermission = permissions.find(p => p.userId === currentUserId)
    
    return userPermission?.level || 0
  }
  
  const hasPermissionConflict = (deviceId: string) => {
    const permissions = state.devicePermissions[deviceId] || []
    const activeUsers = permissions.filter(p => p.isActive && p.level >= 3)
    
    return activeUsers.length > 1
  }
  
  const getPendingRequestsCount = computed(() => state.pendingRequests.length)
  
  // Actions
  const requestPermission = async (request: PermissionRequest) => {
    state.loading = true
    
    try {
      // æ·»åŠ åˆ°å¾…å¤„ç†è¯·æ±‚
      state.pendingRequests.push({
        ...request,
        id: generateId(),
        timestamp: Date.now(),
        status: 'pending'
      })
      
      // å‘é€æƒé™ç”³è¯·
      await permissionService.requestPermission(request)
      
      // é€šçŸ¥ç›¸å…³ç®¡ç†å‘˜
      const messageStore = useMessageStore()
      messageStore.addNotification({
        type: 'permission_request',
        title: 'æƒé™ç”³è¯·',
        content: `${request.userName}ç”³è¯·${request.deviceName}çš„æ§åˆ¶æƒé™`,
        priority: 'normal',
        recipients: request.approvers
      })
      
    } catch (error) {
      state.error = error.message
      throw error
    } finally {
      state.loading = false
    }
  }
  
  const approvePermissionRequest = async (requestId: string, approval: PermissionApproval) => {
    const request = state.pendingRequests.find(r => r.id === requestId)
    if (!request) throw new Error('æƒé™ç”³è¯·ä¸å­˜åœ¨')
    
    state.loading = true
    
    try {
      // å‘é€å®¡æ‰¹ç»“æœ
      await permissionService.approvePermissionRequest(requestId, approval)
      
      if (approval.approved) {
        // æ›´æ–°è®¾å¤‡æƒé™
        if (!state.devicePermissions[request.deviceId]) {
          state.devicePermissions[request.deviceId] = []
        }
        
        state.devicePermissions[request.deviceId].push({
          userId: request.userId,
          deviceId: request.deviceId,
          level: approval.permissionLevel,
          expiresAt: approval.expiresAt,
          isActive: true,
          grantedBy: useUserStore().currentUser?.id,
          grantedAt: Date.now()
        })
      }
      
      // ç§»é™¤å¾…å¤„ç†è¯·æ±‚
      const index = state.pendingRequests.findIndex(r => r.id === requestId)
      if (index !== -1) {
        state.pendingRequests.splice(index, 1)
      }
      
      // é€šçŸ¥ç”³è¯·äºº
      const messageStore = useMessageStore()
      messageStore.addNotification({
        type: 'permission_response',
        title: approval.approved ? 'æƒé™ç”³è¯·å·²æ‰¹å‡†' : 'æƒé™ç”³è¯·è¢«æ‹’ç»',
        content: approval.reason || 'æ— ',
        priority: 'normal',
        recipients: [request.userId]
      })
      
    } catch (error) {
      state.error = error.message
      throw error
    } finally {
      state.loading = false
    }
  }
  
  const revokePermission = async (deviceId: string, userId: string) => {
    state.loading = true
    
    try {
      await permissionService.revokePermission(deviceId, userId)
      
      // æ›´æ–°æœ¬åœ°çŠ¶æ€
      const permissions = state.devicePermissions[deviceId] || []
      const index = permissions.findIndex(p => p.userId === userId)
      
      if (index !== -1) {
        permissions.splice(index, 1)
      }
      
    } catch (error) {
      state.error = error.message
      throw error
    } finally {
      state.loading = false
    }
  }
  
  const resolvePermissionConflict = async (deviceId: string, resolution: ConflictResolution) => {
    state.loading = true
    
    try {
      await permissionService.resolveConflict(deviceId, resolution)
      
      // æ›´æ–°å†²çªè§£å†³æ–¹æ¡ˆ
      state.conflictResolution.push({
        ...resolution,
        deviceId,
        timestamp: Date.now(),
        resolvedBy: useUserStore().currentUser?.id
      })
      
      // æ ¹æ®è§£å†³æ–¹æ¡ˆæ›´æ–°æƒé™
      applyConflictResolution(deviceId, resolution)
      
    } catch (error) {
      state.error = error.message
      throw error
    } finally {
      state.loading = false
    }
  }
  
  // è¾…åŠ©å‡½æ•°
  const applyConflictResolution = (deviceId: string, resolution: ConflictResolution) => {
    const permissions = state.devicePermissions[deviceId] || []
    
    switch (resolution.strategy) {
      case 'priority_based':
        // åŸºäºä¼˜å…ˆçº§çš„è§£å†³æ–¹æ¡ˆ
        permissions.forEach(p => {
          p.isActive = p.userId === resolution.priorityUserId
        })
        break
        
      case 'time_sharing':
        // æ—¶é—´åˆ†ç‰‡è§£å†³æ–¹æ¡ˆ
        permissions.forEach(p => {
          const timeSlot = resolution.timeSlots?.find(ts => ts.userId === p.userId)
          p.isActive = timeSlot ? isInTimeSlot(timeSlot) : false
        })
        break
        
      case 'voting':
        // æŠ•ç¥¨è§£å†³æ–¹æ¡ˆ
        permissions.forEach(p => {
          p.isActive = resolution.votingResult?.winnerIds.includes(p.userId) || false
        })
        break
    }
  }
  
  const isInTimeSlot = (timeSlot: TimeSlot): boolean => {
    const now = new Date()
    const currentTime = now.getHours() * 60 + now.getMinutes()
    const slotStart = parseTime(timeSlot.startTime)
    const slotEnd = parseTime(timeSlot.endTime)
    
    return currentTime >= slotStart && currentTime < slotEnd
  }
  
  return {
    // State
    userPermissions: readonly(toRef(state, 'userPermissions')),
    devicePermissions: readonly(toRef(state, 'devicePermissions')),
    pendingRequests: readonly(toRef(state, 'pendingRequests')),
    loading: readonly(toRef(state, 'loading')),
    error: readonly(toRef(state, 'error')),
    
    // Getters
    canControlDevice,
    getPermissionLevel,
    hasPermissionConflict,
    getPendingRequestsCount,
    
    // Actions
    requestPermission,
    approvePermissionRequest,
    revokePermission,
    resolvePermissionConflict
  }
})
```

### 7.2 çŠ¶æ€æŒä¹…åŒ–

```typescript
// plugins/persistence.ts
export function createPersistedState(key: string, paths?: string[]) {
  return {
    beforeCreate() {
      // ä»localStorageæ¢å¤çŠ¶æ€
      const saved = localStorage.getItem(key)
      if (saved) {
        try {
          const parsed = JSON.parse(saved)
          if (paths) {
            // åªæ¢å¤æŒ‡å®šè·¯å¾„çš„çŠ¶æ€
            paths.forEach(path => {
              set(this.$state, path, get(parsed, path))
            })
          } else {
            // æ¢å¤æ•´ä¸ªçŠ¶æ€
            Object.assign(this.$state, parsed)
          }
        } catch (error) {
          console.warn(`Failed to restore state for ${key}:`, error)
        }
      }
    },
    
    afterCreate() {
      // ç›‘å¬çŠ¶æ€å˜åŒ–å¹¶ä¿å­˜
      this.$subscribe((mutation, state) => {
        try {
          let dataToSave = state
          
          // åªä¿å­˜æŒ‡å®šè·¯å¾„çš„çŠ¶æ€
          if (paths) {
            dataToSave = {}
            paths.forEach(path => {
              set(dataToSave, path, get(state, path))
            })
          }
          
          localStorage.setItem(key, JSON.stringify(dataToSave))
        } catch (error) {
          console.warn(`Failed to persist state for ${key}:`, error)
        }
      }, { detached: true })
    }
  }
}

// åœ¨storeä¸­ä½¿ç”¨
export const useUserStore = defineStore('user', () => {
  // ... store implementation
}, {
  // æŒä¹…åŒ–é…ç½®
  persist: createPersistedState('user-store', [
    'preferences',
    'authToken',
    'refreshToken'
  ])
})
```

### 7.3 çŠ¶æ€åŒæ­¥ä¸ä¸€è‡´æ€§

```typescript
// composables/useStateSync.ts
export function useStateSync() {
  const syncStore = reactive({
    lastSyncTime: 0,
    syncInProgress: false,
    conflictResolution: 'server-wins' as 'server-wins' | 'client-wins' | 'manual'
  })
  
  const syncWithServer = async () => {
    if (syncStore.syncInProgress) return
    
    syncStore.syncInProgress = true
    
    try {
      // è·å–æ‰€æœ‰storeçš„çŠ¶æ€
      const stores = {
        device: useDeviceStore(),
        user: useUserStore(),
        permission: usePermissionStore()
      }
      
      // æ„å»ºåŒæ­¥è¯·æ±‚
      const syncRequest = {
        lastSyncTime: syncStore.lastSyncTime,
        clientState: extractSyncableState(stores),
        conflicts: []
      }
      
      // å‘é€åŒæ­¥è¯·æ±‚
      const syncResponse = await apiClient.post('/sync', syncRequest)
      
      // å¤„ç†åŒæ­¥å“åº”
      await applySyncResponse(stores, syncResponse.data)
      
      syncStore.lastSyncTime = Date.now()
      
    } catch (error) {
      console.error('State sync failed:', error)
      throw error
    } finally {
      syncStore.syncInProgress = false
    }
  }
  
  const extractSyncableState = (stores: any) => {
    return {
      devices: stores.device.devices,
      userPermissions: stores.permission.userPermissions,
      preferences: stores.user.preferences
    }
  }
  
  const applySyncResponse = async (stores: any, syncData: SyncResponse) => {
    // å¤„ç†è®¾å¤‡çŠ¶æ€åŒæ­¥
    if (syncData.devices) {
      await syncDevices(stores.device, syncData.devices)
    }
    
    // å¤„ç†æƒé™åŒæ­¥
    if (syncData.permissions) {
      await syncPermissions(stores.permission, syncData.permissions)
    }
    
    // å¤„ç†å†²çª
    if (syncData.conflicts && syncData.conflicts.length > 0) {
      await resolveConflicts(stores, syncData.conflicts)
    }
  }
  
  const resolveConflicts = async (stores: any, conflicts: SyncConflict[]) => {
    for (const conflict of conflicts) {
      switch (syncStore.conflictResolution) {
        case 'server-wins':
          applyServerState(stores, conflict.serverState)
          break
        case 'client-wins':
          await pushClientState(stores, conflict.path)
          break
        case 'manual':
          await showConflictResolutionDialog(conflict)
          break
      }
    }
  }
  
  return {
    syncStore: readonly(syncStore),
    syncWithServer
  }
}
```

## 8. æ ·å¼ç³»ç»Ÿ

### 8.1 è®¾è®¡Tokenç³»ç»Ÿ

```scss
// styles/tokens/_colors.scss
:root {
  // åŸºç¡€è‰²å½©
  --color-primary: #1890ff;
  --color-primary-light: #40a9ff;
  --color-primary-dark: #096dd9;
  
  --color-secondary: #52c41a;
  --color-secondary-light: #73d13d;
  --color-secondary-dark: #389e0d;
  
  --color-accent: #fa8c16;
  --color-accent-light: #ffa940;
  --color-accent-dark: #d46b08;
  
  // çŠ¶æ€è‰²å½©
  --color-success: #52c41a;
  --color-warning: #fadb14;
  --color-error: #f5222d;
  --color-info: #1890ff;
  
  // ä¸­æ€§è‰²å½©
  --color-white: #ffffff;
  --color-gray-50: #fafafa;
  --color-gray-100: #f5f5f5;
  --color-gray-200: #f0f0f0;
  --color-gray-300: #d9d9d9;
  --color-gray-400: #bfbfbf;
  --color-gray-500: #8c8c8c;
  --color-gray-600: #595959;
  --color-gray-700: #434343;
  --color-gray-800: #262626;
  --color-gray-900: #1f1f1f;
  --color-black: #000000;
  
  // æƒé™çŠ¶æ€è‰²å½©
  --permission-none: var(--color-gray-300);
  --permission-emergency: var(--color-accent);
  --permission-view: var(--color-warning);
  --permission-basic: var(--color-primary);
  --permission-advanced: var(--color-secondary);
  --permission-full: #13c2c2;
  
  // è®¾å¤‡çŠ¶æ€è‰²å½©
  --device-online: var(--color-secondary);
  --device-offline: var(--color-gray-400);
  --device-connecting: var(--color-warning);
  --device-error: var(--color-error);
  --device-maintenance: var(--color-accent);
}
```

```scss
// styles/tokens/_typography.scss
:root {
  // å­—ä½“å®¶æ—
  --font-family-primary: 'PingFang SC', 'Microsoft YaHei', -apple-system, BlinkMacSystemFont, sans-serif;
  --font-family-secondary: 'SF Pro Display', 'Helvetica Neue', Arial, sans-serif;
  --font-family-mono: 'SF Mono', Monaco, 'Cascadia Code', Consolas, monospace;
  
  // å­—ä½“å¤§å° - åŸºäº16pxåŸºå‡†
  --font-size-xs: 0.75rem;   // 12px
  --font-size-sm: 0.875rem;  // 14px
  --font-size-base: 1rem;    // 16px
  --font-size-lg: 1.125rem;  // 18px
  --font-size-xl: 1.25rem;   // 20px
  --font-size-2xl: 1.5rem;   // 24px
  --font-size-3xl: 1.75rem;  // 28px
  --font-size-4xl: 2rem;     // 32px
  
  // å­—ä½“ç²—ç»†
  --font-weight-light: 300;
  --font-weight-normal: 400;
  --font-weight-medium: 500;
  --font-weight-semibold: 600;
  --font-weight-bold: 700;
  
  // è¡Œé«˜
  --line-height-tight: 1.2;
  --line-height-normal: 1.5;
  --line-height-relaxed: 1.8;
}

// è€äººå‹å¥½ä¸»é¢˜
[data-theme="elder"] {
  --font-size-base: 1.125rem;  // 18px
  --font-size-lg: 1.25rem;     // 20px
  --font-size-xl: 1.375rem;    // 22px
  --font-size-2xl: 1.625rem;   // 26px
  --font-size-3xl: 2rem;       // 32px
  --line-height-normal: 1.8;
}
```

```scss
// styles/tokens/_spacing.scss
:root {
  // é—´è·ç³»ç»Ÿ - åŸºäº8pxç½‘æ ¼
  --spacing-0: 0;
  --spacing-1: 0.25rem;   // 4px
  --spacing-2: 0.5rem;    // 8px
  --spacing-3: 0.75rem;   // 12px
  --spacing-4: 1rem;      // 16px
  --spacing-5: 1.25rem;   // 20px
  --spacing-6: 1.5rem;    // 24px
  --spacing-8: 2rem;      // 32px
  --spacing-10: 2.5rem;   // 40px
  --spacing-12: 3rem;     // 48px
  --spacing-16: 4rem;     // 64px
  --spacing-20: 5rem;     // 80px
  --spacing-24: 6rem;     // 96px
  
  // å®¹å™¨æœ€å¤§å®½åº¦
  --container-sm: 640px;
  --container-md: 768px;
  --container-lg: 1024px;
  --container-xl: 1280px;
  --container-2xl: 1536px;
  
  // è¾¹æ¡†åŠå¾„
  --radius-none: 0;
  --radius-sm: 0.125rem;   // 2px
  --radius-base: 0.25rem;  // 4px
  --radius-md: 0.375rem;   // 6px
  --radius-lg: 0.5rem;     // 8px
  --radius-xl: 0.75rem;    // 12px
  --radius-2xl: 1rem;      // 16px
  --radius-full: 9999px;   // å®Œå…¨åœ†è§’
}
```

### 8.2 ç»„ä»¶æ ·å¼æ¶æ„

```scss
// styles/components/_device-card.scss
.device-card {
  // åŸºç¡€æ ·å¼
  position: relative;
  padding: var(--spacing-4);
  background: var(--color-white);
  border: 1px solid var(--color-gray-200);
  border-radius: var(--radius-lg);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  
  // æ‚¬åœæ•ˆæœ
  &:hover {
    border-color: var(--color-primary-light);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
    transform: translateY(-2px);
  }
  
  // çŠ¶æ€å˜ä½“
  &--online {
    border-left: 4px solid var(--device-online);
    
    .device-card__status {
      color: var(--device-online);
    }
  }
  
  &--offline {
    opacity: 0.6;
    
    .device-card__status {
      color: var(--device-offline);
    }
  }
  
  &--error {
    border-left: 4px solid var(--device-error);
    background: rgba(245, 34, 45, 0.02);
    
    .device-card__status {
      color: var(--device-error);
    }
  }
  
  // å“åº”å¼é€‚é…
  @media (max-width: 768px) {
    padding: var(--spacing-3);
    
    .device-card__controls {
      flex-direction: column;
      gap: var(--spacing-2);
    }
  }
  
  // é«˜å¯¹æ¯”åº¦æ¨¡å¼
  @media (prefers-contrast: high) {
    border-width: 2px;
    box-shadow: none;
    
    &:hover {
      box-shadow: 0 0 0 3px var(--color-primary);
    }
  }
  
  // å‡å°‘åŠ¨ç”»æ¨¡å¼
  @media (prefers-reduced-motion: reduce) {
    transition: none;
    
    &:hover {
      transform: none;
    }
  }
}

// è®¾å¤‡å¡ç‰‡å†…éƒ¨å¸ƒå±€
.device-card__header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: var(--spacing-3);
}

.device-card__status {
  display: flex;
  align-items: center;
  gap: var(--spacing-2);
  font-size: var(--font-size-sm);
  font-weight: var(--font-weight-medium);
}

.device-card__name {
  font-size: var(--font-size-lg);
  font-weight: var(--font-weight-semibold);
  color: var(--color-gray-800);
  margin: 0 0 var(--spacing-2) 0;
}

.device-card__controls {
  display: flex;
  gap: var(--spacing-2);
  align-items: center;
  margin-top: var(--spacing-4);
}

.device-card__details {
  margin-top: var(--spacing-3);
  padding-top: var(--spacing-3);
  border-top: 1px solid var(--color-gray-200);
}
```

### 8.3 å“åº”å¼è®¾è®¡ç³»ç»Ÿ

```scss
// styles/mixins/_responsive.scss
// æ–­ç‚¹å®šä¹‰
$breakpoints: (
  'mobile': 0px,
  'tablet': 768px,
  'desktop': 1024px,
  'wide': 1440px
);

// å“åº”å¼æ··å…¥
@mixin respond-to($breakpoint) {
  $size: map-get($breakpoints, $breakpoint);
  
  @if $breakpoint == 'mobile' {
    @media (max-width: 767px) {
      @content;
    }
  } @else {
    @media (min-width: $size) {
      @content;
    }
  }
}

// å“åº”å¼å­—ä½“å¤§å°
@mixin responsive-font-size($mobile, $tablet: null, $desktop: null) {
  font-size: $mobile;
  
  @if $tablet {
    @include respond-to('tablet') {
      font-size: $tablet;
    }
  }
  
  @if $desktop {
    @include respond-to('desktop') {
      font-size: $desktop;
    }
  }
}

// å“åº”å¼é—´è·
@mixin responsive-spacing($property, $mobile, $tablet: null, $desktop: null) {
  #{$property}: $mobile;
  
  @if $tablet {
    @include respond-to('tablet') {
      #{$property}: $tablet;
    }
  }
  
  @if $desktop {
    @include respond-to('desktop') {
      #{$property}: $desktop;
    }
  }
}
```

### 8.4 ä¸»é¢˜åˆ‡æ¢ç³»ç»Ÿ

```typescript
// composables/useTheme.ts
export type Theme = 'light' | 'dark' | 'elder' | 'high-contrast'

export function useTheme() {
  const currentTheme = ref<Theme>('light')
  
  // ä»localStorageæ¢å¤ä¸»é¢˜è®¾ç½®
  const savedTheme = localStorage.getItem('theme') as Theme
  if (savedTheme) {
    currentTheme.value = savedTheme
  }
  
  // åº”ç”¨ä¸»é¢˜
  const applyTheme = (theme: Theme) => {
    // ç§»é™¤æ—§ä¸»é¢˜ç±»
    document.documentElement.className = document.documentElement.className
      .replace(/data-theme-\w+/g, '')
    
    // æ·»åŠ æ–°ä¸»é¢˜ç±»
    document.documentElement.setAttribute('data-theme', theme)
    
    // æ›´æ–°çŠ¶æ€
    currentTheme.value = theme
    
    // ä¿å­˜åˆ°localStorage
    localStorage.setItem('theme', theme)
    
    // é€šçŸ¥å…¶ä»–ç»„ä»¶
    window.dispatchEvent(new CustomEvent('theme-changed', { detail: theme }))
  }
  
  // åˆ‡æ¢ä¸»é¢˜
  const toggleTheme = () => {
    const themes: Theme[] = ['light', 'dark', 'elder', 'high-contrast']
    const currentIndex = themes.indexOf(currentTheme.value)
    const nextIndex = (currentIndex + 1) % themes.length
    applyTheme(themes[nextIndex])
  }
  
  // æ£€æµ‹ç³»ç»Ÿä¸»é¢˜åå¥½
  const detectSystemTheme = () => {
    if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
      return 'dark'
    } else if (window.matchMedia('(prefers-contrast: high)').matches) {
      return 'high-contrast'
    }
    return 'light'
  }
  
  // ç›‘å¬ç³»ç»Ÿä¸»é¢˜å˜åŒ–
  const watchSystemTheme = () => {
    const darkModeQuery = window.matchMedia('(prefers-color-scheme: dark)')
    const highContrastQuery = window.matchMedia('(prefers-contrast: high)')
    
    darkModeQuery.addListener((e) => {
      if (e.matches && currentTheme.value === 'light') {
        applyTheme('dark')
      } else if (!e.matches && currentTheme.value === 'dark') {
        applyTheme('light')
      }
    })
    
    highContrastQuery.addListener((e) => {
      if (e.matches) {
        applyTheme('high-contrast')
      }
    })
  }
  
  // åˆå§‹åŒ–ä¸»é¢˜
  onMounted(() => {
    applyTheme(currentTheme.value)
    watchSystemTheme()
  })
  
  return {
    currentTheme: readonly(currentTheme),
    applyTheme,
    toggleTheme,
    detectSystemTheme
  }
}
```

```scss
// styles/themes/_dark.scss
[data-theme="dark"] {
  // é‡æ–°å®šä¹‰æš—è‰²ä¸»é¢˜å˜é‡
  --color-white: #1f1f1f;
  --color-gray-50: #262626;
  --color-gray-100: #2f2f2f;
  --color-gray-200: #404040;
  --color-gray-300: #595959;
  --color-gray-400: #8c8c8c;
  --color-gray-500: #bfbfbf;
  --color-gray-600: #d9d9d9;
  --color-gray-700: #f0f0f0;
  --color-gray-800: #f5f5f5;
  --color-gray-900: #fafafa;
  --color-black: #ffffff;
  
  // è°ƒæ•´ç»„ä»¶åœ¨æš—è‰²ä¸»é¢˜ä¸‹çš„æ ·å¼
  .device-card {
    background: var(--color-gray-100);
    border-color: var(--color-gray-200);
    
    &:hover {
      background: var(--color-gray-200);
    }
  }
  
  .app-header {
    background: var(--color-gray-50);
    border-color: var(--color-gray-200);
  }
}
```

## 9. æ„å»ºä¸éƒ¨ç½²

### 9.1 æ„å»ºé…ç½®

```typescript
// vite.config.ts
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import { resolve } from 'path'
import { createHtmlPlugin } from 'vite-plugin-html'
import { visualizer } from 'rollup-plugin-visualizer'
import { VitePWA } from 'vite-plugin-pwa'

export default defineConfig({
  plugins: [
    vue(),
    
    // HTMLæ¨¡æ¿æ’ä»¶
    createHtmlPlugin({
      inject: {
        data: {
          title: 'HavenButler - æ™ºèƒ½å®¶åº­æœåŠ¡å¹³å°',
          description: 'ä¸ºæ‚¨çš„å®¶åº­æä¾›æ™ºèƒ½åŒ–æ§åˆ¶å’Œç®¡ç†æœåŠ¡'
        }
      }
    }),
    
    // PWAæ’ä»¶
    VitePWA({
      registerType: 'autoUpdate',
      workbox: {
        globPatterns: ['**/*.{js,css,html,ico,png,svg}'],
        runtimeCaching: [
          {
            urlPattern: /^https:\/\/api\.havenbutler\.com\//,
            handler: 'NetworkFirst',
            options: {
              cacheName: 'api-cache',
              cacheableResponse: {
                statuses: [0, 200]
              }
            }
          }
        ]
      },
      includeAssets: ['favicon.ico', 'apple-touch-icon.png', 'masked-icon.svg'],
      manifest: {
        name: 'HavenButler æ™ºèƒ½å®¶åº­',
        short_name: 'HavenButler',
        description: 'æ™ºèƒ½å®¶åº­æ§åˆ¶å¹³å°',
        theme_color: '#1890ff',
        background_color: '#ffffff',
        display: 'standalone',
        icons: [
          {
            src: 'pwa-192x192.png',
            sizes: '192x192',
            type: 'image/png'
          },
          {
            src: 'pwa-512x512.png',
            sizes: '512x512',
            type: 'image/png'
          }
        ]
      }
    }),
    
    // æ„å»ºåˆ†ææ’ä»¶
    process.env.ANALYZE && visualizer({
      filename: 'dist/stats.html',
      open: true,
      gzipSize: true
    })
  ],
  
  resolve: {
    alias: {
      '@': resolve(__dirname, 'src'),
      '@components': resolve(__dirname, 'src/components'),
      '@views': resolve(__dirname, 'src/views'),
      '@stores': resolve(__dirname, 'src/stores'),
      '@utils': resolve(__dirname, 'src/utils'),
      '@api': resolve(__dirname, 'src/api'),
      '@styles': resolve(__dirname, 'src/styles')
    }
  },
  
  css: {
    preprocessorOptions: {
      scss: {
        additionalData: `
          @import "@/styles/variables.scss";
          @import "@/styles/mixins.scss";
        `
      }
    }
  },
  
  build: {
    // æ„å»ºè¾“å‡ºç›®å½•
    outDir: 'dist',
    
    // é™æ€èµ„æºå†…è”é˜ˆå€¼
    assetsInlineLimit: 4096,
    
    // å¯ç”¨/ç¦ç”¨ CSS ä»£ç åˆ†å‰²
    cssCodeSplit: true,
    
    // æ„å»ºåæ˜¯å¦ç”Ÿæˆ source map æ–‡ä»¶
    sourcemap: process.env.NODE_ENV === 'development',
    
    // è®¾ç½®æœ€ç»ˆæ„å»ºçš„æµè§ˆå™¨å…¼å®¹ç›®æ ‡
    target: 'es2015',
    
    // ä»£ç åˆ†å—ç­–ç•¥
    rollupOptions: {
      output: {
        manualChunks: {
          // æ¡†æ¶æ ¸å¿ƒ
          'vendor-vue': ['vue', 'vue-router', 'pinia'],
          
          // UIç»„ä»¶åº“
          'vendor-ui': ['ant-design-vue'],
          
          // å·¥å…·åº“
          'vendor-utils': ['axios', 'dayjs', 'lodash-es'],
          
          // å›¾è¡¨åº“
          'vendor-charts': ['echarts'],
          
          // å¤šåª’ä½“å¤„ç†
          'vendor-media': ['@/utils/audio', '@/utils/image']
        }
      }
    },
    
    // å‹ç¼©é…ç½®
    minify: 'terser',
    terserOptions: {
      compress: {
        drop_console: process.env.NODE_ENV === 'production',
        drop_debugger: true
      }
    }
  },
  
  server: {
    port: 3000,
    open: true,
    cors: true,
    
    // ä»£ç†é…ç½®
    proxy: {
      '/api': {
        target: 'http://localhost:8080',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api/, '')
      },
      '/ws': {
        target: 'ws://localhost:8080',
        ws: true,
        changeOrigin: true
      }
    }
  },
  
  preview: {
    port: 4173,
    cors: true
  },
  
  // ç¯å¢ƒå˜é‡é…ç½®
  define: {
    __APP_VERSION__: JSON.stringify(process.env.npm_package_version)
  }
})
```

### 9.2 DockeråŒ–éƒ¨ç½²

```dockerfile
# Dockerfile
# å¤šé˜¶æ®µæ„å»ºï¼šæ„å»ºé˜¶æ®µ
FROM node:18-alpine as build-stage

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å®‰è£…pnpm
RUN npm install -g pnpm

# å¤åˆ¶package.jsonå’Œpnpm-lock.yaml
COPY package*.json pnpm-lock.yaml ./

# å®‰è£…ä¾èµ–
RUN pnpm install --frozen-lockfile

# å¤åˆ¶æºä»£ç 
COPY . .

# æ„å»ºåº”ç”¨
RUN pnpm run build

# ç”Ÿäº§é˜¶æ®µ
FROM nginx:alpine as production-stage

# å¤åˆ¶nginxé…ç½®
COPY docker/nginx.conf /etc/nginx/nginx.conf

# å¤åˆ¶æ„å»ºäº§ç‰©åˆ°nginxç›®å½•
COPY --from=build-stage /app/dist /usr/share/nginx/html

# æš´éœ²ç«¯å£
EXPOSE 80

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
  CMD curl -f http://localhost/ || exit 1

# å¯åŠ¨nginx
CMD ["nginx", "-g", "daemon off;"]
```

```nginx
# docker/nginx.conf
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # æ—¥å¿—æ ¼å¼
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    # åŸºç¡€é…ç½®
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # å‹ç¼©é…ç½®
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript
               application/json application/javascript application/xml
               application/rss+xml application/atom+xml image/svg+xml;

    # ç¼“å­˜é…ç½®
    map $sent_http_content_type $expires {
        default                    off;
        text/html                  epoch;
        text/css                   max;
        application/javascript     max;
        ~image/                    max;
    }

    server {
        listen 80;
        server_name localhost;
        root /usr/share/nginx/html;
        index index.html;

        # å®‰å…¨å¤´é…ç½®
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header Referrer-Policy "no-referrer-when-downgrade" always;
        add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;

        # è®¾ç½®è¿‡æœŸæ—¶é—´
        expires $expires;

        # SPAè·¯ç”±æ”¯æŒ
        location / {
            try_files $uri $uri/ /index.html;
        }

        # APIä»£ç†
        location /api/ {
            proxy_pass http://backend:8080/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # è¶…æ—¶é…ç½®
            proxy_connect_timeout 5s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }

        # WebSocketä»£ç†
        location /ws/ {
            proxy_pass http://backend:8080/ws/;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # é™æ€èµ„æºç¼“å­˜
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }

        # é”™è¯¯é¡µé¢
        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
            root /usr/share/nginx/html;
        }
    }
}
```

### 9.3 Docker Composeé…ç½®

```yaml
# docker-compose.yml
version: '3.8'

services:
  # å‰ç«¯æœåŠ¡
  frontend:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "80:80"
    depends_on:
      - backend
    networks:
      - app-network
    environment:
      - NODE_ENV=production
    restart: unless-stopped
    
  # åç«¯æœåŠ¡ï¼ˆç¤ºä¾‹ï¼‰
  backend:
    image: havenbutler/backend:latest
    ports:
      - "8080:8080"
    networks:
      - app-network
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - DATABASE_URL=postgresql://db:5432/havenbutler
    depends_on:
      - db
      - redis
    restart: unless-stopped
    
  # æ•°æ®åº“
  db:
    image: postgres:15-alpine
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - app-network
    environment:
      - POSTGRES_DB=havenbutler
      - POSTGRES_USER=havenbutler
      - POSTGRES_PASSWORD=secure_password
    restart: unless-stopped
    
  # ç¼“å­˜
  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data
    networks:
      - app-network
    restart: unless-stopped

  # Nginxåå‘ä»£ç†
  nginx:
    image: nginx:alpine
    ports:
      - "443:443"
      - "80:80"
    volumes:
      - ./docker/nginx-proxy.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
    depends_on:
      - frontend
    networks:
      - app-network
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:

networks:
  app-network:
    driver: bridge
```

### 9.4 CI/CDé…ç½®

```yaml
# .github/workflows/deploy.yml
name: Build and Deploy

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'pnpm'
    
    - name: Install pnpm
      run: npm install -g pnpm
    
    - name: Install dependencies
      run: pnpm install --frozen-lockfile
    
    - name: Run linting
      run: pnpm run lint
    
    - name: Run type checking
      run: pnpm run type-check
    
    - name: Run unit tests
      run: pnpm run test:unit
    
    - name: Run e2e tests
      run: pnpm run test:e2e
      
    - name: Upload test coverage
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info

  build:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'pnpm'
    
    - name: Install pnpm
      run: npm install -g pnpm
    
    - name: Install dependencies
      run: pnpm install --frozen-lockfile
    
    - name: Build application
      run: pnpm run build
      env:
        NODE_ENV: production
    
    - name: Build Docker image
      run: |
        docker build -t havenbutler/frontend:${{ github.sha }} .
        docker tag havenbutler/frontend:${{ github.sha }} havenbutler/frontend:latest
    
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: Push Docker image
      run: |
        docker push havenbutler/frontend:${{ github.sha }}
        docker push havenbutler/frontend:latest

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Deploy to production
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          cd /opt/havenbutler
          docker-compose pull frontend
          docker-compose up -d frontend
          docker system prune -f
```

## 10. æ€§èƒ½ä¼˜åŒ–

### 10.1 åŠ è½½æ€§èƒ½ä¼˜åŒ–

#### 10.1.1 ä»£ç åˆ†å‰²ç­–ç•¥

```typescript
// router/lazy-loading.ts
// è·¯ç”±çº§ä»£ç åˆ†å‰²
const routes = [
  {
    path: '/dashboard',
    component: () => import('@/views/DashboardView.vue')
  },
  {
    path: '/devices',
    component: () => import('@/views/device/DeviceControlView.vue')
  }
]

// ç»„ä»¶çº§åŠ¨æ€å¯¼å…¥
export const AsyncDeviceCard = defineAsyncComponent({
  loader: () => import('@/components/business/DeviceCard.vue'),
  loadingComponent: LoadingSpinner,
  errorComponent: LoadingError,
  delay: 200,
  timeout: 3000
})

// é¢„åŠ è½½å…³é”®ç»„ä»¶
export function preloadCriticalComponents() {
  const criticalComponents = [
    () => import('@/components/business/VoiceInterface.vue'),
    () => import('@/components/business/PermissionRing.vue'),
    () => import('@/views/EmergencyView.vue')
  ]
  
  if ('requestIdleCallback' in window) {
    window.requestIdleCallback(() => {
      criticalComponents.forEach(loader => loader())
    })
  }
}
```

#### 10.1.2 èµ„æºä¼˜åŒ–

```typescript
// vite.config.ts - èµ„æºä¼˜åŒ–é…ç½®
export default defineConfig({
  build: {
    rollupOptions: {
      output: {
        manualChunks: (id) => {
          // ç¬¬ä¸‰æ–¹åº“åˆ†åŒ…
          if (id.includes('node_modules')) {
            if (id.includes('vue')) return 'vue'
            if (id.includes('ant-design-vue')) return 'antd'
            if (id.includes('echarts')) return 'charts'
            return 'vendor'
          }
          
          // ä¸šåŠ¡æ¨¡å—åˆ†åŒ…
          if (id.includes('/src/views/device/')) return 'device'
          if (id.includes('/src/views/family/')) return 'family'
          if (id.includes('/src/components/business/')) return 'business'
        }
      }
    }
  },
  
  // å›¾ç‰‡ä¼˜åŒ–
  plugins: [
    // å›¾ç‰‡å‹ç¼©
    viteImageOptimize({
      gifsicle: { optimizationLevel: 7 },
      mozjpeg: { quality: 85 },
      pngquant: { quality: [0.8, 0.9] },
      svgo: {
        plugins: [
          { name: 'removeViewBox', active: false },
          { name: 'removeEmptyAttrs', active: false }
        ]
      }
    })
  ]
})
```

#### 10.1.3 ç¼“å­˜ç­–ç•¥

```typescript
// utils/cache.ts
export class CacheManager {
  private memoryCache = new Map<string, CacheItem>()
  private readonly maxMemoryCacheSize = 50 // MB
  private currentMemorySize = 0
  
  // å†…å­˜ç¼“å­˜
  set(key: string, value: any, ttl = 300000) { // é»˜è®¤5åˆ†é’Ÿ
    const item: CacheItem = {
      value,
      expiry: Date.now() + ttl,
      size: this.calculateSize(value)
    }
    
    // æ£€æŸ¥å†…å­˜é™åˆ¶
    if (this.currentMemorySize + item.size > this.maxMemoryCacheSize * 1024 * 1024) {
      this.evictLRU()
    }
    
    this.memoryCache.set(key, item)
    this.currentMemorySize += item.size
  }
  
  get(key: string) {
    const item = this.memoryCache.get(key)
    
    if (!item) return null
    
    if (Date.now() > item.expiry) {
      this.delete(key)
      return null
    }
    
    return item.value
  }
  
  // IndexedDBæŒä¹…åŒ–ç¼“å­˜
  async setPersistent(key: string, value: any, ttl = 86400000) { // é»˜è®¤24å°æ—¶
    try {
      await this.openDB()
      const transaction = this.db.transaction(['cache'], 'readwrite')
      const store = transaction.objectStore('cache')
      
      await store.put({
        id: key,
        value,
        expiry: Date.now() + ttl,
        createdAt: Date.now()
      })
    } catch (error) {
      console.warn('Failed to set persistent cache:', error)
    }
  }
  
  async getPersistent(key: string) {
    try {
      await this.openDB()
      const transaction = this.db.transaction(['cache'], 'readonly')
      const store = transaction.objectStore('cache')
      const result = await store.get(key)
      
      if (!result) return null
      
      if (Date.now() > result.expiry) {
        await this.deletePersistent(key)
        return null
      }
      
      return result.value
    } catch (error) {
      console.warn('Failed to get persistent cache:', error)
      return null
    }
  }
  
  private evictLRU() {
    // å®ç°LRUæ·˜æ±°ç­–ç•¥
    const sortedEntries = Array.from(this.memoryCache.entries())
      .sort(([,a], [,b]) => (a.lastAccessed || 0) - (b.lastAccessed || 0))
    
    const toEvict = sortedEntries.slice(0, Math.ceil(sortedEntries.length * 0.3))
    toEvict.forEach(([key]) => this.delete(key))
  }
}

// ä½¿ç”¨ç¼“å­˜è£…é¥°å™¨
export function Cacheable(key: string, ttl?: number) {
  return function (target: any, propertyName: string, descriptor: PropertyDescriptor) {
    const method = descriptor.value
    
    descriptor.value = async function (...args: any[]) {
      const cacheKey = `${key}:${JSON.stringify(args)}`
      
      // å°è¯•ä»ç¼“å­˜è·å–
      let result = cacheManager.get(cacheKey)
      if (result !== null) {
        return result
      }
      
      // æ‰§è¡ŒåŸæ–¹æ³•
      result = await method.apply(this, args)
      
      // ç¼“å­˜ç»“æœ
      cacheManager.set(cacheKey, result, ttl)
      
      return result
    }
  }
}
```

### 10.2 è¿è¡Œæ—¶æ€§èƒ½ä¼˜åŒ–

#### 10.2.1 è™šæ‹Ÿåˆ—è¡¨

```vue
<!-- components/common/VirtualList.vue -->
<template>
  <div class="virtual-list" ref="containerRef" @scroll="handleScroll">
    <div class="virtual-list__spacer" :style="{ height: `${totalHeight}px` }">
      <div
        class="virtual-list__content"
        :style="{
          transform: `translateY(${startOffset}px)`
        }"
      >
        <div
          v-for="item in visibleItems"
          :key="getItemKey(item)"
          class="virtual-list__item"
          :style="{ height: `${itemHeight}px` }"
        >
          <slot :item="item" :index="item.index" />
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
interface Props {
  items: any[]
  itemHeight: number
  containerHeight?: number
  overscan?: number
  getItemKey?: (item: any) => string | number
}

const props = withDefaults(defineProps<Props>(), {
  containerHeight: 400,
  overscan: 5,
  getItemKey: (item, index) => index
})

const containerRef = ref<HTMLElement>()
const scrollTop = ref(0)

// è®¡ç®—å¯è§†èŒƒå›´
const visibleRange = computed(() => {
  const start = Math.floor(scrollTop.value / props.itemHeight)
  const end = Math.min(
    start + Math.ceil(props.containerHeight / props.itemHeight),
    props.items.length - 1
  )
  
  return {
    start: Math.max(0, start - props.overscan),
    end: Math.min(props.items.length - 1, end + props.overscan)
  }
})

// å¯è§†é¡¹ç›®
const visibleItems = computed(() => {
  const { start, end } = visibleRange.value
  return props.items.slice(start, end + 1).map((item, i) => ({
    ...item,
    index: start + i
  }))
})

// æ€»é«˜åº¦
const totalHeight = computed(() => props.items.length * props.itemHeight)

// èµ·å§‹åç§»
const startOffset = computed(() => visibleRange.value.start * props.itemHeight)

// æ»šåŠ¨å¤„ç†
const handleScroll = throttle(() => {
  if (containerRef.value) {
    scrollTop.value = containerRef.value.scrollTop
  }
}, 16) // 60fps

function throttle<T extends (...args: any[]) => any>(
  func: T,
  delay: number
): T {
  let timeoutId: NodeJS.Timeout
  let lastExecTime = 0
  
  return ((...args) => {
    const currentTime = Date.now()
    
    if (currentTime - lastExecTime > delay) {
      func(...args)
      lastExecTime = currentTime
    } else {
      clearTimeout(timeoutId)
      timeoutId = setTimeout(() => {
        func(...args)
        lastExecTime = Date.now()
      }, delay - (currentTime - lastExecTime))
    }
  }) as T
}
</script>
```

#### 10.2.2 é˜²æŠ–èŠ‚æµä¼˜åŒ–

```typescript
// composables/usePerformance.ts
export function usePerformance() {
  // é˜²æŠ–å‡½æ•°
  const debounce = <T extends (...args: any[]) => any>(
    func: T,
    delay: number
  ): T => {
    let timeoutId: NodeJS.Timeout
    
    return ((...args) => {
      clearTimeout(timeoutId)
      timeoutId = setTimeout(() => func(...args), delay)
    }) as T
  }
  
  // èŠ‚æµå‡½æ•°
  const throttle = <T extends (...args: any[]) => any>(
    func: T,
    delay: number
  ): T => {
    let lastExecTime = 0
    
    return ((...args) => {
      const currentTime = Date.now()
      if (currentTime - lastExecTime >= delay) {
        func(...args)
        lastExecTime = currentTime
      }
    }) as T
  }
  
  // RAFèŠ‚æµ
  const rafThrottle = <T extends (...args: any[]) => any>(func: T): T => {
    let rafId: number
    
    return ((...args) => {
      if (rafId) return
      
      rafId = requestAnimationFrame(() => {
        func(...args)
        rafId = 0
      })
    }) as T
  }
  
  // ç©ºé—²æ—¶æ‰§è¡Œ
  const idleCallback = (callback: () => void, timeout = 5000) => {
    if ('requestIdleCallback' in window) {
      return window.requestIdleCallback(callback, { timeout })
    } else {
      return setTimeout(callback, 1)
    }
  }
  
  // å–æ¶ˆç©ºé—²å›è°ƒ
  const cancelIdleCallback = (id: number) => {
    if ('cancelIdleCallback' in window) {
      window.cancelIdleCallback(id)
    } else {
      clearTimeout(id)
    }
  }
  
  return {
    debounce,
    throttle,
    rafThrottle,
    idleCallback,
    cancelIdleCallback
  }
}

// æ€§èƒ½ç›‘æ§
export function usePerformanceMonitor() {
  const metrics = reactive({
    fps: 0,
    memory: 0,
    loadTime: 0,
    renderTime: 0
  })
  
  // FPSç›‘æ§
  const startFPSMonitor = () => {
    let frames = 0
    let lastTime = performance.now()
    
    const tick = () => {
      frames++
      const currentTime = performance.now()
      
      if (currentTime >= lastTime + 1000) {
        metrics.fps = Math.round((frames * 1000) / (currentTime - lastTime))
        frames = 0
        lastTime = currentTime
      }
      
      requestAnimationFrame(tick)
    }
    
    requestAnimationFrame(tick)
  }
  
  // å†…å­˜ç›‘æ§
  const startMemoryMonitor = () => {
    if ('memory' in performance) {
      setInterval(() => {
        const memory = (performance as any).memory
        metrics.memory = Math.round(memory.usedJSHeapSize / 1024 / 1024)
      }, 5000)
    }
  }
  
  // æ¸²æŸ“æ—¶é—´ç›‘æ§
  const measureRenderTime = (name: string) => {
    const startTime = performance.now()
    
    return () => {
      const endTime = performance.now()
      const renderTime = endTime - startTime
      
      metrics.renderTime = renderTime
      
      if (renderTime > 16) {
        console.warn(`Slow render detected: ${name} took ${renderTime.toFixed(2)}ms`)
      }
    }
  }
  
  onMounted(() => {
    startFPSMonitor()
    startMemoryMonitor()
    
    // é¡µé¢åŠ è½½æ—¶é—´
    metrics.loadTime = performance.now()
  })
  
  return {
    metrics: readonly(metrics),
    measureRenderTime
  }
}
```

### 10.3 å†…å­˜ä¼˜åŒ–

```typescript
// composables/useMemoryOptimization.ts
export function useMemoryOptimization() {
  const observers = new Set<() => void>()
  const timers = new Set<NodeJS.Timeout>()
  const eventListeners = new Set<{
    target: EventTarget
    event: string
    handler: EventListener
  }>()
  
  // æ·»åŠ è§‚å¯Ÿå™¨
  const addObserver = (cleanup: () => void) => {
    observers.add(cleanup)
    return () => observers.delete(cleanup)
  }
  
  // æ·»åŠ å®šæ—¶å™¨
  const addTimer = (timer: NodeJS.Timeout) => {
    timers.add(timer)
    return () => {
      clearTimeout(timer)
      timers.delete(timer)
    }
  }
  
  // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
  const addEventListener = (
    target: EventTarget,
    event: string,
    handler: EventListener,
    options?: AddEventListenerOptions
  ) => {
    target.addEventListener(event, handler, options)
    
    const listener = { target, event, handler }
    eventListeners.add(listener)
    
    return () => {
      target.removeEventListener(event, handler)
      eventListeners.delete(listener)
    }
  }
  
  // æ¸…ç†æ‰€æœ‰èµ„æº
  const cleanup = () => {
    // æ¸…ç†è§‚å¯Ÿå™¨
    observers.forEach(observer => observer())
    observers.clear()
    
    // æ¸…ç†å®šæ—¶å™¨
    timers.forEach(timer => clearTimeout(timer))
    timers.clear()
    
    // æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
    eventListeners.forEach(({ target, event, handler }) => {
      target.removeEventListener(event, handler)
    })
    eventListeners.clear()
  }
  
  // ç»„ä»¶å¸è½½æ—¶è‡ªåŠ¨æ¸…ç†
  onUnmounted(cleanup)
  
  // å†…å­˜æ³„æ¼æ£€æµ‹
  const detectMemoryLeaks = () => {
    if (process.env.NODE_ENV === 'development') {
      const checkLeaks = () => {
        if (observers.size > 0) {
          console.warn(`Potential memory leak: ${observers.size} observers not cleaned up`)
        }
        if (timers.size > 0) {
          console.warn(`Potential memory leak: ${timers.size} timers not cleaned up`)
        }
        if (eventListeners.size > 0) {
          console.warn(`Potential memory leak: ${eventListeners.size} event listeners not cleaned up`)
        }
      }
      
      // å»¶è¿Ÿæ£€æŸ¥ï¼Œç»™ç»„ä»¶å¸è½½æ—¶é—´
      setTimeout(checkLeaks, 1000)
    }
  }
  
  onUnmounted(detectMemoryLeaks)
  
  return {
    addObserver,
    addTimer,
    addEventListener,
    cleanup
  }
}

// å¤§æ•°æ®å¤„ç†ä¼˜åŒ–
export function useLargeDataOptimization() {
  // åˆ†æ‰¹å¤„ç†å¤§æ•°æ®
  const processBatches = async <T, R>(
    items: T[],
    processor: (item: T) => R | Promise<R>,
    batchSize = 100
  ): Promise<R[]> => {
    const results: R[] = []
    
    for (let i = 0; i < items.length; i += batchSize) {
      const batch = items.slice(i, i + batchSize)
      const batchResults = await Promise.all(
        batch.map(item => processor(item))
      )
      
      results.push(...batchResults)
      
      // è®©å‡ºä¸»çº¿ç¨‹
      await new Promise(resolve => setTimeout(resolve, 0))
    }
    
    return results
  }
  
  // Web Workerå¤„ç†
  const processWithWorker = <T, R>(
    data: T[],
    workerScript: string
  ): Promise<R[]> => {
    return new Promise((resolve, reject) => {
      const worker = new Worker(workerScript)
      
      worker.postMessage(data)
      
      worker.onmessage = (event) => {
        resolve(event.data)
        worker.terminate()
      }
      
      worker.onerror = (error) => {
        reject(error)
        worker.terminate()
      }
      
      // 5ç§’è¶…æ—¶
      setTimeout(() => {
        reject(new Error('Worker timeout'))
        worker.terminate()
      }, 5000)
    })
  }
  
  return {
    processBatches,
    processWithWorker
  }
}
```

<function_calls>
<invoke name="TodoWrite">
<parameter name="todos">[{"content": "\u521b\u5efa\u524d\u7aef\u67b6\u6784\u6587\u6863", "status": "completed", "activeForm": "\u6b63\u5728\u521b\u5efa\u524d\u7aef\u67b6\u6784\u6587\u6863"}]