# ç»Ÿä¸€æ•°æ®å­˜å‚¨ç³»ç»Ÿè¯¦è§£

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

ç»Ÿä¸€æ•°æ®å­˜å‚¨ç³»ç»Ÿæ˜¯ Storage Service çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œä¸ºæ‰€æœ‰å¾®æœåŠ¡æä¾›ç»Ÿä¸€çš„æ•°æ®è®¿é—®æ¥å£ï¼Œæ”¯æŒ PostgreSQLã€MongoDBã€Redis ä¸‰ç§æ•°æ®æºçš„é€æ˜åŒ–æ“ä½œã€‚

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ•´ä½“æ¶æ„å›¾

```mermaid
graph TB
    subgraph "å¾®æœåŠ¡å±‚"
        A[Account Service]
        B[Message Service]
        C[AI Service]
        D[NLP Service]
    end

    subgraph "Storage Service - æ•°æ®å­˜å‚¨å±‚"
        E[REST API ç»Ÿä¸€æ¥å£]
        F[è¯·æ±‚è·¯ç”±å™¨]
        G[æ•°æ®æºé€‚é…å™¨]
        H[æƒé™éªŒè¯]
        I[æ•°æ®åŠ å¯†]
        J[ç¼“å­˜ç®¡ç†]
    end

    subgraph "æ•°æ®å­˜å‚¨åŸºç¡€è®¾æ–½"
        K[PostgreSQL<br/>ç”¨æˆ·æ•°æ®/ç³»ç»Ÿé…ç½®]
        L[MongoDB<br/>è®¾å¤‡çŠ¶æ€/æ—¥å¿—æ•°æ®]
        M[Redis<br/>ä¼šè¯ç¼“å­˜/ä¸´æ—¶æ•°æ®]
    end

    A --> E
    B --> E
    C --> E
    D --> E

    E --> F
    F --> H
    H --> I
    I --> G
    G --> J

    G --> K
    G --> L
    G --> M
```

### æ ¸å¿ƒç»„ä»¶è¯´æ˜

#### 1. REST API ç»Ÿä¸€æ¥å£
- **èŒè´£**: æä¾›æ ‡å‡†åŒ–çš„æ•°æ®æ“ä½œæ¥å£
- **æ”¯æŒæ“ä½œ**: INSERTã€UPDATEã€DELETEã€QUERY
- **åè®®**: HTTP/JSON
- **è®¤è¯**: Service-Key + JWT Token

#### 2. è¯·æ±‚è·¯ç”±å™¨
- **èŒè´£**: æ ¹æ®æ•°æ®ç±»å‹è·¯ç”±åˆ°å¯¹åº”çš„æ•°æ®æº
- **è·¯ç”±è§„åˆ™**: åŸºäº `storageType` å‚æ•°
- **è´Ÿè½½å‡è¡¡**: æ”¯æŒè¯»å†™åˆ†ç¦»å’Œè´Ÿè½½åˆ†å‘

#### 3. æ•°æ®æºé€‚é…å™¨
- **èŒè´£**: å°†ç»Ÿä¸€è¯·æ±‚è½¬æ¢ä¸ºå…·ä½“æ•°æ®æºçš„æ“ä½œ
- **æ”¯æŒæ•°æ®æº**: PostgreSQLã€MongoDBã€Redis
- **äº‹åŠ¡æ”¯æŒ**: è·¨æ•°æ®æºåˆ†å¸ƒå¼äº‹åŠ¡

## ğŸ”§ æŠ€æœ¯å®ç°

### ç»Ÿä¸€è¯·æ±‚æ¨¡å‹

```java
/**
 * ç»Ÿä¸€æ•°æ®å­˜å‚¨è¯·æ±‚æ¨¡å‹
 */
public class StorageRequest {
    private String storageType;    // postgresql/mongodb/redis
    private String operation;      // insert/update/delete/query
    private String table;          // è¡¨å/é›†åˆå/Keyå‰ç¼€
    private Map<String, Object> data;      // æ“ä½œæ•°æ®
    private Map<String, Object> filters;  // æŸ¥è¯¢æ¡ä»¶
    private String familyId;       // å®¶åº­IDï¼ˆå¿…éœ€ï¼‰
    private String userId;         // ç”¨æˆ·ID
    private String traceId;        // é“¾è·¯è¿½è¸ªID
    private Map<String, Object> options;  // æ‰©å±•é€‰é¡¹
}
```

### ç»Ÿä¸€å“åº”æ¨¡å‹

```java
/**
 * ç»Ÿä¸€æ•°æ®å­˜å‚¨å“åº”æ¨¡å‹
 */
public class StorageResponse {
    private boolean success;               // æ“ä½œæ˜¯å¦æˆåŠŸ
    private String message;               // å“åº”æ¶ˆæ¯
    private Object data;                  // è¿”å›æ•°æ®
    private Integer totalCount;           // æ€»è®°å½•æ•°ï¼ˆæŸ¥è¯¢æ—¶ï¼‰
    private String traceId;              // é“¾è·¯è¿½è¸ªID
    private Long executionTime;          // æ‰§è¡Œè€—æ—¶ï¼ˆæ¯«ç§’ï¼‰
    private Map<String, Object> metadata; // å…ƒæ•°æ®ä¿¡æ¯
}
```

### æ•°æ®æºé€‚é…å™¨å®ç°

```java
/**
 * PostgreSQL é€‚é…å™¨
 */
@Component
public class PostgreSQLAdapter implements StorageAdapter {

    @Override
    public StorageResponse execute(StorageRequest request) {
        long startTime = System.currentTimeMillis();

        try {
            // 1. å‚æ•°éªŒè¯
            validateRequest(request);

            // 2. æƒé™æ£€æŸ¥
            checkPermissions(request);

            // 3. æ•°æ®åŠ å¯†ï¼ˆæ•æ„Ÿå­—æ®µï¼‰
            encryptSensitiveData(request);

            // 4. æ„å»ºSQLè¯­å¥
            String sql = buildSQL(request);

            // 5. æ‰§è¡Œæ•°æ®åº“æ“ä½œ
            Object result = executeSQL(sql, request);

            // 6. è®°å½•å®¡è®¡æ—¥å¿—
            auditLog(request, result);

            return StorageResponse.success(result, System.currentTimeMillis() - startTime);

        } catch (Exception e) {
            logError(request, e);
            return StorageResponse.error(e.getMessage());
        }
    }

    private void validateRequest(StorageRequest request) {
        // familyId å¿…éœ€éªŒè¯
        if (StringUtils.isEmpty(request.getFamilyId())) {
            throw new IllegalArgumentException("familyId ä¸èƒ½ä¸ºç©º");
        }

        // SQL æ³¨å…¥é˜²æŠ¤
        if (containsSQLInjection(request)) {
            throw new SecurityException("æ£€æµ‹åˆ°SQLæ³¨å…¥æ”»å‡»");
        }
    }
}
```

## ğŸ“Š æ•°æ®æµç¨‹å›¾

### æ•°æ®å†™å…¥æµç¨‹

```mermaid
sequenceDiagram
    participant MS as å¾®æœåŠ¡
    participant API as REST API
    participant Router as è¯·æ±‚è·¯ç”±å™¨
    participant Auth as æƒé™éªŒè¯
    participant Encrypt as æ•°æ®åŠ å¯†
    participant Adapter as æ•°æ®é€‚é…å™¨
    participant DB as æ•°æ®åº“
    participant Cache as ç¼“å­˜
    participant Audit as å®¡è®¡æ—¥å¿—

    MS->>API: POST /api/v1/storage/{type}/insert
    Note over MS,API: Service-Key + JWT + FamilyID

    API->>Router: è·¯ç”±è¯·æ±‚
    Router->>Auth: æƒé™éªŒè¯
    Auth->>Encrypt: æ•æ„Ÿæ•°æ®åŠ å¯†
    Encrypt->>Adapter: æ•°æ®æºé€‚é…

    Adapter->>DB: æ‰§è¡Œæ’å…¥æ“ä½œ
    DB-->>Adapter: è¿”å›ç»“æœ

    Adapter->>Cache: æ›´æ–°ç¼“å­˜
    Adapter->>Audit: è®°å½•å®¡è®¡æ—¥å¿—

    Adapter-->>API: è¿”å›å“åº”
    API-->>MS: JSONå“åº”
```

### æ•°æ®æŸ¥è¯¢æµç¨‹

```mermaid
sequenceDiagram
    participant MS as å¾®æœåŠ¡
    participant API as REST API
    participant Cache as ç¼“å­˜å±‚
    participant Adapter as æ•°æ®é€‚é…å™¨
    participant DB as æ•°æ®åº“

    MS->>API: POST /api/v1/storage/{type}/query
    API->>Cache: æ£€æŸ¥ç¼“å­˜

    alt ç¼“å­˜å‘½ä¸­
        Cache-->>API: è¿”å›ç¼“å­˜æ•°æ®
        API-->>MS: å¿«é€Ÿå“åº”
    else ç¼“å­˜æœªå‘½ä¸­
        API->>Adapter: æ•°æ®åº“æŸ¥è¯¢
        Adapter->>DB: æ‰§è¡ŒæŸ¥è¯¢
        DB-->>Adapter: è¿”å›ç»“æœ
        Adapter->>Cache: æ›´æ–°ç¼“å­˜
        Adapter-->>API: è¿”å›æ•°æ®
        API-->>MS: JSONå“åº”
    end
```

## ğŸ” å®‰å…¨æœºåˆ¶

### å¤šå±‚å®‰å…¨é˜²æŠ¤

```mermaid
graph TD
    A[å¾®æœåŠ¡è¯·æ±‚] --> B[ç½‘å…³å±‚éªŒè¯]
    B --> C[Service-Key éªŒè¯]
    C --> D[JWT Token éªŒè¯]
    D --> E[FamilyID æ•°æ®éš”ç¦»]
    E --> F[SQLæ³¨å…¥é˜²æŠ¤]
    F --> G[æ•æ„Ÿæ•°æ®åŠ å¯†]
    G --> H[å®¡è®¡æ—¥å¿—è®°å½•]
    H --> I[æ•°æ®åº“æ“ä½œ]
```

### æƒé™æ§åˆ¶å®ç°

```java
/**
 * åŸºäº familyId çš„æ•°æ®éš”ç¦»
 */
@Aspect
@Component
public class DataIsolationAspect {

    @Before("@annotation(DataIsolation)")
    public void enforceDataIsolation(JoinPoint point) {
        StorageRequest request = getStorageRequest(point);

        // å¼ºåˆ¶æ·»åŠ  familyId è¿‡æ»¤æ¡ä»¶
        if (request.getFilters() == null) {
            request.setFilters(new HashMap<>());
        }
        request.getFilters().put("family_id", request.getFamilyId());

        // è®°å½•æ•°æ®è®¿é—®æ—¥å¿—
        auditDataAccess(request);
    }
}
```

## ğŸš€ ä½¿ç”¨æŒ‡å—

### 1. PostgreSQL æ•°æ®æ“ä½œ

#### æ’å…¥ç”¨æˆ·æ•°æ®
```bash
curl -X POST http://storage-service:8081/api/v1/storage/postgresql/insert \
  -H "Service-Key: key_account_xxx" \
  -H "X-Family-ID: family123" \
  -H "Content-Type: application/json" \
  -d '{
    "table": "users",
    "data": {
      "username": "å¼ ä¸‰",
      "email": "zhangsan@example.com",
      "phone": "13800138000"
    }
  }'
```

#### æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨
```bash
curl -X POST http://storage-service:8081/api/v1/storage/postgresql/query \
  -H "Service-Key: key_account_xxx" \
  -H "X-Family-ID: family123" \
  -H "Content-Type: application/json" \
  -d '{
    "table": "users",
    "filters": {
      "status": "active"
    },
    "options": {
      "limit": 10,
      "offset": 0,
      "orderBy": "created_at DESC"
    }
  }'
```

### 2. MongoDB æ–‡æ¡£æ“ä½œ

#### æ’å…¥è®¾å¤‡çŠ¶æ€
```bash
curl -X POST http://storage-service:8081/api/v1/storage/mongodb/insert \
  -H "Service-Key: key_device_xxx" \
  -H "X-Family-ID: family123" \
  -H "Content-Type: application/json" \
  -d '{
    "table": "device_states",
    "data": {
      "deviceId": "device_001",
      "status": "online",
      "temperature": 25.5,
      "humidity": 60,
      "timestamp": "2024-01-15T10:30:00Z"
    }
  }'
```

#### æŸ¥è¯¢è®¾å¤‡å†å²
```bash
curl -X POST http://storage-service:8081/api/v1/storage/mongodb/query \
  -H "Service-Key: key_device_xxx" \
  -H "X-Family-ID: family123" \
  -H "Content-Type: application/json" \
  -d '{
    "table": "device_states",
    "filters": {
      "deviceId": "device_001",
      "timestamp": {
        "$gte": "2024-01-15T00:00:00Z"
      }
    },
    "options": {
      "sort": {"timestamp": -1},
      "limit": 100
    }
  }'
```

### 3. Redis ç¼“å­˜æ“ä½œ

#### è®¾ç½®ä¼šè¯ç¼“å­˜
```bash
curl -X POST http://storage-service:8081/api/v1/storage/redis/set \
  -H "Service-Key: key_account_xxx" \
  -H "X-Family-ID: family123" \
  -H "Content-Type: application/json" \
  -d '{
    "table": "sessions",
    "data": {
      "key": "session:user123",
      "value": {
        "userId": "user123",
        "username": "å¼ ä¸‰",
        "loginTime": "2024-01-15T10:30:00Z"
      },
      "ttl": 3600
    }
  }'
```

#### è·å–ç¼“å­˜æ•°æ®
```bash
curl -X POST http://storage-service:8081/api/v1/storage/redis/get \
  -H "Service-Key: key_account_xxx" \
  -H "X-Family-ID: family123" \
  -H "Content-Type: application/json" \
  -d '{
    "table": "sessions",
    "filters": {
      "key": "session:user123"
    }
  }'
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. è¿æ¥æ± é…ç½®

```yaml
# PostgreSQL è¿æ¥æ± 
spring:
  datasource:
    hikari:
      maximum-pool-size: 20        # æœ€å¤§è¿æ¥æ•°
      minimum-idle: 5              # æœ€å°ç©ºé—²è¿æ¥
      connection-timeout: 30000    # è¿æ¥è¶…æ—¶
      idle-timeout: 600000         # ç©ºé—²è¶…æ—¶
      max-lifetime: 1800000        # è¿æ¥æœ€å¤§ç”Ÿå‘½å‘¨æœŸ

# MongoDB è¿æ¥æ± 
spring:
  data:
    mongodb:
      options:
        max-pool-size: 20
        min-pool-size: 5
        max-wait-time: 30000

# Redis è¿æ¥æ± 
spring:
  redis:
    lettuce:
      pool:
        max-active: 8
        max-idle: 8
        min-idle: 0
```

### 2. ç¼“å­˜ç­–ç•¥

```java
/**
 * å¤šçº§ç¼“å­˜å®ç°
 */
@Component
public class MultiLevelCache {

    private final Cache<String, Object> localCache;  // L1: æœ¬åœ°ç¼“å­˜
    private final RedisTemplate<String, Object> redisTemplate;  // L2: Redisç¼“å­˜

    public Object get(String key, Supplier<Object> loader) {
        // L1 ç¼“å­˜æ£€æŸ¥
        Object value = localCache.getIfPresent(key);
        if (value != null) {
            return value;
        }

        // L2 ç¼“å­˜æ£€æŸ¥
        value = redisTemplate.opsForValue().get(key);
        if (value != null) {
            localCache.put(key, value);
            return value;
        }

        // æ•°æ®åº“åŠ è½½
        value = loader.get();
        if (value != null) {
            redisTemplate.opsForValue().set(key, value, 10, TimeUnit.MINUTES);
            localCache.put(key, value);
        }

        return value;
    }
}
```

### 3. æ‰¹é‡æ“ä½œ

```java
/**
 * æ‰¹é‡æ’å…¥ä¼˜åŒ–
 */
@Service
public class BatchOperationService {

    public StorageResponse batchInsert(List<Map<String, Object>> dataList, String table) {
        // åˆ†æ‰¹å¤„ç†ï¼Œé¿å…å†…å­˜æº¢å‡º
        int batchSize = 1000;
        List<List<Map<String, Object>>> batches = Lists.partition(dataList, batchSize);

        return batches.parallelStream()
            .map(batch -> processBatch(batch, table))
            .reduce(StorageResponse.empty(), StorageResponse::merge);
    }

    private StorageResponse processBatch(List<Map<String, Object>> batch, String table) {
        // ä½¿ç”¨ jdbcTemplate.batchUpdate æ‰¹é‡æ’å…¥
        String sql = buildBatchInsertSQL(table, batch.get(0).keySet());

        List<Object[]> batchArgs = batch.stream()
            .map(data -> data.values().toArray())
            .collect(Collectors.toList());

        int[] results = jdbcTemplate.batchUpdate(sql, batchArgs);
        return StorageResponse.success(results.length);
    }
}
```

## ğŸ” ç›‘æ§å’Œå‘Šè­¦

### å…³é”®æŒ‡æ ‡ç›‘æ§

```java
/**
 * å­˜å‚¨æœåŠ¡æ€§èƒ½ç›‘æ§
 */
@Component
public class StorageMetrics {

    private final MeterRegistry registry;

    // è¯·æ±‚è®¡æ•°å’Œè€—æ—¶
    @Timed("storage.request.time")
    @Counted("storage.request.count")
    public StorageResponse processRequest(StorageRequest request) {
        // å¤„ç†è¯·æ±‚
    }

    // æ•°æ®åº“è¿æ¥æ± ç›‘æ§
    @Scheduled(fixedRate = 60000)
    public void collectPoolMetrics() {
        registry.gauge("db.connections.active", getActiveConnections());
        registry.gauge("db.connections.idle", getIdleConnections());
        registry.gauge("db.connections.total", getTotalConnections());
    }

    // ç¼“å­˜å‘½ä¸­ç‡ç›‘æ§
    @EventListener
    public void onCacheEvent(CacheEvent event) {
        if (event.getType() == CacheEvent.Type.HIT) {
            registry.counter("cache.hit").increment();
        } else if (event.getType() == CacheEvent.Type.MISS) {
            registry.counter("cache.miss").increment();
        }
    }
}
```

### å‘Šè­¦è§„åˆ™

- **å“åº”æ—¶é—´å‘Šè­¦**: å¹³å‡å“åº”æ—¶é—´ > 2ç§’
- **é”™è¯¯ç‡å‘Šè­¦**: 5åˆ†é’Ÿå†…é”™è¯¯ç‡ > 5%
- **è¿æ¥æ± å‘Šè­¦**: æ´»è·ƒè¿æ¥æ•° > 90%
- **ç¼“å­˜å‘Šè­¦**: ç¼“å­˜å‘½ä¸­ç‡ < 70%

## ğŸ› ï¸ æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

#### 1. è¿æ¥è¶…æ—¶
```bash
# æ£€æŸ¥æ•°æ®åº“è¿æ¥çŠ¶æ€
curl http://storage-service:8081/actuator/health

# æŸ¥çœ‹è¿æ¥æ± çŠ¶æ€
curl http://storage-service:8081/actuator/metrics/hikaricp.connections.active
```

#### 2. æŸ¥è¯¢æ€§èƒ½é—®é¢˜
```bash
# æ£€æŸ¥æ…¢æŸ¥è¯¢æ—¥å¿—
curl http://storage-service:8081/api/v1/storage/health/slow-queries

# æŸ¥çœ‹ç¼“å­˜å‘½ä¸­ç‡
curl http://storage-service:8081/actuator/metrics/cache.gets
```

#### 3. æ•°æ®éš”ç¦»é—®é¢˜
```bash
# æ£€æŸ¥ familyId æ˜¯å¦æ­£ç¡®ä¼ é€’
curl -H "X-Family-ID: family123" http://storage-service:8081/api/v1/storage/debug/family-check
```

## ğŸ“‹ æœ€ä½³å®è·µ

### 1. æ€§èƒ½ä¼˜åŒ–å»ºè®®
- ä¼˜å…ˆä½¿ç”¨æ‰¹é‡æ“ä½œ
- åˆç†è®¾ç½®ç¼“å­˜è¿‡æœŸæ—¶é—´
- ä½¿ç”¨è¿æ¥æ± ï¼Œé¿å…é¢‘ç¹åˆ›å»ºè¿æ¥
- å®šæœŸåˆ†ææ…¢æŸ¥è¯¢å¹¶ä¼˜åŒ–

### 2. å®‰å…¨å»ºè®®
- æ‰€æœ‰è¯·æ±‚å¿…é¡»åŒ…å« familyId
- æ•æ„Ÿæ•°æ®å…¥åº“å‰åŠ å¯†
- å®šæœŸè½®æ¢ Service-Key
- ç›‘æ§å¼‚å¸¸è®¿é—®æ¨¡å¼

### 3. å¼€å‘å»ºè®®
- ä½¿ç”¨ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶
- è®°å½•è¯¦ç»†çš„å®¡è®¡æ—¥å¿—
- å®ç°ä¼˜é›…çš„é™çº§ç­–ç•¥
- ç¼–å†™å…¨é¢çš„å•å…ƒæµ‹è¯•

---

**ç»Ÿä¸€æ•°æ®å­˜å‚¨ç³»ç»Ÿ** - ä¸ºHavenButlerå¹³å°æä¾›å®‰å…¨ã€é«˜æ•ˆçš„æ•°æ®è®¿é—®æœåŠ¡ ğŸ—„ï¸