# Storage Service éƒ¨ç½²æŒ‡å—

## ğŸš€ éƒ¨ç½²æ¦‚è¿°

Storage Service æ”¯æŒå¤šç§éƒ¨ç½²æ–¹å¼ï¼ŒåŒ…æ‹¬å¼€å‘ç¯å¢ƒçš„æœ¬åœ°éƒ¨ç½²ã€æµ‹è¯•ç¯å¢ƒçš„Dockeréƒ¨ç½²å’Œç”Ÿäº§ç¯å¢ƒçš„Kuberneteséƒ¨ç½²ã€‚

## ğŸ“‹ éƒ¨ç½²å‰å‡†å¤‡

### ç³»ç»Ÿè¦æ±‚
- **Java**: JDK 17 æˆ–æ›´é«˜ç‰ˆæœ¬
- **å†…å­˜**: æœ€ä½ 2GBï¼Œæ¨è 4GB
- **ç£ç›˜**: æœ€ä½ 10GB å¯ç”¨ç©ºé—´
- **ç½‘ç»œ**: éœ€è¦è®¿é—®Nacosã€PostgreSQLã€MongoDBã€Redisã€MinIO

### ä¾èµ–æœåŠ¡æ£€æŸ¥æ¸…å•
- [ ] Nacos é…ç½®ä¸­å¿ƒ (ç«¯å£: 8848)
- [ ] PostgreSQL æ•°æ®åº“ (ç«¯å£: 5432)
- [ ] MongoDB æ–‡æ¡£æ•°æ®åº“ (ç«¯å£: 27017)
- [ ] Redis ç¼“å­˜æœåŠ¡ (ç«¯å£: 6379)
- [ ] MinIO å¯¹è±¡å­˜å‚¨ (ç«¯å£: 9000)

## ğŸ› ï¸ å¼€å‘ç¯å¢ƒéƒ¨ç½²

### 1. æœ¬åœ°å¼€å‘ç¯å¢ƒ

#### 1.1 ä½¿ç”¨Docker Composeå¯åŠ¨ä¾èµ–æœåŠ¡
```bash
# 1. å¯åŠ¨åŸºç¡€æœåŠ¡å®¹å™¨
cd /path/to/HavenButler
docker-compose up -d postgres mongodb redis minio nacos

# 2. ç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨ï¼ˆçº¦30ç§’ï¼‰
sleep 30

# 3. éªŒè¯æœåŠ¡çŠ¶æ€
docker ps | grep -E "(postgres|mongodb|redis|minio|nacos)"
```

#### 1.2 é…ç½®Nacos
```bash
# 1. è®¿é—®Nacosæ§åˆ¶å°
open http://localhost:8848/nacos
# é»˜è®¤ç”¨æˆ·å/å¯†ç : nacos/nacos

# 2. åˆ›å»ºé…ç½®
# é…ç½®æ–‡ä»¶å·²å‡†å¤‡åœ¨ infrastructure/admin/nacos-configs/ ç›®å½•ä¸‹
```

#### 1.3 å¯åŠ¨Storage Service
```bash
# 1. è¿›å…¥æœåŠ¡ç›®å½•
cd services/storage-service

# 2. ç¼–è¯‘é¡¹ç›®
mvn clean compile

# 3. å¯åŠ¨æœåŠ¡
mvn spring-boot:run

# æˆ–è€…ä½¿ç”¨IDEå¯åŠ¨ StorageServiceApplication.main()
```

#### 1.4 éªŒè¯éƒ¨ç½²
```bash
# 1. å¥åº·æ£€æŸ¥
curl http://localhost:8081/actuator/health

# 2. æœåŠ¡æ³¨å†Œæ£€æŸ¥
curl "http://localhost:8848/nacos/v1/ns/instances?serviceName=storage-service"

# 3. APIæ¥å£æµ‹è¯•
curl http://localhost:8081/api/v1/storage/health
```

### 2. ç¯å¢ƒå˜é‡é…ç½®

#### å¼€å‘ç¯å¢ƒå˜é‡æ–‡ä»¶ (.env.dev)
```bash
# åŸºç¡€é…ç½®
NACOS_ADDR=localhost:8848
NACOS_NAMESPACE=dev
NACOS_GROUP=DEV_GROUP
ENVIRONMENT=dev
PROFILE=dev

# æ•°æ®åº“é…ç½®
POSTGRESQL_HOST=localhost
POSTGRESQL_PORT=5432
POSTGRESQL_DB=smarthome_dev
POSTGRESQL_USER=postgres
POSTGRESQL_PASSWORD=dev_password

MONGODB_HOST=localhost
MONGODB_PORT=27017
MONGODB_DB=smarthome_dev
MONGODB_USER=admin
MONGODB_PASSWORD=dev_password

REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=dev_password
REDIS_DATABASE=0

# MinIOé…ç½®
MINIO_ENDPOINT=http://localhost:9000
MINIO_ACCESS_KEY=minioadmin
MINIO_SECRET_KEY=minioadmin
MINIO_BUCKET=smarthome-dev

# å®‰å…¨é…ç½®
JWT_SECRET=havenbutler-jwt-secret-dev-key-2024
AES_KEY=havenbutler-aes-256-secret-dev-key

# æœåŠ¡é…ç½®
SERVER_PORT=8081
LOG_LEVEL=DEBUG
```

#### åŠ è½½ç¯å¢ƒå˜é‡
```bash
# æ–¹æ³•1: ä½¿ç”¨sourceå‘½ä»¤
source .env.dev

# æ–¹æ³•2: ä½¿ç”¨export
export $(cat .env.dev | xargs)

# æ–¹æ³•3: åœ¨IDEä¸­é…ç½®Environment Variables
```

## ğŸ³ Dockeréƒ¨ç½²

### 1. æ„å»ºDockeré•œåƒ

#### 1.1 Dockerfileï¼ˆå·²å­˜åœ¨ï¼‰
```dockerfile
FROM openjdk:17-jdk-slim

VOLUME /tmp

# å¤åˆ¶JARæ–‡ä»¶
COPY target/storage-service-1.0.0.jar app.jar

# è®¾ç½®æ—¶åŒº
ENV TZ=Asia/Shanghai

# æš´éœ²ç«¯å£
EXPOSE 8081

# å¯åŠ¨å‘½ä»¤
ENTRYPOINT ["java", "-jar", "/app.jar"]
```

#### 1.2 æ„å»ºå‘½ä»¤
```bash
# 1. ç¼–è¯‘æ‰“åŒ…
mvn clean package -DskipTests

# 2. æ„å»ºDockeré•œåƒ
docker build -t smart-home/storage-service:v1.0.0 .

# 3. éªŒè¯é•œåƒ
docker images | grep storage-service
```

### 2. Docker Composeéƒ¨ç½²

#### 2.1 å®Œæ•´çš„docker-compose.yml
```yaml
version: '3.8'

services:
  # å­˜å‚¨æœåŠ¡
  storage-service:
    image: smart-home/storage-service:v1.0.0
    container_name: storage-service
    restart: always
    ports:
      - "8081:8081"
    environment:
      - NACOS_ADDR=nacos:8848
      - NACOS_NAMESPACE=docker
      - NACOS_GROUP=DOCKER_GROUP
      - POSTGRESQL_HOST=postgres
      - MONGODB_HOST=mongodb
      - REDIS_HOST=redis
      - MINIO_ENDPOINT=http://minio:9000
    depends_on:
      - postgres
      - mongodb
      - redis
      - minio
      - nacos
    networks:
      - smart-home-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # PostgreSQLæ•°æ®åº“
  postgres:
    image: postgres:15
    container_name: postgres
    restart: always
    environment:
      POSTGRES_DB: smarthome
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - smart-home-network

  # MongoDBæ–‡æ¡£æ•°æ®åº“
  mongodb:
    image: mongo:7
    container_name: mongodb
    restart: always
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: password
      MONGO_INITDB_DATABASE: smarthome
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    networks:
      - smart-home-network

  # Redisç¼“å­˜
  redis:
    image: redis:7-alpine
    container_name: redis
    restart: always
    command: redis-server --requirepass password
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - smart-home-network

  # MinIOå¯¹è±¡å­˜å‚¨
  minio:
    image: minio/minio:latest
    container_name: minio
    restart: always
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data
    networks:
      - smart-home-network

  # Nacosé…ç½®ä¸­å¿ƒ
  nacos:
    image: nacos/nacos-server:v2.3.0
    container_name: nacos
    restart: always
    environment:
      MODE: standalone
      SPRING_DATASOURCE_PLATFORM: mysql
    ports:
      - "8848:8848"
    networks:
      - smart-home-network

networks:
  smart-home-network:
    driver: bridge

volumes:
  postgres_data:
  mongodb_data:
  redis_data:
  minio_data:
```

#### 2.2 éƒ¨ç½²å‘½ä»¤
```bash
# 1. åˆ›å»ºç½‘ç»œï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
docker network create smart-home-network

# 2. å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d

# 3. æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# 4. æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f storage-service

# 5. åœæ­¢æœåŠ¡
docker-compose down

# 6. æ¸…ç†æ•°æ®ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
docker-compose down -v
```

### 3. å•ç‹¬Dockerå®¹å™¨éƒ¨ç½²

#### 3.1 ç½‘ç»œå‡†å¤‡
```bash
# åˆ›å»ºä¸“ç”¨ç½‘ç»œ
docker network create smart-home-network
```

#### 3.2 ä¾æ¬¡å¯åŠ¨æœåŠ¡
```bash
# 1. PostgreSQL
docker run -d \
  --name postgres \
  --network smart-home-network \
  -p 5432:5432 \
  -e POSTGRES_DB=smarthome \
  -e POSTGRES_USER=postgres \
  -e POSTGRES_PASSWORD=password \
  -v postgres_data:/var/lib/postgresql/data \
  postgres:15

# 2. MongoDB
docker run -d \
  --name mongodb \
  --network smart-home-network \
  -p 27017:27017 \
  -e MONGO_INITDB_ROOT_USERNAME=admin \
  -e MONGO_INITDB_ROOT_PASSWORD=password \
  -v mongodb_data:/data/db \
  mongo:7

# 3. Redis
docker run -d \
  --name redis \
  --network smart-home-network \
  -p 6379:6379 \
  -v redis_data:/data \
  redis:7-alpine redis-server --requirepass password

# 4. MinIO
docker run -d \
  --name minio \
  --network smart-home-network \
  -p 9000:9000 -p 9001:9001 \
  -e MINIO_ROOT_USER=minioadmin \
  -e MINIO_ROOT_PASSWORD=minioadmin \
  -v minio_data:/data \
  minio/minio:latest server /data --console-address ":9001"

# 5. Nacos
docker run -d \
  --name nacos \
  --network smart-home-network \
  -p 8848:8848 \
  -e MODE=standalone \
  nacos/nacos-server:v2.3.0

# 6. Storage Service
docker run -d \
  --name storage-service \
  --network smart-home-network \
  -p 8081:8081 \
  -e NACOS_ADDR=nacos:8848 \
  -e POSTGRESQL_HOST=postgres \
  -e MONGODB_HOST=mongodb \
  -e REDIS_HOST=redis \
  -e MINIO_ENDPOINT=http://minio:9000 \
  smart-home/storage-service:v1.0.0
```

## â˜¸ï¸ Kuberneteséƒ¨ç½²

### 1. é…ç½®æ–‡ä»¶å‡†å¤‡

#### 1.1 ConfigMapé…ç½®
```yaml
# k8s/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: storage-service-config
  namespace: smart-home
data:
  NACOS_ADDR: "nacos-service:8848"
  NACOS_NAMESPACE: "k8s"
  NACOS_GROUP: "K8S_GROUP"
  ENVIRONMENT: "k8s"
---
apiVersion: v1
kind: Secret
metadata:
  name: storage-service-secret
  namespace: smart-home
type: Opaque
stringData:
  POSTGRESQL_PASSWORD: "secure_password"
  MONGODB_PASSWORD: "secure_password"
  REDIS_PASSWORD: "secure_password"
  JWT_SECRET: "secure_jwt_secret_key"
  AES_KEY: "secure_aes_key"
```

#### 1.2 Deploymenté…ç½®
```yaml
# k8s/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: storage-service
  namespace: smart-home
  labels:
    app: storage-service
    version: v1.0.0
spec:
  replicas: 3
  selector:
    matchLabels:
      app: storage-service
  template:
    metadata:
      labels:
        app: storage-service
        version: v1.0.0
    spec:
      containers:
      - name: storage-service
        image: smart-home/storage-service:v1.0.0
        ports:
        - containerPort: 8081
          name: http
        env:
        - name: NACOS_ADDR
          valueFrom:
            configMapKeyRef:
              name: storage-service-config
              key: NACOS_ADDR
        - name: POSTGRESQL_HOST
          value: "postgres-service"
        - name: POSTGRESQL_PASSWORD
          valueFrom:
            secretKeyRef:
              name: storage-service-secret
              key: POSTGRESQL_PASSWORD
        - name: MONGODB_HOST
          value: "mongodb-service"
        - name: REDIS_HOST
          value: "redis-service"
        - name: MINIO_ENDPOINT
          value: "http://minio-service:9000"
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "1000m"
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: 8081
          initialDelaySeconds: 30
          periodSeconds: 10
        livenessProbe:
          httpGet:
            path: /actuator/health/liveness
            port: 8081
          initialDelaySeconds: 60
          periodSeconds: 20
        lifecycle:
          preStop:
            exec:
              command: ["sleep", "10"]
```

#### 1.3 Serviceé…ç½®
```yaml
# k8s/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: storage-service
  namespace: smart-home
  labels:
    app: storage-service
spec:
  selector:
    app: storage-service
  ports:
  - port: 8081
    targetPort: 8081
    name: http
  type: ClusterIP
---
# HPAé…ç½®
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: storage-service-hpa
  namespace: smart-home
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: storage-service
  minReplicas: 2
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
```

### 2. éƒ¨ç½²æ­¥éª¤

#### 2.1 åˆ›å»ºå‘½åç©ºé—´
```bash
kubectl create namespace smart-home
```

#### 2.2 éƒ¨ç½²ä¾èµ–æœåŠ¡
```bash
# éƒ¨ç½²æ•°æ®åº“ç­‰ä¾èµ–æœåŠ¡ï¼ˆå‡è®¾å·²æœ‰ï¼‰
kubectl apply -f k8s/dependencies/
```

#### 2.3 éƒ¨ç½²Storage Service
```bash
# 1. åº”ç”¨é…ç½®
kubectl apply -f k8s/configmap.yaml

# 2. éƒ¨ç½²åº”ç”¨
kubectl apply -f k8s/deployment.yaml

# 3. åˆ›å»ºæœåŠ¡
kubectl apply -f k8s/service.yaml

# 4. éªŒè¯éƒ¨ç½²
kubectl get pods -n smart-home -l app=storage-service
kubectl get svc -n smart-home storage-service
```

#### 2.4 éªŒè¯éƒ¨ç½²
```bash
# æ£€æŸ¥PodçŠ¶æ€
kubectl get pods -n smart-home

# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
kubectl logs -f deployment/storage-service -n smart-home

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
kubectl port-forward svc/storage-service 8081:8081 -n smart-home
curl http://localhost:8081/actuator/health
```

### 3. æ»šåŠ¨æ›´æ–°

#### 3.1 æ›´æ–°é•œåƒ
```bash
# 1. æ„å»ºæ–°ç‰ˆæœ¬é•œåƒ
docker build -t smart-home/storage-service:v1.1.0 .

# 2. æ¨é€åˆ°é•œåƒä»“åº“
docker push smart-home/storage-service:v1.1.0

# 3. æ›´æ–°Deployment
kubectl set image deployment/storage-service \
  storage-service=smart-home/storage-service:v1.1.0 \
  -n smart-home

# 4. æŸ¥çœ‹æ›´æ–°çŠ¶æ€
kubectl rollout status deployment/storage-service -n smart-home
```

#### 3.2 å›æ»šç‰ˆæœ¬
```bash
# æŸ¥çœ‹å†å²ç‰ˆæœ¬
kubectl rollout history deployment/storage-service -n smart-home

# å›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬
kubectl rollout undo deployment/storage-service -n smart-home

# å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬
kubectl rollout undo deployment/storage-service --to-revision=2 -n smart-home
```

## ğŸ” éƒ¨ç½²éªŒè¯

### 1. åŠŸèƒ½éªŒè¯è„šæœ¬
```bash
#!/bin/bash
# deployment-verification.sh

SERVICE_URL="http://localhost:8081"
if [ "$1" ]; then
  SERVICE_URL="$1"
fi

echo "=== Storage Service Deployment Verification ==="
echo "Target URL: $SERVICE_URL"

# 1. å¥åº·æ£€æŸ¥
echo "1. Health Check..."
curl -f "$SERVICE_URL/actuator/health" > /dev/null
if [ $? -eq 0 ]; then
  echo "âœ… Health check passed"
else
  echo "âŒ Health check failed"
  exit 1
fi

# 2. APIæ¥å£æµ‹è¯•
echo "2. API Interface Test..."
curl -f "$SERVICE_URL/api/v1/storage/health" > /dev/null
if [ $? -eq 0 ]; then
  echo "âœ… API interface accessible"
else
  echo "âŒ API interface failed"
  exit 1
fi

# 3. æ•°æ®åº“è¿æ¥æµ‹è¯•
echo "3. Database Connection Test..."
curl -f "$SERVICE_URL/api/v1/storage/health/databases" > /dev/null
if [ $? -eq 0 ]; then
  echo "âœ… Database connections OK"
else
  echo "âŒ Database connection failed"
fi

# 4. å­˜å‚¨åŠŸèƒ½æµ‹è¯•
echo "4. Storage Functionality Test..."
RESPONSE=$(curl -s "$SERVICE_URL/api/v1/storage/files/storage-status")
if [ $? -eq 0 ]; then
  echo "âœ… Storage functionality accessible"
  echo "Storage Status: $RESPONSE"
else
  echo "âŒ Storage functionality failed"
fi

echo "=== Verification Complete ==="
```

### 2. æ€§èƒ½åŸºå‡†æµ‹è¯•
```bash
#!/bin/bash
# performance-benchmark.sh

SERVICE_URL="http://localhost:8081"
CONCURRENT_USERS=10
TEST_DURATION=60

echo "=== Performance Benchmark Test ==="
echo "Service URL: $SERVICE_URL"
echo "Concurrent Users: $CONCURRENT_USERS"
echo "Test Duration: ${TEST_DURATION}s"

# ä½¿ç”¨Apache Benchè¿›è¡Œæ€§èƒ½æµ‹è¯•
ab -n 1000 -c $CONCURRENT_USERS -t $TEST_DURATION "$SERVICE_URL/api/v1/storage/health"

# ä½¿ç”¨curlè¿›è¡Œå“åº”æ—¶é—´æµ‹è¯•
for i in {1..10}; do
  TIME=$(curl -w "%{time_total}" -s -o /dev/null "$SERVICE_URL/actuator/health")
  echo "Request $i: ${TIME}s"
done
```

## ğŸ›¡ï¸ å®‰å…¨é…ç½®

### 1. ç½‘ç»œå®‰å…¨
```yaml
# NetworkPolicyç¤ºä¾‹
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: storage-service-netpol
  namespace: smart-home
spec:
  podSelector:
    matchLabels:
      app: storage-service
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: smart-home
    ports:
    - protocol: TCP
      port: 8081
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          name: smart-home
    ports:
    - protocol: TCP
      port: 5432  # PostgreSQL
    - protocol: TCP
      port: 27017 # MongoDB
    - protocol: TCP
      port: 6379  # Redis
    - protocol: TCP
      port: 9000  # MinIO
```

### 2. ç§˜é’¥ç®¡ç†
```bash
# ä½¿ç”¨å¤–éƒ¨ç§˜é’¥ç®¡ç†ç³»ç»Ÿ
kubectl create secret generic storage-service-secret \
  --from-literal=postgresql-password="$(vault kv get -field=password secret/postgresql)" \
  --from-literal=jwt-secret="$(vault kv get -field=secret secret/jwt)" \
  -n smart-home
```

## ğŸ“Š ç›‘æ§é…ç½®

### 1. Prometheusé…ç½®
```yaml
# prometheus-config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
    scrape_configs:
    - job_name: 'storage-service'
      kubernetes_sd_configs:
      - role: endpoints
        namespaces:
          names: ['smart-home']
      relabel_configs:
      - source_labels: [__meta_kubernetes_service_name]
        action: keep
        regex: storage-service
      - source_labels: [__meta_kubernetes_endpoint_port_name]
        action: keep
        regex: http
      metrics_path: '/actuator/prometheus'
```

### 2. Grafanaä»ªè¡¨æ¿é…ç½®
```json
{
  "dashboard": {
    "title": "Storage Service Dashboard",
    "panels": [
      {
        "title": "Request Rate",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(http_requests_total{job=\"storage-service\"}[5m])"
          }
        ]
      },
      {
        "title": "Response Time",
        "type": "graph",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{job=\"storage-service\"}[5m]))"
          }
        ]
      }
    ]
  }
}
```

## ğŸš¨ åº”æ€¥é¢„æ¡ˆ

### 1. æœåŠ¡ä¸å¯ç”¨åº”æ€¥æ–¹æ¡ˆ
```bash
#!/bin/bash
# emergency-response.sh

echo "=== Emergency Response Plan ==="

# 1. å¿«é€Ÿå¥åº·æ£€æŸ¥
echo "1. Performing health check..."
if ! curl -f http://localhost:8081/actuator/health > /dev/null 2>&1; then
  echo "âŒ Service is DOWN"

  # 2. é‡å¯æœåŠ¡
  echo "2. Restarting service..."
  if command -v kubectl > /dev/null; then
    kubectl rollout restart deployment/storage-service -n smart-home
  elif command -v docker-compose > /dev/null; then
    docker-compose restart storage-service
  else
    # systemd service restart
    sudo systemctl restart storage-service
  fi

  # 3. ç­‰å¾…æœåŠ¡æ¢å¤
  echo "3. Waiting for service recovery..."
  for i in {1..30}; do
    if curl -f http://localhost:8081/actuator/health > /dev/null 2>&1; then
      echo "âœ… Service recovered after ${i}0 seconds"
      break
    fi
    sleep 10
  done
else
  echo "âœ… Service is UP"
fi

echo "=== Emergency Response Complete ==="
```

### 2. æ•°æ®å¤‡ä»½åº”æ€¥æ–¹æ¡ˆ
```bash
#!/bin/bash
# emergency-backup.sh

BACKUP_DIR="/backup/$(date +%Y%m%d_%H%M%S)"
mkdir -p "$BACKUP_DIR"

echo "=== Emergency Backup Plan ==="
echo "Backup directory: $BACKUP_DIR"

# 1. PostgreSQLå¤‡ä»½
echo "1. Backing up PostgreSQL..."
pg_dump -h localhost -U postgres smarthome > "$BACKUP_DIR/postgresql.sql"

# 2. MongoDBå¤‡ä»½
echo "2. Backing up MongoDB..."
mongodump --host localhost --db smarthome --out "$BACKUP_DIR/mongodb/"

# 3. Rediså¤‡ä»½
echo "3. Backing up Redis..."
redis-cli --rdb "$BACKUP_DIR/redis.rdb"

# 4. MinIOæ•°æ®å¤‡ä»½
echo "4. Backing up MinIO..."
mc mirror minio/smarthome "$BACKUP_DIR/minio/"

echo "=== Emergency Backup Complete ==="
echo "Backup location: $BACKUP_DIR"
```

é€šè¿‡ä»¥ä¸Šéƒ¨ç½²æŒ‡å—ï¼Œä½ å¯ä»¥åœ¨ä¸åŒç¯å¢ƒä¸­æˆåŠŸéƒ¨ç½²Storage Serviceï¼Œå¹¶ç¡®ä¿å…¶ç¨³å®šè¿è¡Œã€‚è®°ä½åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è¦ç‰¹åˆ«æ³¨æ„å®‰å…¨é…ç½®å’Œç›‘æ§è®¾ç½®ã€‚