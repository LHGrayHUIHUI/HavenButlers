# Storage Service 部署指南

## 🚀 部署概述

Storage Service 支持多种部署方式，包括开发环境的本地部署、测试环境的Docker部署和生产环境的Kubernetes部署。

## 📋 部署前准备

### 系统要求
- **Java**: JDK 17 或更高版本
- **内存**: 最低 2GB，推荐 4GB
- **磁盘**: 最低 10GB 可用空间
- **网络**: 需要访问Nacos、PostgreSQL、MongoDB、Redis、MinIO

### 依赖服务检查清单
- [ ] Nacos 配置中心 (端口: 8848)
- [ ] PostgreSQL 数据库 (端口: 5432)
- [ ] MongoDB 文档数据库 (端口: 27017)
- [ ] Redis 缓存服务 (端口: 6379)
- [ ] MinIO 对象存储 (端口: 9000)

## 🛠️ 开发环境部署

### 1. 本地开发环境

#### 1.1 使用Docker Compose启动依赖服务
```bash
# 1. 启动基础服务容器
cd /path/to/HavenButler
docker-compose up -d postgres mongodb redis minio nacos

# 2. 等待服务完全启动（约30秒）
sleep 30

# 3. 验证服务状态
docker ps | grep -E "(postgres|mongodb|redis|minio|nacos)"
```

#### 1.2 配置Nacos
```bash
# 1. 访问Nacos控制台
open http://localhost:8848/nacos
# 默认用户名/密码: nacos/nacos

# 2. 创建配置
# 配置文件已准备在 infrastructure/admin/nacos-configs/ 目录下
```

#### 1.3 启动Storage Service
```bash
# 1. 进入服务目录
cd services/storage-service

# 2. 编译项目
mvn clean compile

# 3. 启动服务
mvn spring-boot:run

# 或者使用IDE启动 StorageServiceApplication.main()
```

#### 1.4 验证部署
```bash
# 1. 健康检查
curl http://localhost:8081/actuator/health

# 2. 服务注册检查
curl "http://localhost:8848/nacos/v1/ns/instances?serviceName=storage-service"

# 3. API接口测试
curl http://localhost:8081/api/v1/storage/health
```

### 2. 环境变量配置

#### 开发环境变量文件 (.env.dev)
```bash
# 基础配置
NACOS_ADDR=localhost:8848
NACOS_NAMESPACE=dev
NACOS_GROUP=DEV_GROUP
ENVIRONMENT=dev
PROFILE=dev

# 数据库配置
POSTGRESQL_HOST=localhost
POSTGRESQL_PORT=5432
POSTGRESQL_DB=smarthome_dev
POSTGRESQL_USER=postgres
POSTGRESQL_PASSWORD=dev_password

MONGODB_HOST=localhost
MONGODB_PORT=27017
MONGODB_DB=smarthome_dev
MONGODB_USER=admin
MONGODB_PASSWORD=dev_password

REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=dev_password
REDIS_DATABASE=0

# MinIO配置
MINIO_ENDPOINT=http://localhost:9000
MINIO_ACCESS_KEY=minioadmin
MINIO_SECRET_KEY=minioadmin
MINIO_BUCKET=smarthome-dev

# 安全配置
JWT_SECRET=havenbutler-jwt-secret-dev-key-2024
AES_KEY=havenbutler-aes-256-secret-dev-key

# 服务配置
SERVER_PORT=8081
LOG_LEVEL=DEBUG
```

#### 加载环境变量
```bash
# 方法1: 使用source命令
source .env.dev

# 方法2: 使用export
export $(cat .env.dev | xargs)

# 方法3: 在IDE中配置Environment Variables
```

## 🐳 Docker部署

### 1. 构建Docker镜像

#### 1.1 Dockerfile（已存在）
```dockerfile
FROM openjdk:17-jdk-slim

VOLUME /tmp

# 复制JAR文件
COPY target/storage-service-1.0.0.jar app.jar

# 设置时区
ENV TZ=Asia/Shanghai

# 暴露端口
EXPOSE 8081

# 启动命令
ENTRYPOINT ["java", "-jar", "/app.jar"]
```

#### 1.2 构建命令
```bash
# 1. 编译打包
mvn clean package -DskipTests

# 2. 构建Docker镜像
docker build -t smart-home/storage-service:v1.0.0 .

# 3. 验证镜像
docker images | grep storage-service
```

### 2. Docker Compose部署

#### 2.1 完整的docker-compose.yml
```yaml
version: '3.8'

services:
  # 存储服务
  storage-service:
    image: smart-home/storage-service:v1.0.0
    container_name: storage-service
    restart: always
    ports:
      - "8081:8081"
    environment:
      - NACOS_ADDR=nacos:8848
      - NACOS_NAMESPACE=docker
      - NACOS_GROUP=DOCKER_GROUP
      - POSTGRESQL_HOST=postgres
      - MONGODB_HOST=mongodb
      - REDIS_HOST=redis
      - MINIO_ENDPOINT=http://minio:9000
    depends_on:
      - postgres
      - mongodb
      - redis
      - minio
      - nacos
    networks:
      - smart-home-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # PostgreSQL数据库
  postgres:
    image: postgres:15
    container_name: postgres
    restart: always
    environment:
      POSTGRES_DB: smarthome
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - smart-home-network

  # MongoDB文档数据库
  mongodb:
    image: mongo:7
    container_name: mongodb
    restart: always
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: password
      MONGO_INITDB_DATABASE: smarthome
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    networks:
      - smart-home-network

  # Redis缓存
  redis:
    image: redis:7-alpine
    container_name: redis
    restart: always
    command: redis-server --requirepass password
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - smart-home-network

  # MinIO对象存储
  minio:
    image: minio/minio:latest
    container_name: minio
    restart: always
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data
    networks:
      - smart-home-network

  # Nacos配置中心
  nacos:
    image: nacos/nacos-server:v2.3.0
    container_name: nacos
    restart: always
    environment:
      MODE: standalone
      SPRING_DATASOURCE_PLATFORM: mysql
    ports:
      - "8848:8848"
    networks:
      - smart-home-network

networks:
  smart-home-network:
    driver: bridge

volumes:
  postgres_data:
  mongodb_data:
  redis_data:
  minio_data:
```

#### 2.2 部署命令
```bash
# 1. 创建网络（如果不存在）
docker network create smart-home-network

# 2. 启动所有服务
docker-compose up -d

# 3. 查看服务状态
docker-compose ps

# 4. 查看日志
docker-compose logs -f storage-service

# 5. 停止服务
docker-compose down

# 6. 清理数据（谨慎使用）
docker-compose down -v
```

### 3. 单独Docker容器部署

#### 3.1 网络准备
```bash
# 创建专用网络
docker network create smart-home-network
```

#### 3.2 依次启动服务
```bash
# 1. PostgreSQL
docker run -d \
  --name postgres \
  --network smart-home-network \
  -p 5432:5432 \
  -e POSTGRES_DB=smarthome \
  -e POSTGRES_USER=postgres \
  -e POSTGRES_PASSWORD=password \
  -v postgres_data:/var/lib/postgresql/data \
  postgres:15

# 2. MongoDB
docker run -d \
  --name mongodb \
  --network smart-home-network \
  -p 27017:27017 \
  -e MONGO_INITDB_ROOT_USERNAME=admin \
  -e MONGO_INITDB_ROOT_PASSWORD=password \
  -v mongodb_data:/data/db \
  mongo:7

# 3. Redis
docker run -d \
  --name redis \
  --network smart-home-network \
  -p 6379:6379 \
  -v redis_data:/data \
  redis:7-alpine redis-server --requirepass password

# 4. MinIO
docker run -d \
  --name minio \
  --network smart-home-network \
  -p 9000:9000 -p 9001:9001 \
  -e MINIO_ROOT_USER=minioadmin \
  -e MINIO_ROOT_PASSWORD=minioadmin \
  -v minio_data:/data \
  minio/minio:latest server /data --console-address ":9001"

# 5. Nacos
docker run -d \
  --name nacos \
  --network smart-home-network \
  -p 8848:8848 \
  -e MODE=standalone \
  nacos/nacos-server:v2.3.0

# 6. Storage Service
docker run -d \
  --name storage-service \
  --network smart-home-network \
  -p 8081:8081 \
  -e NACOS_ADDR=nacos:8848 \
  -e POSTGRESQL_HOST=postgres \
  -e MONGODB_HOST=mongodb \
  -e REDIS_HOST=redis \
  -e MINIO_ENDPOINT=http://minio:9000 \
  smart-home/storage-service:v1.0.0
```

## ☸️ Kubernetes部署

### 1. 配置文件准备

#### 1.1 ConfigMap配置
```yaml
# k8s/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: storage-service-config
  namespace: smart-home
data:
  NACOS_ADDR: "nacos-service:8848"
  NACOS_NAMESPACE: "k8s"
  NACOS_GROUP: "K8S_GROUP"
  ENVIRONMENT: "k8s"
---
apiVersion: v1
kind: Secret
metadata:
  name: storage-service-secret
  namespace: smart-home
type: Opaque
stringData:
  POSTGRESQL_PASSWORD: "secure_password"
  MONGODB_PASSWORD: "secure_password"
  REDIS_PASSWORD: "secure_password"
  JWT_SECRET: "secure_jwt_secret_key"
  AES_KEY: "secure_aes_key"
```

#### 1.2 Deployment配置
```yaml
# k8s/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: storage-service
  namespace: smart-home
  labels:
    app: storage-service
    version: v1.0.0
spec:
  replicas: 3
  selector:
    matchLabels:
      app: storage-service
  template:
    metadata:
      labels:
        app: storage-service
        version: v1.0.0
    spec:
      containers:
      - name: storage-service
        image: smart-home/storage-service:v1.0.0
        ports:
        - containerPort: 8081
          name: http
        env:
        - name: NACOS_ADDR
          valueFrom:
            configMapKeyRef:
              name: storage-service-config
              key: NACOS_ADDR
        - name: POSTGRESQL_HOST
          value: "postgres-service"
        - name: POSTGRESQL_PASSWORD
          valueFrom:
            secretKeyRef:
              name: storage-service-secret
              key: POSTGRESQL_PASSWORD
        - name: MONGODB_HOST
          value: "mongodb-service"
        - name: REDIS_HOST
          value: "redis-service"
        - name: MINIO_ENDPOINT
          value: "http://minio-service:9000"
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "1000m"
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: 8081
          initialDelaySeconds: 30
          periodSeconds: 10
        livenessProbe:
          httpGet:
            path: /actuator/health/liveness
            port: 8081
          initialDelaySeconds: 60
          periodSeconds: 20
        lifecycle:
          preStop:
            exec:
              command: ["sleep", "10"]
```

#### 1.3 Service配置
```yaml
# k8s/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: storage-service
  namespace: smart-home
  labels:
    app: storage-service
spec:
  selector:
    app: storage-service
  ports:
  - port: 8081
    targetPort: 8081
    name: http
  type: ClusterIP
---
# HPA配置
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: storage-service-hpa
  namespace: smart-home
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: storage-service
  minReplicas: 2
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
```

### 2. 部署步骤

#### 2.1 创建命名空间
```bash
kubectl create namespace smart-home
```

#### 2.2 部署依赖服务
```bash
# 部署数据库等依赖服务（假设已有）
kubectl apply -f k8s/dependencies/
```

#### 2.3 部署Storage Service
```bash
# 1. 应用配置
kubectl apply -f k8s/configmap.yaml

# 2. 部署应用
kubectl apply -f k8s/deployment.yaml

# 3. 创建服务
kubectl apply -f k8s/service.yaml

# 4. 验证部署
kubectl get pods -n smart-home -l app=storage-service
kubectl get svc -n smart-home storage-service
```

#### 2.4 验证部署
```bash
# 检查Pod状态
kubectl get pods -n smart-home

# 查看服务日志
kubectl logs -f deployment/storage-service -n smart-home

# 检查服务状态
kubectl port-forward svc/storage-service 8081:8081 -n smart-home
curl http://localhost:8081/actuator/health
```

### 3. 滚动更新

#### 3.1 更新镜像
```bash
# 1. 构建新版本镜像
docker build -t smart-home/storage-service:v1.1.0 .

# 2. 推送到镜像仓库
docker push smart-home/storage-service:v1.1.0

# 3. 更新Deployment
kubectl set image deployment/storage-service \
  storage-service=smart-home/storage-service:v1.1.0 \
  -n smart-home

# 4. 查看更新状态
kubectl rollout status deployment/storage-service -n smart-home
```

#### 3.2 回滚版本
```bash
# 查看历史版本
kubectl rollout history deployment/storage-service -n smart-home

# 回滚到上一版本
kubectl rollout undo deployment/storage-service -n smart-home

# 回滚到指定版本
kubectl rollout undo deployment/storage-service --to-revision=2 -n smart-home
```

## 🔍 部署验证

### 1. 功能验证脚本
```bash
#!/bin/bash
# deployment-verification.sh

SERVICE_URL="http://localhost:8081"
if [ "$1" ]; then
  SERVICE_URL="$1"
fi

echo "=== Storage Service Deployment Verification ==="
echo "Target URL: $SERVICE_URL"

# 1. 健康检查
echo "1. Health Check..."
curl -f "$SERVICE_URL/actuator/health" > /dev/null
if [ $? -eq 0 ]; then
  echo "✅ Health check passed"
else
  echo "❌ Health check failed"
  exit 1
fi

# 2. API接口测试
echo "2. API Interface Test..."
curl -f "$SERVICE_URL/api/v1/storage/health" > /dev/null
if [ $? -eq 0 ]; then
  echo "✅ API interface accessible"
else
  echo "❌ API interface failed"
  exit 1
fi

# 3. 数据库连接测试
echo "3. Database Connection Test..."
curl -f "$SERVICE_URL/api/v1/storage/health/databases" > /dev/null
if [ $? -eq 0 ]; then
  echo "✅ Database connections OK"
else
  echo "❌ Database connection failed"
fi

# 4. 存储功能测试
echo "4. Storage Functionality Test..."
RESPONSE=$(curl -s "$SERVICE_URL/api/v1/storage/files/storage-status")
if [ $? -eq 0 ]; then
  echo "✅ Storage functionality accessible"
  echo "Storage Status: $RESPONSE"
else
  echo "❌ Storage functionality failed"
fi

echo "=== Verification Complete ==="
```

### 2. 性能基准测试
```bash
#!/bin/bash
# performance-benchmark.sh

SERVICE_URL="http://localhost:8081"
CONCURRENT_USERS=10
TEST_DURATION=60

echo "=== Performance Benchmark Test ==="
echo "Service URL: $SERVICE_URL"
echo "Concurrent Users: $CONCURRENT_USERS"
echo "Test Duration: ${TEST_DURATION}s"

# 使用Apache Bench进行性能测试
ab -n 1000 -c $CONCURRENT_USERS -t $TEST_DURATION "$SERVICE_URL/api/v1/storage/health"

# 使用curl进行响应时间测试
for i in {1..10}; do
  TIME=$(curl -w "%{time_total}" -s -o /dev/null "$SERVICE_URL/actuator/health")
  echo "Request $i: ${TIME}s"
done
```

## 🛡️ 安全配置

### 1. 网络安全
```yaml
# NetworkPolicy示例
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: storage-service-netpol
  namespace: smart-home
spec:
  podSelector:
    matchLabels:
      app: storage-service
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: smart-home
    ports:
    - protocol: TCP
      port: 8081
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          name: smart-home
    ports:
    - protocol: TCP
      port: 5432  # PostgreSQL
    - protocol: TCP
      port: 27017 # MongoDB
    - protocol: TCP
      port: 6379  # Redis
    - protocol: TCP
      port: 9000  # MinIO
```

### 2. 秘钥管理
```bash
# 使用外部秘钥管理系统
kubectl create secret generic storage-service-secret \
  --from-literal=postgresql-password="$(vault kv get -field=password secret/postgresql)" \
  --from-literal=jwt-secret="$(vault kv get -field=secret secret/jwt)" \
  -n smart-home
```

## 📊 监控配置

### 1. Prometheus配置
```yaml
# prometheus-config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
    scrape_configs:
    - job_name: 'storage-service'
      kubernetes_sd_configs:
      - role: endpoints
        namespaces:
          names: ['smart-home']
      relabel_configs:
      - source_labels: [__meta_kubernetes_service_name]
        action: keep
        regex: storage-service
      - source_labels: [__meta_kubernetes_endpoint_port_name]
        action: keep
        regex: http
      metrics_path: '/actuator/prometheus'
```

### 2. Grafana仪表板配置
```json
{
  "dashboard": {
    "title": "Storage Service Dashboard",
    "panels": [
      {
        "title": "Request Rate",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(http_requests_total{job=\"storage-service\"}[5m])"
          }
        ]
      },
      {
        "title": "Response Time",
        "type": "graph",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{job=\"storage-service\"}[5m]))"
          }
        ]
      }
    ]
  }
}
```

## 🚨 应急预案

### 1. 服务不可用应急方案
```bash
#!/bin/bash
# emergency-response.sh

echo "=== Emergency Response Plan ==="

# 1. 快速健康检查
echo "1. Performing health check..."
if ! curl -f http://localhost:8081/actuator/health > /dev/null 2>&1; then
  echo "❌ Service is DOWN"

  # 2. 重启服务
  echo "2. Restarting service..."
  if command -v kubectl > /dev/null; then
    kubectl rollout restart deployment/storage-service -n smart-home
  elif command -v docker-compose > /dev/null; then
    docker-compose restart storage-service
  else
    # systemd service restart
    sudo systemctl restart storage-service
  fi

  # 3. 等待服务恢复
  echo "3. Waiting for service recovery..."
  for i in {1..30}; do
    if curl -f http://localhost:8081/actuator/health > /dev/null 2>&1; then
      echo "✅ Service recovered after ${i}0 seconds"
      break
    fi
    sleep 10
  done
else
  echo "✅ Service is UP"
fi

echo "=== Emergency Response Complete ==="
```

### 2. 数据备份应急方案
```bash
#!/bin/bash
# emergency-backup.sh

BACKUP_DIR="/backup/$(date +%Y%m%d_%H%M%S)"
mkdir -p "$BACKUP_DIR"

echo "=== Emergency Backup Plan ==="
echo "Backup directory: $BACKUP_DIR"

# 1. PostgreSQL备份
echo "1. Backing up PostgreSQL..."
pg_dump -h localhost -U postgres smarthome > "$BACKUP_DIR/postgresql.sql"

# 2. MongoDB备份
echo "2. Backing up MongoDB..."
mongodump --host localhost --db smarthome --out "$BACKUP_DIR/mongodb/"

# 3. Redis备份
echo "3. Backing up Redis..."
redis-cli --rdb "$BACKUP_DIR/redis.rdb"

# 4. MinIO数据备份
echo "4. Backing up MinIO..."
mc mirror minio/smarthome "$BACKUP_DIR/minio/"

echo "=== Emergency Backup Complete ==="
echo "Backup location: $BACKUP_DIR"
```

通过以上部署指南，你可以在不同环境中成功部署Storage Service，并确保其稳定运行。记住在生产环境中要特别注意安全配置和监控设置。