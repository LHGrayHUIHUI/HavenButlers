# Storage Service 故障排查指南

## 🚨 常见故障及解决方案

### 1. 服务启动问题

#### 1.1 服务无法启动
**现象**: 服务启动失败，抛出异常
```bash
# 错误日志示例
Failed to configure a DataSource: 'url' attribute is not specified
```

**排查步骤**:
1. **检查配置文件**
   ```bash
   # 检查application.yml是否正确配置
   cat src/main/resources/application.yml

   # 检查Nacos配置是否可访问
   curl http://localhost:8848/nacos/v1/cs/configs?dataId=storage-service.yml&group=DEFAULT_GROUP
   ```

2. **验证环境变量**
   ```bash
   # 检查必要的环境变量
   echo $NACOS_ADDR
   echo $POSTGRESQL_HOST
   echo $MONGODB_HOST
   echo $REDIS_HOST
   ```

3. **验证依赖服务**
   ```bash
   # 检查依赖服务状态
   docker ps | grep -E "(postgres|mongodb|redis|minio|nacos)"

   # 测试数据库连接
   telnet localhost 5432  # PostgreSQL
   telnet localhost 27017 # MongoDB
   telnet localhost 6379  # Redis
   telnet localhost 9000  # MinIO
   ```

**解决方案**:
- 确保Nacos服务正常运行
- 检查数据库连接配置是否正确
- 验证网络连通性

#### 1.2 Nacos连接失败
**现象**: 无法连接到Nacos配置中心
```bash
# 错误日志
ConnectException: Connection refused: localhost/127.0.0.1:8848
```

**解决方案**:
```bash
# 1. 启动Nacos服务
cd nacos/bin
./startup.sh -m standalone

# 2. 检查Nacos服务状态
curl http://localhost:8848/nacos

# 3. 检查网络连接
netstat -an | grep 8848
```

### 2. 数据库连接问题

#### 2.1 PostgreSQL连接失败
**现象**: 无法连接到PostgreSQL数据库
```bash
# 错误日志
Connection refused. Check that the hostname and port are correct
```

**排查步骤**:
```bash
# 1. 检查PostgreSQL服务状态
docker ps | grep postgres
docker logs postgres-container

# 2. 测试数据库连接
psql -h localhost -p 5432 -U postgres -d smarthome

# 3. 检查配置
# 在Nacos中检查PostgreSQL配置
```

**解决方案**:
```bash
# 1. 启动PostgreSQL容器
docker start postgres

# 2. 重置密码（如果需要）
docker exec -it postgres-container psql -U postgres
ALTER USER postgres PASSWORD 'new_password';

# 3. 更新Nacos配置
# 在Nacos控制台更新数据库配置
```

#### 2.2 MongoDB连接失败
**现象**: MongoDB连接认证失败
```bash
# 错误日志
Authentication failed for user 'admin'
```

**解决方案**:
```bash
# 1. 检查MongoDB容器状态
docker logs mongodb-container

# 2. 重新创建用户
docker exec -it mongodb-container mongo
use admin
db.createUser({
  user: "admin",
  pwd: "password",
  roles: ["root"]
})

# 3. 更新连接URI
# mongodb://admin:password@localhost:27017/smarthome?authSource=admin
```

#### 2.3 Redis连接失败
**现象**: Redis连接超时
```bash
# 错误日志
Could not get a resource from the pool
```

**解决方案**:
```bash
# 1. 检查Redis服务
docker logs redis-container
redis-cli ping

# 2. 检查密码配置
redis-cli -a password ping

# 3. 重启Redis服务
docker restart redis-container
```

### 3. MinIO文件存储问题

#### 3.1 MinIO连接失败
**现象**: 无法连接到MinIO服务
```bash
# 错误日志
MinIO客户端不可用
```

**排查步骤**:
```bash
# 1. 检查MinIO服务状态
docker ps | grep minio
curl http://localhost:9000/minio/health/live

# 2. 检查访问密钥
curl -u minioadmin:minioadmin http://localhost:9000

# 3. 检查存储桶
mc ls minio/smarthome
```

**解决方案**:
```bash
# 1. 启动MinIO服务
docker start minio

# 2. 配置客户端
mc config host add minio http://localhost:9000 minioadmin minioadmin

# 3. 创建存储桶
mc mb minio/smarthome

# 4. 设置存储桶策略
mc policy set public minio/smarthome
```

#### 3.2 文件上传失败
**现象**: 文件上传到MinIO失败
```bash
# 错误日志
文件上传失败: Access Denied
```

**解决方案**:
```bash
# 1. 检查存储桶权限
mc policy list minio/smarthome

# 2. 设置正确权限
mc policy set upload minio/smarthome

# 3. 检查存储空间
mc admin info minio
```

### 4. API接口问题

#### 4.1 接口返回404
**现象**: 调用API接口返回404错误

**排查步骤**:
```bash
# 1. 检查服务状态
curl http://localhost:8081/actuator/health

# 2. 检查路由配置
curl http://localhost:8081/actuator/mappings

# 3. 查看服务日志
docker logs storage-service-container
```

**解决方案**:
- 确认请求路径正确：`/api/v1/storage/*`
- 检查Controller类是否正确注册
- 验证Spring Boot配置

#### 4.2 认证失败
**现象**: API调用返回401认证失败
```json
{
  "code": 1002,
  "message": "认证失败",
  "data": null
}
```

**解决方案**:
```bash
# 1. 检查Service-Key配置
# 在Nacos中查看service-keys配置

# 2. 验证JWT Token
# 确保Token格式正确且未过期

# 3. 检查Family-ID
# 确保请求头包含正确的X-Family-ID
```

### 5. 性能问题

#### 5.1 接口响应慢
**现象**: API接口响应时间超过2秒

**排查步骤**:
```bash
# 1. 查看应用性能指标
curl http://localhost:8081/actuator/metrics/http.server.requests

# 2. 检查数据库连接池
curl http://localhost:8081/actuator/metrics/hikaricp.connections

# 3. 查看JVM内存使用
curl http://localhost:8081/actuator/metrics/jvm.memory.used
```

**优化方案**:
```yaml
# 1. 调整数据库连接池
spring:
  datasource:
    hikari:
      maximum-pool-size: 50  # 增加连接数
      minimum-idle: 10

# 2. 启用查询缓存
spring:
  jpa:
    properties:
      hibernate:
        cache.use_second_level_cache: true

# 3. 调整JVM参数
-Xms2g -Xmx4g -XX:+UseG1GC
```

#### 5.2 内存泄漏
**现象**: 服务运行一段时间后内存持续增长

**排查步骤**:
```bash
# 1. 生成堆转储
jcmd <pid> GC.run_finalization
jcmd <pid> VM.gc
jcmd <pid> GC.heap_dump /tmp/heap.hprof

# 2. 分析内存使用
curl http://localhost:8081/actuator/metrics/jvm.memory.max

# 3. 检查连接泄漏
curl http://localhost:8081/actuator/metrics/hikaricp.connections.idle
```

### 6. 数据一致性问题

#### 6.1 数据丢失
**现象**: 部分数据在数据库中找不到

**排查步骤**:
1. **检查数据隔离**
   ```sql
   -- 确认familyId过滤条件
   SELECT * FROM users WHERE family_id = 'family123';
   ```

2. **查看事务日志**
   ```bash
   # 检查应用日志中的事务操作
   grep "TRANSACTION" application.log
   ```

3. **验证数据一致性**
   ```bash
   # 比较不同数据源的数据
   # PostgreSQL vs MongoDB 数据对比
   ```

**解决方案**:
- 检查事务配置是否正确
- 确认数据隔离逻辑
- 实施数据修复脚本

### 7. 监控和告警

#### 7.1 设置关键指标监控
```yaml
# Prometheus配置示例
- job_name: 'storage-service'
  static_configs:
    - targets: ['storage-service:8081']
  metrics_path: '/actuator/prometheus'
```

#### 7.2 告警规则配置
```yaml
# Alertmanager规则
groups:
  - name: storage-service
    rules:
      - alert: StorageServiceDown
        expr: up{job="storage-service"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Storage Service is down"

      - alert: HighResponseTime
        expr: http_request_duration_seconds{job="storage-service"} > 2
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "High response time detected"
```

### 8. 日志分析

#### 8.1 关键日志位置
```bash
# Docker容器日志
docker logs storage-service-container

# 应用日志文件
tail -f /var/log/storage-service/application.log

# 错误日志
grep -i error /var/log/storage-service/application.log
```

#### 8.2 日志级别调整
```yaml
# 临时调整日志级别（通过Actuator）
POST /actuator/loggers/com.haven.storage
{
  "configuredLevel": "DEBUG"
}
```

### 9. 应急处理流程

#### 9.1 服务完全不可用
1. **立即响应**（< 5分钟）
   ```bash
   # 1. 检查服务状态
   kubectl get pods | grep storage-service

   # 2. 重启服务
   kubectl rollout restart deployment/storage-service

   # 3. 检查依赖服务
   kubectl get pods | grep -E "(postgres|mongodb|redis|minio)"
   ```

2. **快速恢复**（< 15分钟）
   ```bash
   # 1. 回滚到上一个稳定版本
   kubectl rollout undo deployment/storage-service

   # 2. 检查配置是否被意外修改
   kubectl describe configmap storage-config

   # 3. 查看详细错误日志
   kubectl logs -f deployment/storage-service
   ```

3. **根因分析**（< 1小时）
   - 分析错误日志和监控数据
   - 检查最近的代码变更
   - 验证配置变更记录
   - 制定长期修复方案

#### 9.2 数据损坏应急恢复
1. **立即隔离**
   ```bash
   # 停止写入操作
   kubectl scale deployment/storage-service --replicas=0
   ```

2. **数据备份验证**
   ```bash
   # 检查最新备份
   pg_dump -h backup-host -p 5432 -U postgres smarthome > recovery.sql
   ```

3. **数据恢复**
   ```bash
   # 从备份恢复
   psql -h localhost -p 5432 -U postgres -d smarthome < recovery.sql
   ```

### 10. 预防性维护

#### 10.1 定期检查清单
- [ ] 数据库连接池状态
- [ ] 磁盘空间使用率
- [ ] 应用内存使用情况
- [ ] 日志文件大小
- [ ] 备份完整性验证
- [ ] 安全补丁更新

#### 10.2 自动化监控脚本
```bash
#!/bin/bash
# health-check.sh - 存储服务健康检查脚本

echo "=== Storage Service Health Check ==="
echo "Date: $(date)"

# 1. 服务状态检查
curl -f http://localhost:8081/actuator/health > /dev/null
if [ $? -eq 0 ]; then
    echo "✅ Service is UP"
else
    echo "❌ Service is DOWN"
    exit 1
fi

# 2. 数据库连接检查
curl -f http://localhost:8081/api/v1/storage/health/databases > /dev/null
if [ $? -eq 0 ]; then
    echo "✅ Database connections OK"
else
    echo "❌ Database connection issues"
fi

# 3. 存储空间检查
DISK_USAGE=$(df -h /data | awk 'NR==2 {print $5}' | sed 's/%//')
if [ $DISK_USAGE -gt 80 ]; then
    echo "⚠️  Disk usage high: ${DISK_USAGE}%"
else
    echo "✅ Disk usage normal: ${DISK_USAGE}%"
fi

echo "=== Health Check Complete ==="
```

### 11. 联系支持

当遇到无法解决的问题时：

1. **收集信息**
   - 错误日志（最近24小时）
   - 服务配置（脱敏后）
   - 环境信息（Java版本、OS版本等）
   - 问题复现步骤

2. **创建支持工单**
   - 问题描述
   - 影响范围
   - 紧急程度
   - 已尝试的解决方案

3. **临时解决方案**
   - 启用降级模式
   - 切换备用服务
   - 数据备份恢复