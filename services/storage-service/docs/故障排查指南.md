# Storage Service æ•…éšœæ’æŸ¥æŒ‡å—

## ğŸš¨ å¸¸è§æ•…éšœåŠè§£å†³æ–¹æ¡ˆ

### 1. æœåŠ¡å¯åŠ¨é—®é¢˜

#### 1.1 æœåŠ¡æ— æ³•å¯åŠ¨
**ç°è±¡**: æœåŠ¡å¯åŠ¨å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸
```bash
# é”™è¯¯æ—¥å¿—ç¤ºä¾‹
Failed to configure a DataSource: 'url' attribute is not specified
```

**æ’æŸ¥æ­¥éª¤**:
1. **æ£€æŸ¥é…ç½®æ–‡ä»¶**
   ```bash
   # æ£€æŸ¥application.ymlæ˜¯å¦æ­£ç¡®é…ç½®
   cat src/main/resources/application.yml

   # æ£€æŸ¥Nacosé…ç½®æ˜¯å¦å¯è®¿é—®
   curl http://localhost:8848/nacos/v1/cs/configs?dataId=storage-service.yml&group=DEFAULT_GROUP
   ```

2. **éªŒè¯ç¯å¢ƒå˜é‡**
   ```bash
   # æ£€æŸ¥å¿…è¦çš„ç¯å¢ƒå˜é‡
   echo $NACOS_ADDR
   echo $POSTGRESQL_HOST
   echo $MONGODB_HOST
   echo $REDIS_HOST
   ```

3. **éªŒè¯ä¾èµ–æœåŠ¡**
   ```bash
   # æ£€æŸ¥ä¾èµ–æœåŠ¡çŠ¶æ€
   docker ps | grep -E "(postgres|mongodb|redis|minio|nacos)"

   # æµ‹è¯•æ•°æ®åº“è¿æ¥
   telnet localhost 5432  # PostgreSQL
   telnet localhost 27017 # MongoDB
   telnet localhost 6379  # Redis
   telnet localhost 9000  # MinIO
   ```

**è§£å†³æ–¹æ¡ˆ**:
- ç¡®ä¿NacosæœåŠ¡æ­£å¸¸è¿è¡Œ
- æ£€æŸ¥æ•°æ®åº“è¿æ¥é…ç½®æ˜¯å¦æ­£ç¡®
- éªŒè¯ç½‘ç»œè¿é€šæ€§

#### 1.2 Nacosè¿æ¥å¤±è´¥
**ç°è±¡**: æ— æ³•è¿æ¥åˆ°Nacosé…ç½®ä¸­å¿ƒ
```bash
# é”™è¯¯æ—¥å¿—
ConnectException: Connection refused: localhost/127.0.0.1:8848
```

**è§£å†³æ–¹æ¡ˆ**:
```bash
# 1. å¯åŠ¨NacosæœåŠ¡
cd nacos/bin
./startup.sh -m standalone

# 2. æ£€æŸ¥NacosæœåŠ¡çŠ¶æ€
curl http://localhost:8848/nacos

# 3. æ£€æŸ¥ç½‘ç»œè¿æ¥
netstat -an | grep 8848
```

### 2. æ•°æ®åº“è¿æ¥é—®é¢˜

#### 2.1 PostgreSQLè¿æ¥å¤±è´¥
**ç°è±¡**: æ— æ³•è¿æ¥åˆ°PostgreSQLæ•°æ®åº“
```bash
# é”™è¯¯æ—¥å¿—
Connection refused. Check that the hostname and port are correct
```

**æ’æŸ¥æ­¥éª¤**:
```bash
# 1. æ£€æŸ¥PostgreSQLæœåŠ¡çŠ¶æ€
docker ps | grep postgres
docker logs postgres-container

# 2. æµ‹è¯•æ•°æ®åº“è¿æ¥
psql -h localhost -p 5432 -U postgres -d smarthome

# 3. æ£€æŸ¥é…ç½®
# åœ¨Nacosä¸­æ£€æŸ¥PostgreSQLé…ç½®
```

**è§£å†³æ–¹æ¡ˆ**:
```bash
# 1. å¯åŠ¨PostgreSQLå®¹å™¨
docker start postgres

# 2. é‡ç½®å¯†ç ï¼ˆå¦‚æœéœ€è¦ï¼‰
docker exec -it postgres-container psql -U postgres
ALTER USER postgres PASSWORD 'new_password';

# 3. æ›´æ–°Nacosé…ç½®
# åœ¨Nacosæ§åˆ¶å°æ›´æ–°æ•°æ®åº“é…ç½®
```

#### 2.2 MongoDBè¿æ¥å¤±è´¥
**ç°è±¡**: MongoDBè¿æ¥è®¤è¯å¤±è´¥
```bash
# é”™è¯¯æ—¥å¿—
Authentication failed for user 'admin'
```

**è§£å†³æ–¹æ¡ˆ**:
```bash
# 1. æ£€æŸ¥MongoDBå®¹å™¨çŠ¶æ€
docker logs mongodb-container

# 2. é‡æ–°åˆ›å»ºç”¨æˆ·
docker exec -it mongodb-container mongo
use admin
db.createUser({
  user: "admin",
  pwd: "password",
  roles: ["root"]
})

# 3. æ›´æ–°è¿æ¥URI
# mongodb://admin:password@localhost:27017/smarthome?authSource=admin
```

#### 2.3 Redisè¿æ¥å¤±è´¥
**ç°è±¡**: Redisè¿æ¥è¶…æ—¶
```bash
# é”™è¯¯æ—¥å¿—
Could not get a resource from the pool
```

**è§£å†³æ–¹æ¡ˆ**:
```bash
# 1. æ£€æŸ¥RedisæœåŠ¡
docker logs redis-container
redis-cli ping

# 2. æ£€æŸ¥å¯†ç é…ç½®
redis-cli -a password ping

# 3. é‡å¯RedisæœåŠ¡
docker restart redis-container
```

### 3. MinIOæ–‡ä»¶å­˜å‚¨é—®é¢˜

#### 3.1 MinIOè¿æ¥å¤±è´¥
**ç°è±¡**: æ— æ³•è¿æ¥åˆ°MinIOæœåŠ¡
```bash
# é”™è¯¯æ—¥å¿—
MinIOå®¢æˆ·ç«¯ä¸å¯ç”¨
```

**æ’æŸ¥æ­¥éª¤**:
```bash
# 1. æ£€æŸ¥MinIOæœåŠ¡çŠ¶æ€
docker ps | grep minio
curl http://localhost:9000/minio/health/live

# 2. æ£€æŸ¥è®¿é—®å¯†é’¥
curl -u minioadmin:minioadmin http://localhost:9000

# 3. æ£€æŸ¥å­˜å‚¨æ¡¶
mc ls minio/smarthome
```

**è§£å†³æ–¹æ¡ˆ**:
```bash
# 1. å¯åŠ¨MinIOæœåŠ¡
docker start minio

# 2. é…ç½®å®¢æˆ·ç«¯
mc config host add minio http://localhost:9000 minioadmin minioadmin

# 3. åˆ›å»ºå­˜å‚¨æ¡¶
mc mb minio/smarthome

# 4. è®¾ç½®å­˜å‚¨æ¡¶ç­–ç•¥
mc policy set public minio/smarthome
```

#### 3.2 æ–‡ä»¶ä¸Šä¼ å¤±è´¥
**ç°è±¡**: æ–‡ä»¶ä¸Šä¼ åˆ°MinIOå¤±è´¥
```bash
# é”™è¯¯æ—¥å¿—
æ–‡ä»¶ä¸Šä¼ å¤±è´¥: Access Denied
```

**è§£å†³æ–¹æ¡ˆ**:
```bash
# 1. æ£€æŸ¥å­˜å‚¨æ¡¶æƒé™
mc policy list minio/smarthome

# 2. è®¾ç½®æ­£ç¡®æƒé™
mc policy set upload minio/smarthome

# 3. æ£€æŸ¥å­˜å‚¨ç©ºé—´
mc admin info minio
```

### 4. APIæ¥å£é—®é¢˜

#### 4.1 æ¥å£è¿”å›404
**ç°è±¡**: è°ƒç”¨APIæ¥å£è¿”å›404é”™è¯¯

**æ’æŸ¥æ­¥éª¤**:
```bash
# 1. æ£€æŸ¥æœåŠ¡çŠ¶æ€
curl http://localhost:8081/actuator/health

# 2. æ£€æŸ¥è·¯ç”±é…ç½®
curl http://localhost:8081/actuator/mappings

# 3. æŸ¥çœ‹æœåŠ¡æ—¥å¿—
docker logs storage-service-container
```

**è§£å†³æ–¹æ¡ˆ**:
- ç¡®è®¤è¯·æ±‚è·¯å¾„æ­£ç¡®ï¼š`/api/v1/storage/*`
- æ£€æŸ¥Controllerç±»æ˜¯å¦æ­£ç¡®æ³¨å†Œ
- éªŒè¯Spring Booté…ç½®

#### 4.2 è®¤è¯å¤±è´¥
**ç°è±¡**: APIè°ƒç”¨è¿”å›401è®¤è¯å¤±è´¥
```json
{
  "code": 1002,
  "message": "è®¤è¯å¤±è´¥",
  "data": null
}
```

**è§£å†³æ–¹æ¡ˆ**:
```bash
# 1. æ£€æŸ¥Service-Keyé…ç½®
# åœ¨Nacosä¸­æŸ¥çœ‹service-keysé…ç½®

# 2. éªŒè¯JWT Token
# ç¡®ä¿Tokenæ ¼å¼æ­£ç¡®ä¸”æœªè¿‡æœŸ

# 3. æ£€æŸ¥Family-ID
# ç¡®ä¿è¯·æ±‚å¤´åŒ…å«æ­£ç¡®çš„X-Family-ID
```

### 5. æ€§èƒ½é—®é¢˜

#### 5.1 æ¥å£å“åº”æ…¢
**ç°è±¡**: APIæ¥å£å“åº”æ—¶é—´è¶…è¿‡2ç§’

**æ’æŸ¥æ­¥éª¤**:
```bash
# 1. æŸ¥çœ‹åº”ç”¨æ€§èƒ½æŒ‡æ ‡
curl http://localhost:8081/actuator/metrics/http.server.requests

# 2. æ£€æŸ¥æ•°æ®åº“è¿æ¥æ± 
curl http://localhost:8081/actuator/metrics/hikaricp.connections

# 3. æŸ¥çœ‹JVMå†…å­˜ä½¿ç”¨
curl http://localhost:8081/actuator/metrics/jvm.memory.used
```

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```yaml
# 1. è°ƒæ•´æ•°æ®åº“è¿æ¥æ± 
spring:
  datasource:
    hikari:
      maximum-pool-size: 50  # å¢åŠ è¿æ¥æ•°
      minimum-idle: 10

# 2. å¯ç”¨æŸ¥è¯¢ç¼“å­˜
spring:
  jpa:
    properties:
      hibernate:
        cache.use_second_level_cache: true

# 3. è°ƒæ•´JVMå‚æ•°
-Xms2g -Xmx4g -XX:+UseG1GC
```

#### 5.2 å†…å­˜æ³„æ¼
**ç°è±¡**: æœåŠ¡è¿è¡Œä¸€æ®µæ—¶é—´åå†…å­˜æŒç»­å¢é•¿

**æ’æŸ¥æ­¥éª¤**:
```bash
# 1. ç”Ÿæˆå †è½¬å‚¨
jcmd <pid> GC.run_finalization
jcmd <pid> VM.gc
jcmd <pid> GC.heap_dump /tmp/heap.hprof

# 2. åˆ†æå†…å­˜ä½¿ç”¨
curl http://localhost:8081/actuator/metrics/jvm.memory.max

# 3. æ£€æŸ¥è¿æ¥æ³„æ¼
curl http://localhost:8081/actuator/metrics/hikaricp.connections.idle
```

### 6. æ•°æ®ä¸€è‡´æ€§é—®é¢˜

#### 6.1 æ•°æ®ä¸¢å¤±
**ç°è±¡**: éƒ¨åˆ†æ•°æ®åœ¨æ•°æ®åº“ä¸­æ‰¾ä¸åˆ°

**æ’æŸ¥æ­¥éª¤**:
1. **æ£€æŸ¥æ•°æ®éš”ç¦»**
   ```sql
   -- ç¡®è®¤familyIdè¿‡æ»¤æ¡ä»¶
   SELECT * FROM users WHERE family_id = 'family123';
   ```

2. **æŸ¥çœ‹äº‹åŠ¡æ—¥å¿—**
   ```bash
   # æ£€æŸ¥åº”ç”¨æ—¥å¿—ä¸­çš„äº‹åŠ¡æ“ä½œ
   grep "TRANSACTION" application.log
   ```

3. **éªŒè¯æ•°æ®ä¸€è‡´æ€§**
   ```bash
   # æ¯”è¾ƒä¸åŒæ•°æ®æºçš„æ•°æ®
   # PostgreSQL vs MongoDB æ•°æ®å¯¹æ¯”
   ```

**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥äº‹åŠ¡é…ç½®æ˜¯å¦æ­£ç¡®
- ç¡®è®¤æ•°æ®éš”ç¦»é€»è¾‘
- å®æ–½æ•°æ®ä¿®å¤è„šæœ¬

### 7. ç›‘æ§å’Œå‘Šè­¦

#### 7.1 è®¾ç½®å…³é”®æŒ‡æ ‡ç›‘æ§
```yaml
# Prometheusé…ç½®ç¤ºä¾‹
- job_name: 'storage-service'
  static_configs:
    - targets: ['storage-service:8081']
  metrics_path: '/actuator/prometheus'
```

#### 7.2 å‘Šè­¦è§„åˆ™é…ç½®
```yaml
# Alertmanagerè§„åˆ™
groups:
  - name: storage-service
    rules:
      - alert: StorageServiceDown
        expr: up{job="storage-service"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Storage Service is down"

      - alert: HighResponseTime
        expr: http_request_duration_seconds{job="storage-service"} > 2
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "High response time detected"
```

### 8. æ—¥å¿—åˆ†æ

#### 8.1 å…³é”®æ—¥å¿—ä½ç½®
```bash
# Dockerå®¹å™¨æ—¥å¿—
docker logs storage-service-container

# åº”ç”¨æ—¥å¿—æ–‡ä»¶
tail -f /var/log/storage-service/application.log

# é”™è¯¯æ—¥å¿—
grep -i error /var/log/storage-service/application.log
```

#### 8.2 æ—¥å¿—çº§åˆ«è°ƒæ•´
```yaml
# ä¸´æ—¶è°ƒæ•´æ—¥å¿—çº§åˆ«ï¼ˆé€šè¿‡Actuatorï¼‰
POST /actuator/loggers/com.haven.storage
{
  "configuredLevel": "DEBUG"
}
```

### 9. åº”æ€¥å¤„ç†æµç¨‹

#### 9.1 æœåŠ¡å®Œå…¨ä¸å¯ç”¨
1. **ç«‹å³å“åº”**ï¼ˆ< 5åˆ†é’Ÿï¼‰
   ```bash
   # 1. æ£€æŸ¥æœåŠ¡çŠ¶æ€
   kubectl get pods | grep storage-service

   # 2. é‡å¯æœåŠ¡
   kubectl rollout restart deployment/storage-service

   # 3. æ£€æŸ¥ä¾èµ–æœåŠ¡
   kubectl get pods | grep -E "(postgres|mongodb|redis|minio)"
   ```

2. **å¿«é€Ÿæ¢å¤**ï¼ˆ< 15åˆ†é’Ÿï¼‰
   ```bash
   # 1. å›æ»šåˆ°ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬
   kubectl rollout undo deployment/storage-service

   # 2. æ£€æŸ¥é…ç½®æ˜¯å¦è¢«æ„å¤–ä¿®æ”¹
   kubectl describe configmap storage-config

   # 3. æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—
   kubectl logs -f deployment/storage-service
   ```

3. **æ ¹å› åˆ†æ**ï¼ˆ< 1å°æ—¶ï¼‰
   - åˆ†æé”™è¯¯æ—¥å¿—å’Œç›‘æ§æ•°æ®
   - æ£€æŸ¥æœ€è¿‘çš„ä»£ç å˜æ›´
   - éªŒè¯é…ç½®å˜æ›´è®°å½•
   - åˆ¶å®šé•¿æœŸä¿®å¤æ–¹æ¡ˆ

#### 9.2 æ•°æ®æŸååº”æ€¥æ¢å¤
1. **ç«‹å³éš”ç¦»**
   ```bash
   # åœæ­¢å†™å…¥æ“ä½œ
   kubectl scale deployment/storage-service --replicas=0
   ```

2. **æ•°æ®å¤‡ä»½éªŒè¯**
   ```bash
   # æ£€æŸ¥æœ€æ–°å¤‡ä»½
   pg_dump -h backup-host -p 5432 -U postgres smarthome > recovery.sql
   ```

3. **æ•°æ®æ¢å¤**
   ```bash
   # ä»å¤‡ä»½æ¢å¤
   psql -h localhost -p 5432 -U postgres -d smarthome < recovery.sql
   ```

### 10. é¢„é˜²æ€§ç»´æŠ¤

#### 10.1 å®šæœŸæ£€æŸ¥æ¸…å•
- [ ] æ•°æ®åº“è¿æ¥æ± çŠ¶æ€
- [ ] ç£ç›˜ç©ºé—´ä½¿ç”¨ç‡
- [ ] åº”ç”¨å†…å­˜ä½¿ç”¨æƒ…å†µ
- [ ] æ—¥å¿—æ–‡ä»¶å¤§å°
- [ ] å¤‡ä»½å®Œæ•´æ€§éªŒè¯
- [ ] å®‰å…¨è¡¥ä¸æ›´æ–°

#### 10.2 è‡ªåŠ¨åŒ–ç›‘æ§è„šæœ¬
```bash
#!/bin/bash
# health-check.sh - å­˜å‚¨æœåŠ¡å¥åº·æ£€æŸ¥è„šæœ¬

echo "=== Storage Service Health Check ==="
echo "Date: $(date)"

# 1. æœåŠ¡çŠ¶æ€æ£€æŸ¥
curl -f http://localhost:8081/actuator/health > /dev/null
if [ $? -eq 0 ]; then
    echo "âœ… Service is UP"
else
    echo "âŒ Service is DOWN"
    exit 1
fi

# 2. æ•°æ®åº“è¿æ¥æ£€æŸ¥
curl -f http://localhost:8081/api/v1/storage/health/databases > /dev/null
if [ $? -eq 0 ]; then
    echo "âœ… Database connections OK"
else
    echo "âŒ Database connection issues"
fi

# 3. å­˜å‚¨ç©ºé—´æ£€æŸ¥
DISK_USAGE=$(df -h /data | awk 'NR==2 {print $5}' | sed 's/%//')
if [ $DISK_USAGE -gt 80 ]; then
    echo "âš ï¸  Disk usage high: ${DISK_USAGE}%"
else
    echo "âœ… Disk usage normal: ${DISK_USAGE}%"
fi

echo "=== Health Check Complete ==="
```

### 11. è”ç³»æ”¯æŒ

å½“é‡åˆ°æ— æ³•è§£å†³çš„é—®é¢˜æ—¶ï¼š

1. **æ”¶é›†ä¿¡æ¯**
   - é”™è¯¯æ—¥å¿—ï¼ˆæœ€è¿‘24å°æ—¶ï¼‰
   - æœåŠ¡é…ç½®ï¼ˆè„±æ•åï¼‰
   - ç¯å¢ƒä¿¡æ¯ï¼ˆJavaç‰ˆæœ¬ã€OSç‰ˆæœ¬ç­‰ï¼‰
   - é—®é¢˜å¤ç°æ­¥éª¤

2. **åˆ›å»ºæ”¯æŒå·¥å•**
   - é—®é¢˜æè¿°
   - å½±å“èŒƒå›´
   - ç´§æ€¥ç¨‹åº¦
   - å·²å°è¯•çš„è§£å†³æ–¹æ¡ˆ

3. **ä¸´æ—¶è§£å†³æ–¹æ¡ˆ**
   - å¯ç”¨é™çº§æ¨¡å¼
   - åˆ‡æ¢å¤‡ç”¨æœåŠ¡
   - æ•°æ®å¤‡ä»½æ¢å¤