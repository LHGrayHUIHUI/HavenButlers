# 日志系统说明（base-model）

本文档梳理 base-model 的日志与链路追踪机制，覆盖入站请求、方法级日志、出站 HTTP 与消息发送、统一异常与响应封装及相关配置。

## 组件总览
- 入站拦截：`src/main/java/com/haven/base/interceptor/TraceIdInterceptor.java`
  - 读取/生成 `X-Trace-ID`，写入 `MDC(traceId)` 与响应头；打印“请求开始/结束”日志。
- 方法级日志：`src/main/java/com/haven/base/aspect/TraceLogAspect.java`
  - 环绕 `@TraceLog`，记录参数（可忽略索引）、结果（可截断）、耗时、异常。
- 统一异常：`src/main/java/com/haven/base/common/exception/GlobalExceptionHandler.java`
  - 分类捕获业务/系统/认证/校验等异常，按级别输出日志，并统一返回 `ResponseWrapper`。
- 响应包装：`src/main/java/com/haven/base/common/response/ResponseWrapper.java`
  - 从 `MDC` 读取 `traceId`，补齐 `timestamp`，标准化输出。
- 出站 HTTP：`src/main/java/com/haven/base/client/ServiceClient.java`
  - 自动透传 `X-Trace-ID`，记录请求/响应摘要，异常统一为 `SystemException(EXTERNAL_SERVICE_ERROR)`。
- 消息发送：`src/main/java/com/haven/base/messaging/DefaultMessageProducer.java`
  - 发送时写入 `traceId` 到消息属性，记录发送/批量/延时日志。
- 日志格式：`src/main/resources/application-base.yml`（包含 `[%X{traceId}]` 的 pattern）。

## 流程图（端到端）
```mermaid
graph TD
  A[HTTP 请求] --> B[TraceIdInterceptor]
  B -->|MDC-traceId, 开始日志| C[Controller]
  C --> D{@TraceLog 方法}
  D -->|环绕前| E[TraceLogAspect-开始]
  E --> F[Service/Repository 业务]
  F -->|出站| G[ServiceClient\n加Header: X-Trace-ID]
  F -->|发送事件| H[DefaultMessageProducer\nproperties.traceId]
  F --> I[返回结果]
  I -->|环绕后| J[TraceLogAspect-成功/异常]
  J --> K{异常?}
  K -- 否 --> L[ResponseWrapper\n追加traceId,timestamp]
  K -- 是 --> M[GlobalExceptionHandler\n统一日志+统一响应]
  L --> N[返回响应]
  M --> N
  N --> O[TraceIdInterceptor\n结束日志+清理MDC]
```

## 入站请求日志
- 生成或复用 `X-Trace-ID` 并放入 `MDC`，同步回写响应头。
- 打印“开始/结束”日志（方法、URI、状态码、客户端 IP）。
- 位置：`src/main/java/com/haven/base/interceptor/TraceIdInterceptor.java`。

## 方法级业务日志（@TraceLog）
- 记录要素：模块/操作、参数（可忽略 `ignoreParamIndexes`）、结果（500 字符截断）、耗时。
- 异常路径：捕获后输出错误日志，保留 `traceId` 关联再抛出。
- 位置：`src/main/java/com/haven/base/aspect/TraceLogAspect.java`。

## 出站 HTTP 日志与链路
- `ServiceClient` 自动添加 `X-Trace-ID` 请求头；按 `DEBUG` 级打印请求体摘要、按 `INFO` 级打印状态与耗时。
- 异常统一封装为 `SystemException(EXTERNAL_SERVICE_ERROR)`，便于上层一致处理。
- 位置：`src/main/java/com/haven/base/client/ServiceClient.java`。

## 消息日志与链路
- `DefaultMessageProducer` 写入 `traceId` 到消息属性（`MessageProperties.TRACE_ID`），记录发送结果；异步/延时亦保留关联。
- 消费侧建议在处理前 `TraceIdUtil.setTraceId(...)` 以贯通链路。
- 位置：`src/main/java/com/haven/base/messaging/DefaultMessageProducer.java`。

## 统一异常与响应
- `GlobalExceptionHandler` 将不同异常映射到 HTTP 状态与业务码，写日志并返回 `ResponseWrapper` 标准结构。
- `ResponseWrapper`/`PagedResponseWrapper` 统一携带 `code/message/data/traceId/timestamp`。
- 位置：
  - `src/main/java/com/haven/base/common/exception/GlobalExceptionHandler.java`
  - `src/main/java/com/haven/base/common/response/ResponseWrapper.java`

## 配置与级别
- 基础配置：`src/main/resources/application-base.yml`
  - console/file pattern 含 `[%X{traceId}]`，`com.haven` 建议 `DEBUG`，`org.springframework` `INFO`。
- 建议：生产环境控制参数/结果日志体量；敏感字段做脱敏；出站/入站统一摘要字段（method, uri, status, costMs, traceId）。

## 快速校验
1. 发送任意请求（可自带 `X-Trace-ID`），确认日志中含相同 `traceId` 且响应头回写。
2. 为方法加 `@TraceLog`，观察开始/成功/异常日志三段齐全且耗时准确。
3. 调用 `ServiceClient` 指向一个可控服务，观察请求/响应日志与链路 ID 贯通。
4. 发送一条消息，检查发送日志与 `properties.traceId`。

## 已知可优化
- 结构化日志：可集成 `logstash-logback-encoder` 输出 JSON；或统一 `StructuredArguments` 键值。
- `ServiceClient` 超时与重试：建议增加连接/读取超时与简单重试配置。
- 脱敏策略：按字段名或注解（如 `@Encrypt(sensitive=true)`）自动掩码。
- 自动装配：Spring Boot 3 建议使用 `AutoConfiguration.imports` 注册。

